<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê³µì§€ì‚¬í•­</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
  :root{
    --purple-bg:#ffffff;
    --purple-dk:#ffffff;
    --btn-bg:#FDC512;
    --btn-bg-hov:#D9A90F; 
    --border-light:#e9e9e9;      /* ğŸ†• ì•„ì£¼ ì˜…ì€ íšŒìƒ‰ */
    --text-main:#111;
    --text-sub:#5f5f5f;
  }
  *{box-sizing:border-box;font-family:'Noto Sans KR',sans-serif;margin:0;}
  body{background:#fff;min-height:100vh;display:flex;flex-direction:column;}

  /* â”€â”€â”€â”€â”€â”€ 1) í—¤ë” â”€â”€â”€â”€â”€â”€ */
  .page-header{
    min-width:980px;padding:28px 40px 16px;
    display:flex;align-items:center;justify-content:space-between;
    position:relative;
  }
  .header-titles h1{font-size:1.55rem;font-weight:900;color:var(--text-main);}
  .sub-date{margin-top:4px;font-size:.95rem;font-weight:700;color:var(--text-sub);}

  .header-actions{display:flex;align-items:center;gap:16px;} /* ë²„íŠ¼ ê°„ê²© â†‘ */

  /* 1-a  ë²„íŠ¼ë“¤ */
  .action-btn{
    padding:8px 22px;border-radius:9999px;
    background:var(--btn-bg);color:#111;font-weight:700;
    font-size:.97rem;display:inline-flex;align-items:center;gap:8px;
    transition:.15s;text-decoration:none;
  }
  .action-btn i{font-size:.9rem;}
  .action-btn:hover{background:var(--btn-bg-hov);}
  /* ë²„íŠ¼ë¼ë¦¬ ì‚´ì§ ë„ìš°ê¸° */
  .action-btn+ .action-btn{margin-left:0;} 

  /* 1-b  í”„ë¡œí•„ */
  .user-wrapper{position:relative;}
  .user-box{
    display:flex;align-items:center;gap:14px;cursor:pointer; /* gap â†‘ */
  }
  .avatar{
    width:42px;height:42px;border-radius:50%;
    object-fit:cover;background:#ddd;
  }
  .user-name{
    font-size:1.05rem;font-weight:700;color:var(--text-main);
    white-space:nowrap;
  }
  .user-box i{font-size:.8rem;color:#888;transition:.2s;}

  .dropdown{
    position:absolute;right:0;top:calc(100% + 6px);
    min-width:160px;background:#fff;border:1px solid #eee;border-radius:10px;
    box-shadow:0 4px 14px rgba(0,0,0,.06);padding:8px 0;display:none;z-index:20;
  }
  .dropdown a{
    display:block;padding:10px 18px;font-size:.92rem;color:#333;
    text-decoration:none;white-space:nowrap;transition:.13s;
  }
  .dropdown a:hover{background:#f8f8f8;}

  .page-header::after{
  content:'';
  position:absolute;
  left:50%;                          /* ê°€ìš´ë° ê¸°ì¤€ */
  bottom:0;                          /* í—¤ë” ë§¨ ì•„ë˜ */
  transform:translateX(-50%);        /* ì •í™•í•œ ì¤‘ì•™ ì •ë ¬ */

  width:97%;                         /* â† ê¸¸ì´(=ì–‘ìª½ ì—¬ë°±) ì¡°ì ˆ í¬ì¸íŠ¸ */
  height:1px;                        /* ì„  êµµê¸° */
  background:var(--border-light);    /* ì„  ìƒ‰ìƒ */
  }


    .notice-title{display:none;}

    .notice-date{width:120px;text-align:right;color:#868686;font-size:.95em;margin-left:10px;}
    .notice-arrow{width:24px;text-align:right;color:#b5b5b5;font-size:1.5em;margin-left:16px;}

    .notice-item.active {color:#4b4b4b;font-weight:900;}
    .notice-item.active{background:#e8fbe9;}
    .notice-detail-row{border-bottom:2px solid #4e4e4e;}

    @keyframes fadeIn{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}

    .pagination{display:flex;justify-content:center;align-items:center;gap:10px;padding:20px 0 28px;color:#bbb;font-size:1rem;user-select:none;}
    .pagination span{cursor:pointer;padding:2px 7px;transition:background .12s;}
    .pagination span:hover:not(.active){background:#f5f7fa;}
    .pagination .active{color:#111;font-weight:700;border-bottom:2px solid #696969;padding:2px 7px;border-radius:5px 5px 0 0;}

    /* í”Œë¡œíŒ…(+) ë²„íŠ¼ */
    #fab-add{display:none;position:fixed;left:54px;bottom:44px;width:58px;height:58px;border-radius:50%;background:#484848;color:#fff;font-size:2.4rem;box-shadow:0 8px 24px #05060644;border:none;cursor:pointer;z-index:999;transition:background .13s,box-shadow .13s;display:flex;align-items:center;justify-content:center;}
    #fab-add:hover{background:#000000;box-shadow:0 8px 32px #72727233;}

    /* ê³µì§€ ë“±ë¡ ëª¨ë‹¬ */
    #notice-modal-bg{display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,.18);z-index:2000;justify-content:center;align-items:center;}
    #notice-modal-bg.show{display:flex;}
    #notice-modal-box{background:#fff;border-radius:18px;box-shadow:0 6px 24px #23805822;padding:36px 28px 28px;min-width:340px;width:600px;max-width:95vw;display:flex;flex-direction:column;gap:18px;position:relative;animation:modalpop .18s;}
    @keyframes modalpop{from{opacity:0;transform:scale(.96);}to{opacity:1;transform:scale(1);}}
    #notice-modal-close{position:absolute;right:32px;top:24px;font-size:2.1rem;color:#b9b9b9;background:none;border:none;cursor:pointer;font-weight:700;transition:color .13s;}
    #notice-modal-close:hover{color:#238058;}
    #notice-modal-box label{font-size:1.02rem;font-weight:700;color:#199150;margin:7px 0 4px;display:block;}
    #notice-modal-box input[type="text"],
    #notice-modal-box textarea{font-size:1rem;border:1.2px solid #c5e1d6;border-radius:7px;padding:12px;background:#f6faf7;width:100%;box-sizing:border-box;}
    #notice-modal-box textarea{min-height:120px;max-height:240px;resize:vertical;line-height:1.5;}
    #notice-modal-box input[type="file"]{font-size:.95rem;margin-top:7px;}
    #notice-modal-box button[type="submit"]{margin-top:18px;background:#238058;color:#fff;border:none;border-radius:7px;font-size:1.09rem;padding:13px 0;cursor:pointer;font-weight:700;letter-spacing:.09em;transition:background .13s;}
    #notice-modal-box button[type="submit"]:hover{background:#20b26a;}

    /* ---------- ê³µì§€ ì»¨í…Œì´ë„ˆ ---------- */
    .notice-container{
      width:calc(100% - 40px);
      max-width:1500px;
      /* margin:140px auto 0;   ê¸°ì¡´ â†’ ë„ˆë¬´ ë©€ë‹¤ */
      margin:20px auto 0;        /* â† ì›í•˜ëŠ” ë§Œí¼ ìˆ«ìë§Œ ì¤„ì´ë©´ OK */
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 24px #0001;
      padding:32px 0 24px;
    }

    /* ---------- ê³µì§€ í‘œ ---------- */
    .notice-table{width:100%;border-collapse:collapse;table-layout:fixed;}
    .notice-table thead{background:#fafafa;position:sticky;top:0;z-index:1;}
    .notice-table th,.notice-table td{padding:14px 22px;font-size:.95rem;border-bottom:1px solid #eee;}
    .notice-table th{color:#666;text-align:left;font-weight:600;}
    .notice-table td.cat {width:80px;color:#555;}
    .notice-table td.date{width:110px;text-align:right;color:#888;}
    .notice-table td.title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500;color:#222;}
    .notice-table tr:hover td{background:#f9f9f9;}

    /* NEW ë±ƒì§€ */
    .badge-new{
      display:inline-block;margin-right:8px;padding:3px 6px 2px;
      font-size:.75rem;font-weight:700;color:#fff;background:#e31b23;border-radius:3px;
    }

    /* â˜… ì œëª© ë°°ë„ˆ  (ë„¤ì´ë¹„ í†¤, ê°€ë¡œ 100%) */
    .page-banner{
      width:100%;
      background:#ffffff;           /* ì›í•˜ëŠ” ìƒ‰ìƒ */
      color:#111;
      padding:70px 0;               /* ìœ„Â·ì•„ë˜ ë†’ì´ */
      border-bottom:1px solid #000000;
    }
    
    .page-banner .inner{
      max-width:1400px;             /* í—¤ë”ì™€ ê°™ì€ ì¢Œìš° ì—¬ë°± */
      margin:0 auto;
      padding:0 40px;
    }
    .page-banner h2{
      font-size:2.4rem;
      font-weight:900;
      margin:0 0 14px 0;
    }
    .page-banner p{
      font-size:1.05rem;
      line-height:1.5;
      opacity:.85;
      margin:0;
    }

    .notice-table th,
    .notice-table td{ text-align:center !important; }

    .highlight {
      position: relative;
      display: inline-block;
    }

    .highlight::before {
      content: "";
      position: absolute;
      top: -4px;      /* ê¸€ì ìœ„ ìœ„ì¹˜ */
      left: 0;
      width: 30px;    /* ì„  ê¸¸ì´ */
      height: 5px;    /* ì„  êµµê¸° */
      background: #f8c900;  /* ë…¸ë€ìƒ‰ */
      border-radius: 2px;
    }

  </style>
</head>
<body>

<!-- â”€â”€â”€ 1.5) ì œëª© ë°°ë„ˆ â”€â”€â”€ -->
<section class="page-banner">
  <div class="inner">
    <h2>ê³µì§€ì‚¬í•­</h2>
    <p>ì—¬ëŸ¬ë¶„ì˜ ì„±ê³µì ì¸ ë‚´ì‹ ëŒ€ë¹„ë¥¼ ì¹´ì¹´ì˜¤ì˜ ê²€ì¦ëœ IT ì„œë¹„ìŠ¤
       ê²½í—˜ì„ Kakao i Cloudì— ë‹´ì•„ ë‚˜ëˆ„ê³ ì í•©ë‹ˆë‹¤.</p>
  </div>
</section>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê³µì§€ì‚¬í•­ ë¦¬ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="notice-container">
    <div class="notice-title">ê³µì§€ì‚¬í•­</div>
      <div style="overflow-x:auto;">
        <table class="notice-table">
      <!-- â˜… ì¶”ê°€ : ì—´ í­ ì„ ì–¸ -->
      <colgroup>
        <col style="width:140px">        <!-- ìœ í˜• -->
        <col>                           <!-- ì œëª©(ê°€ë³€) -->
        <col style="width:220px">       <!-- ë“±ë¡ì¼ -->
      </colgroup>

      <thead>
        <tr><th>ìœ í˜•</th><th>ì œëª©</th><th>ë“±ë¡ì¼</th></tr>
      </thead>
      <tbody id="notice-tbody"></tbody>
    </table>
      </div>

      <div class="pagination"></div>
    </div>

  <!-- í”Œë¡œíŒ…(+) ë²„íŠ¼ -->
  <button id="fab-add">+</button>

  <!-- ê³µì§€ ë“±ë¡ ëª¨ë‹¬ -->
  <div id="notice-modal-bg">
    <form id="notice-form" enctype="multipart/form-data">
      <div id="notice-modal-box">
        <button type="button" id="notice-modal-close">&times;</button>
        <div style="font-weight:700;font-size:1.28rem;margin-bottom:12px;">ê³µì§€ì‚¬í•­ ë“±ë¡</div>

        <label for="input-title">ì œëª©</label>
        <input id="input-title" name="title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="60" required>

        <label for="input-content">ë‚´ìš©</label>
        <textarea id="input-content" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>

        <label for="input-img">ì´ë¯¸ì§€ ì²¨ë¶€ (ì„ íƒ)</label>
        <input id="input-img" name="image" type="file" accept="image/*">

        <button type="submit" id="modal-submit">ë“±ë¡</button>
      </div>
    </form>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìŠ¤í¬ë¦½íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
    /* ë‚ ì§œ í‘œì‹œ */
    const wk=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const mo=['January','February','March','April','May','June','July','August','September','October','November','December'];
    function setToday(){
      const t=new Date();
    }

    /* ë¡œê·¸ì¸Â·í”„ë¡œí•„ ë°”ì¸ë”© + ê´€ë¦¬ì íŒë³„ */
    let IS_ADMIN=false;
    async function bindUser(){
      try{
        const res=await fetch('/check-auth?ts='+Date.now(),{credentials:'include',cache:'no-store'});
        const d=await res.json();
        IS_ADMIN=d.isLoggedIn && d.user && d.user.role==='admin';
        document.getElementById('fab-add').style.display=IS_ADMIN?'flex':'none';

        if(!d.isLoggedIn) return;
        const u=d.user||{};
        const first=(u.name||u.email||'User').split(' ')[0].split('@')[0];

        document.getElementById('userName').textContent=u.name||first;
        if(u.avatarUrl){
          document.getElementById('avatar').src=u.avatarUrl;
          document.getElementById('avatar').alt=u.name||'avatar';
        }
        /* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ ë¡œê·¸ì•„ì›ƒ */
        document.getElementById('logoutBtn').onclick=async()=>{
          await fetch('/logout',{credentials:'include'});location.reload();
        };
      }catch(e){console.error(e);}
    }

    /* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ í† ê¸€ */
    function initDropdown(){
      const box=document.getElementById('userBox');
      const menu=document.getElementById('dropdownMenu');
      const arrow=document.getElementById('arrowIcon');

      box.addEventListener('click',e=>{
        e.stopPropagation();
        const open=menu.style.display==='block';
        menu.style.display=open?'none':'block';
        arrow.style.transform=open?'rotate(0deg)':'rotate(180deg)';
      });
      document.addEventListener('click',e=>{
        if(!menu.contains(e.target)){
          menu.style.display='none';
          arrow.style.transform='rotate(0deg)';
        }
      });
    }

    /* ê³µì§€ CRUD */
    let noticeListData=[];let page=1;const perPage=7;

    function renderPagination(){
      const totalPages=Math.ceil(noticeListData.length/perPage);
      const box=document.querySelector('.pagination');box.innerHTML='';
      if(totalPages===0)return;
      for(let i=1;i<=totalPages;i++){
        const span=document.createElement('span');
        span.textContent=i;span.className=i===page?'active':'';
        span.onclick=()=>{page=i;renderNoticeList();renderPagination();};
        box.appendChild(span);
      }
    }

    /* â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function daysBetween(a,b){ return Math.floor((b-a)/864e5); }   // NEW ë±ƒì§€ìš©

    /* â”€â”€ ê³µì§€ ëª©ë¡ ê·¸ë¦¬ê¸° (í‘œ ë²„ì „) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderNoticeList(){
      const tbody = document.getElementById('notice-tbody');   // â† div ëŒ€ì‹  table tbody
      tbody.innerHTML = '';

      if (noticeListData.length === 0){
        tbody.innerHTML =
          '<tr><td colspan="3" style="padding:40px;text-align:center;color:#777;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        document.querySelector('.pagination').innerHTML = '';
        return;
      }

      const start = (page-1) * perPage;
      const view  = noticeListData.slice(start, start+perPage);

      view.forEach(item=>{
        const tr = document.createElement('tr'); tr.tabIndex = 0;
        tr.onclick   = ()=> toggleDetail(tr, item.id);
        tr.onkeydown = e => { if (e.key === 'Enter') toggleDetail(tr, item.id); };

        /* 1) ìœ í˜• */
        const tdCat   = document.createElement('td');
        tdCat.className = 'cat';
        tdCat.textContent = item.category || 'ê³µì§€';

        /* 2) ì œëª©  (+ NEW ë±ƒì§€) */
        const tdTitle = document.createElement('td');
        tdTitle.className = 'title';

        const written = new Date(item.date);
        if (daysBetween(written, new Date()) <= 7){      // 7ì¼ ì´ë‚´
          const badge = document.createElement('span');
          badge.className = 'badge-new';
          badge.textContent = 'NEW';
          tdTitle.appendChild(badge);
        }
        tdTitle.append(item.title);

        /* 3) ë‚ ì§œ */
        const tdDate  = document.createElement('td');
        tdDate.className = 'date';
        tdDate.textContent = item.date.slice(0,10).replace(/-/g,'.');

        tr.append(tdCat, tdTitle, tdDate);
        tbody.appendChild(tr);
      });
    }

    async function loadNotices(){
      page=1;
      const res=await fetch('/api/notices');noticeListData=await res.json();
      renderNoticeList();renderPagination();
    }

    let openedDetail=null;
    async function toggleDetail(row,id){
      // ê¸°ì¡´ ìƒì„¸ ì—´ ë‹«ê¸°
      if(openedDetail){
        openedDetail.nextSibling?.remove();
        openedDetail.classList.remove('active');
        if(openedDetail===row){openedDetail=null;return;}
      }

      const res = await fetch(`/api/notices/${id}`);
      const data=await res.json();

      // â‘  trë¡œ detailì„ ë§Œë“¤ì–´ì„œ colspan=3ë¡œ í‘œì‹œ
      const detailTr=document.createElement('tr');
      detailTr.className='notice-detail-row';

      // â‘¡ td í•˜ë‚˜ë§Œ ì“°ê³ , col 3ì¹¸ ì „ì²´ í•©ì¹¨ + íŒ¨ë”© ìŠ¤íƒ€ì¼
      const detailTd=document.createElement('td');
      detailTd.colSpan = 3;
      detailTd.style.cssText='background:#f6faf6;border-bottom:1.5px solid #d5eddc;padding:30px 50px 18px 50px;color:#222;font-size:1.09rem;animation:fadeIn .2s;';

      // ë‚´ìš© í‘œì‹œ
      let contentHtml = '';
      if(IS_ADMIN){
        contentHtml += `<button style="float:right;margin-left:15px;background:#e54e4e;color:#fff;border:none;border-radius:5px;font-size:.98rem;padding:7px 18px;cursor:pointer;" onclick="deleteNotice('${id}', this)">ì‚­ì œ</button>`;
      }
      contentHtml += `<div style="font-size:1.07rem;margin-bottom:15px;white-space:pre-line;">${data.content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}</div>`;
      if(data.imageUrl){
        contentHtml += `<img src="${data.imageUrl}" style="max-width:360px;border-radius:9px;margin-top:10px;">`;
      }

      detailTd.innerHTML = contentHtml;
      detailTr.appendChild(detailTd);
      row.after(detailTr);
      row.classList.add('active');
      openedDetail=row;
    }

    // ì‚­ì œë²„íŠ¼ í•¨ìˆ˜ ë¶„ë¦¬ (ìƒì„¸ ë‚´ ì‚­ì œ)
    window.deleteNotice = async function(id, btn){
      if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const r = await fetch(`/api/notices/${id}`, {method:'DELETE',credentials:'include'});
      const out=await r.json();
      if(out.msg==='ì‚­ì œ ì„±ê³µ'){
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadNotices();
      }else{
        alert('ì‚­ì œ ì‹¤íŒ¨: '+(out.msg||''));
      }
    }

    /* â”€â”€ ëª¨ë‹¬ ì œì–´ â”€â”€ */
    document.getElementById('fab-add').onclick=()=>{
      document.getElementById('notice-modal-bg').style.display='flex';
      document.getElementById('input-title').value='';
      document.getElementById('input-content').value='';
      document.getElementById('input-img').value='';
      document.getElementById('input-title').focus();
    };
    document.getElementById('notice-modal-close').onclick=()=>{document.getElementById('notice-modal-bg').style.display='none';};
    document.getElementById('notice-modal-bg').onclick=e=>{if(e.target===e.currentTarget)e.currentTarget.style.display='none';};

    document.getElementById('notice-form').onsubmit=async e=>{
      e.preventDefault();
      const title=document.getElementById('input-title').value.trim();
      const content=document.getElementById('input-content').value.trim();
      const image=document.getElementById('input-img').files[0];
      if(!title||!content){alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}

      const fd=new FormData();fd.append('title',title);fd.append('content',content);if(image)fd.append('image',image);
      const res=await fetch('/api/notices',{method:'POST',body:fd,credentials:'include'});
      const data=await res.json();
      if(data.msg==='ê³µì§€ ë“±ë¡ ì„±ê³µ'){document.getElementById('notice-modal-bg').style.display='none';loadNotices();}
      else alert('ë“±ë¡ ì‹¤íŒ¨: '+data.msg);
    };

    /* â”€â”€ ì´ˆê¸°í™” â”€â”€ */
    document.addEventListener('DOMContentLoaded',()=>{
      bindUser();
      initDropdown();
      loadNotices();
    });
  </script>
</body>
</html>