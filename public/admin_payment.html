<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>포인트 충전 신청내역 (관리자용)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f6f8fa;
      margin: 0;
      padding: 0;
      color: #222;
    }
    .admin-container {
      max-width: 850px;
      margin: 32px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 0 8px #eee;
      padding: 32px 24px 32px 24px;
    }
    .admin-title {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 22px;
      color: #293ad7;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 18px;
      font-size: 1.02rem;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 8px;
      border-bottom: 1px solid #f2f2f2;
      text-align: center;
    }
    th {
      background: #F6F8FF;
      font-weight: 600;
      color: #3945ae;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .status {
      font-size: 0.96rem;
      font-weight: 600;
      border-radius: 12px;
      padding: 4px 14px;
      display: inline-block;
    }
    .pending { background: #e9efff; color: #3d55c8;}
    .done { background: #d7f5da; color: #19a657;}
    .fail { background: #ffe9e9; color: #e44a3b;}
    .action-btn {
      background: #5e70e7;
      color: #fff;
      border: none;
      padding: 6px 16px;
      border-radius: 7px;
      cursor: pointer;
      font-size: 0.99rem;
      font-weight: 500;
      transition: background 0.15s;
    }
    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .filter-bar {
      margin-bottom: 18px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .filter-bar label {
      font-size: 1rem;
      margin-right: 5px;
      color: #293ad7;
      font-weight: 600;
    }
    .filter-bar input, .filter-bar select {
      font-size: 1rem;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-title">포인트 충전 신청내역 (관리자용)</div>
    <!-- 필터 -->
    <div class="filter-bar">
      <label>상태:</label>
      <select id="statusFilter">
        <option value="all">전체</option>
        <option value="pending">대기중</option>
        <option value="done">완료</option>
        <option value="fail">실패</option>
      </select>
      <label>입금자명:</label>
      <input type="text" id="payerFilter" placeholder="입금자명 입력">
      <button class="action-btn" onclick="filterTable()">검색</button>
    </div>
    <!-- 테이블 -->
    <table id="reqTable">
      <thead>
        <tr>
          <th>번호</th>
          <th>입금자명</th>
          <th>금액(만원)</th>
          <th>요청사항</th>
          <th>신청일시</th>
          <th>상태</th>
          <th>처리</th>
        </tr>
      </thead>
      <tbody>
        <!-- 데이터 행이 JS로 렌더링됩니다. -->
      </tbody>
    </table>
  </div>
  <script>
let data = [];
async function fetchPaymentList() {
  const res = await fetch('/api/admin/payment-list');
  if (res.ok) {
    data = await res.json();
    // 서버에서 받은 데이터가 아래와 같을 때(맞게 가공 필요)
    data = data.map(row => ({
      id: row.id,
      payer: row.payer,
      amount: row.amount,
      note: row.note,
      date: row.requested_at?.slice(0,16).replace('T',' ') || '-',
      status: row.status === '완료' ? 'done' : (row.status === '대기중' ? 'pending' : 'fail')
    }));
    renderTable(getFilterStatus(), getFilterPayer());
  } else {
    alert('목록을 불러오지 못했습니다.');
  }
}
fetchPaymentList();

    // 상태명 한글 변환
    const statusText = { pending: '대기중', done: '완료', fail: '실패' };
    // 상태별 클래스
    const statusClass = { pending: 'pending', done: 'done', fail: 'fail' };

    // 테이블 렌더링
    function renderTable(filterStatus = 'all', filterPayer = '') {
      const tbody = document.querySelector("#reqTable tbody");
      tbody.innerHTML = '';
      let viewData = data.filter(row => {
        if (filterStatus !== 'all' && row.status !== filterStatus) return false;
        if (filterPayer && !row.payer.includes(filterPayer)) return false;
        return true;
      });
      viewData.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.payer}</td>
          <td>${row.amount}</td>
          <td>${row.note || '-'}</td>
          <td>${row.date}</td>
          <td><span class="status ${statusClass[row.status]}">${statusText[row.status]}</span></td>
          <td>
            ${row.status === 'pending'
              ? `<button class="action-btn" onclick="markDone(${row.id})">완료</button>
                 <button class="action-btn" style="background:#e44a3b;" onclick="markFail(${row.id})">실패</button>`
              : '-'}
          </td>
        `;
        tbody.appendChild(tr);
      });
      if (viewData.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="7" style="color:#aaa;">신청 내역이 없습니다.</td>`;
        tbody.appendChild(tr);
      }
    }

    // 상태 변경 처리 (실제는 서버에 업데이트 필요)
    function markDone(id) {
      if (confirm('이 충전건을 완료처리 하시겠습니까?')) {
        data = data.map(row => row.id === id ? {...row, status: 'done'} : row);
        renderTable(getFilterStatus(), getFilterPayer());
      }
    }
    function markFail(id) {
      if (confirm('이 충전건을 실패처리 하시겠습니까?')) {
        data = data.map(row => row.id === id ? {...row, status: 'fail'} : row);
        renderTable(getFilterStatus(), getFilterPayer());
      }
    }
    function getFilterStatus() {
      return document.getElementById('statusFilter').value;
    }
    function getFilterPayer() {
      return document.getElementById('payerFilter').value.trim();
    }
    function filterTable() {
      renderTable(getFilterStatus(), getFilterPayer());
    }
    document.getElementById('statusFilter').onchange = filterTable;
    document.getElementById('payerFilter').onkeyup = function(e){ if(e.key==='Enter')filterTable(); };
    // 최초 렌더링
    renderTable();


  app.get('/admin_payment.html', isLoggedIn, isAdmin, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'admin_payment.html'));
  });

  </script>
</body>
</html>
