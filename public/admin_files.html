<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>자료 관리(관리자)</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:700,400&display=swap" rel="stylesheet">
  <style>
    body { background: #f5f5f7; font-family: 'Noto Sans KR', Arial, sans-serif; }
    .admin-table-box {
      max-width: 1120px;
      margin: 58px auto 0;
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 4px 32px #0001;
      padding: 38px 36px 40px 36px;
    }
    h2 {
      margin-bottom: 30px;
      text-align: left;
      font-size: 1.65rem;
      font-weight: 900;
      color: #181818;
      letter-spacing: -2px;
      position: relative;
    }
    /* 노란줄 삭제! */

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 22px;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-bar select,
    .search-bar input {
      background: #fafafc;
      border: 1.5px solid #d3d4da;
      border-radius: 8px;
      padding: 9px 10px;
      font-size: 1rem;
      color: #222;
      outline: none;
      transition: border 0.13s;
      min-width: 86px;
      margin-bottom: 3px;
    }
    .search-bar input[type="number"] {
      width: 70px;
      min-width: 60px;
    }
    .search-bar select:focus, .search-bar input:focus {
      border-color: #ffc400;
      background: #fffbe9;
    }
    .search-bar button {
      background: #ffc400;
      color: #181818;
      border: none;
      border-radius: 8px;
      padding: 9px 20px;
      font-size: 1.07rem;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 3px;
      box-shadow: 0 2px 7px #ffc40011;
      letter-spacing: 0.03em;
      transition: background 0.16s;
    }
    .search-bar button:last-child {
      background: #ececec;
      color: #222;
      margin-left: 4px;
      border: 1px solid #dedede;
      font-weight: 500;
    }
    .search-bar button:active { background: #ffd54f; }
    .msg { text-align: center; margin-top: 8px; font-size: 1rem; color: #181818; }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      font-size: 1rem;
    }
    th, td {
      padding: 11px 8px;
      text-align: center;
      font-size: 1.03rem;
      border-bottom: 1.2px solid #f1f1f3;
    }
    th {
      background: #181818;
      color: #fff;
      font-weight: 800;
      font-size: 1.07rem;
      letter-spacing: 0.02em;
      border-bottom: 2.2px solid #ffc400;
    }
    tr:last-child td { border-bottom: none; }
    td {
      color: #212327;
      background: #fff;
      transition: background 0.14s;
      vertical-align: middle;
    }
    /* hover: 연노랑 or 라이트그레이 */
    tr:hover td {
      background: #fffbe8 !important; /* 연노랑 */
      /* background: #f7f8fa !important;  // 라이트그레이로 하고 싶으면 이거 사용 */
      transition: background 0.16s;
    }
    /* 아이콘형 칼럼 스타일 */
    .file-icon {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 7px;
      font-size: 0.99rem;
      font-weight: 700;
      margin: 0 2px;
      letter-spacing: 0.01em;
      vertical-align: middle;
    }
    .file-icon-hwp {
      background: #e7eaf2;
      color: #5771bc;
      border: 1.2px solid #b6c6e6;
    }
    .file-icon-pdf {
      background: #fffbe8;
      color: #ffc400;
      border: 1.2px solid #ffe4a3;
    }

    /* 버튼(다운, 미리보기, 수정, 삭제) */
    .delete-btn, .edit-btn {
      background: #181818;
      color: #ffc400;
      border: none;
      border-radius: 7px;
      padding: 6px 16px;
      cursor: pointer;
      font-size: .97rem;
      font-weight: bold;
      margin: 0 1.5px;
      transition: background .12s, color .12s;
      letter-spacing: 0.02em;
    }
    .edit-btn { background: #ffc400; color: #181818; }
    .edit-btn:hover { background: #ffe46e; }
    .delete-btn:hover { background: #2d2d2d; color: #ff5353; }
    .delete-btn:disabled, .edit-btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .preview-btn, .download-btn {
      background: #fffbe8;
      color: #ffa900;
      border: 1.5px solid #ffd54f;
      border-radius: 6px;
      padding: 5px 12px;
      cursor: pointer;
      margin-left: 4px;
      font-size: .96rem;
      font-weight: bold;
      transition: background 0.12s, color 0.12s, border 0.12s;
      vertical-align: middle;
    }
    .preview-btn:hover, .download-btn:hover {
      background: #fffde2;
      color: #181818;
      border-color: #ffc400;
    }
    .download-btn { margin-left: 0; }

    /* 모달 스타일(기존 유지) */

    #edit-bg {
  display: none;
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: #18181899;
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
#edit-bg .modal-box {
  background: #fff;
  border-radius: 22px;
  box-shadow: 0 10px 40px #2222;
  width: 420px;
  max-width: 96vw;
  padding: 34px 32px 24px 32px;
  position: relative;
}
#edit-bg .modal-box h3 {
  margin: 0 0 26px 0;
  text-align: center;
  font-size: 1.22rem;
  font-weight: 900;
  color: #181818;
  letter-spacing: -1.5px;
}
#edit-bg .modal-box form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
#edit-bg .modal-box select,
#edit-bg .modal-box input[type="text"],
#edit-bg .modal-box input[type="number"] {
  border: 1.5px solid #ffe08a;
  background: #f9f9fa;
  border-radius: 9px;
  padding: 11px 13px;
  font-size: 1.04rem;
  outline: none;
  transition: border 0.16s, background 0.14s;
}
#edit-bg .modal-box select:focus,
#edit-bg .modal-box input:focus {
  border: 1.5px solid #ffc400;
  background: #fffbe8;
}
#edit-bg .modal-box input[type="file"] {
  border: none;
  background: none;
  padding: 0;
  font-size: 1rem;
}
#edit-bg .modal-box > div[style*="font-size:.9rem"] {
  font-size: 0.96rem !important;
  color: #444;
  margin-bottom: 3px;
}
#edit-bg .modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 16px;
}
#edit-bg .modal-box button {
  border: none;
  border-radius: 8px;
  font-size: 1.01rem;
  padding: 9px 22px;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.16s, color 0.13s;
}
#edit-bg .modal-box button[type="button"] {
  background: #ececec;
  color: #444;
}
#edit-bg .modal-box button[type="button"]:hover {
  background: #e2e2e2;
  color: #222;
}
#edit-bg .modal-box button[type="submit"] {
  background: #21b661;
  color: #fff;
}
#edit-bg .modal-box button[type="submit"]:hover {
  background: #199b50;
}
    .preview-bg { position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: #0007; z-index: 1500; display: none; align-items: center; justify-content: center; }
    .preview-content { background: #fff; border-radius: 12px; padding: 18px; max-width: 80vw; max-height: 80vh; overflow: auto; }
    .preview-content iframe, .preview-content img { max-width: 74vw; max-height: 70vh; }
    @media (max-width: 900px) {
      .admin-table-box { padding: 17px 2vw 22px 2vw; }
      .search-bar { flex-direction: column; gap: 4px; align-items: stretch; }
      table, th, td { font-size: 0.94rem; }
      th, td { padding: 7px 2px; }
    }
  </style>
</head>
<body>
  <div class="admin-table-box">
    <h2>자료 관리 (관리자)</h2>
    <div class="search-bar">
      <select id="search-level"><option value="">관 전체</option><option>중등</option><option>고등</option></select>
      <select id="search-region"><option value="">지역 전체</option><option>서울</option><option>경기</option><option>인천</option><option>부산</option><option>대구</option><option>광주</option><option>대전</option><option>기타</option></select>
      <input id="search-school" placeholder="학교명" style="width:80px;" />
      <input id="search-title"  placeholder="자료명" style="width:80px;" />
      <input id="search-year"   placeholder="연도"   style="width:60px;" type="number"/>
      <button onclick="doSearch()">검색</button>
      <button onclick="resetSearch()" style="margin-left:2px;">초기화</button>
    </div>
    <div class="msg" id="msg"></div>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>관</th><th>지역</th><th>구/군</th><th>학교</th>
          <th>학년</th><th>연도</th><th>학기</th><th>제목</th>
          <th>한글</th><th>PDF</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody id="file-list"><!-- JS로 채움 --></tbody>
    </table>
  </div>
  <!-- 이하 기존 모달/미리보기/JS 100% 유지 -->
  <div id="edit-bg">
    <div class="modal-box">
      <h3 style="margin-top:0">자료 정보 수정</h3>
      <form id="edit-form" enctype="multipart/form-data">
        <select name="level" required>
          <option value="">관 선택</option>
          <option value="중등">중등</option>
          <option value="고등">고등</option>
        </select>
        <select name="region" required>
          <option value="">지역 선택</option>
          <option>서울</option>
          <option>경기</option>
          <option>인천</option>
          <option>부산</option>
          <option>대구</option>
          <option>광주</option>
          <option>대전</option>
          <option>기타</option>
        </select>
        <input name="district"  placeholder="구/군"         required />
        <input name="school"    placeholder="학교"          required />
        <select name="grade" required>
          <option value="">학년</option>
          <option>중1</option>
          <option>중2</option>
          <option>중3</option>
          <option>고1</option>
          <option>고2</option>
          <option>고3</option>
        </select>
        <input name="year"      type="number" placeholder="연도" required />
        <select name="semester" required>
          <option value="">학기</option>
          <option>1학기중간</option>
          <option>1학기기말</option>
          <option>2학기중간</option>
          <option>2학기기말</option>
        </select>
        <input name="title"     placeholder="제목"          required />
        <div style="font-size:.9rem;margin:4px 0 2px;">파일 교체(선택)</div>
        <input name="files" type="file" multiple />
        <div style="text-align:right;margin-top:12px;">
          <button type="button" onclick="closeEdit()" style="margin-right:6px;">취소</button>
          <button type="submit" id="edit-save-btn" style="background:#28b663;color:#fff;border:none;padding:6px 14px;border-radius:6px;">저장</button>
        </div>
      </form>
    </div>
  </div>
  <div class="preview-bg" id="preview-bg">
    <div class="preview-content" id="preview-content">
      <button onclick="closePreview()" style="float:right;font-size:1.1rem;background:none;border:none;color:#f45a6a;">✕</button>
      <div id="preview-body"></div>
    </div>
  </div>
  <script>
    // JS는 기존 그대로! 단, 아이콘/버튼 HTML만 컬러화 적용
    let fileListOrigin = [];
    let editTargetId   = null;
    async function fetchFiles(){
      const res  = await fetch('/api/files',{credentials:'include'});
      if(res.status===401){
        alert('로그인 필요!'); location.href='/login.html'; return;
      }
      const list = await res.json();
      fileListOrigin = list;
      renderTable(list);
    }
    function renderTable(list){
      const tbody = document.getElementById('file-list');
      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;color:#bbb;">자료가 없습니다</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(r=>`
        <tr>
          <td>${r.id}</td>
          <td>${r.level||'-'}</td>
          <td>${r.region}</td>
          <td>${r.district}</td>
          <td>${r.school}</td>
          <td>${r.grade}</td>
          <td>${r.year}</td>
          <td>${r.semester}</td>
          <td>${r.title}</td>
          <td>
            ${r.hwp_filename ? `
              <span class="file-icon file-icon-hwp">HWP</span>
              <a href="/download/${r.id}?type=hwp" class="download-btn" target="_blank">다운로드</a>
              <button class="preview-btn" onclick="previewFile('${r.hwp_filename}')">미리보기</button>
            ` : '-'}
          </td>
          <td>
            ${r.pdf_filename ? `
              <span class="file-icon file-icon-pdf">PDF</span>
              <a href="/download/${r.id}?type=pdf" class="download-btn" target="_blank">다운로드</a>
              <button class="preview-btn" onclick="previewFile('${r.pdf_filename}')">미리보기</button>
            ` : '-'}
          </td>
          <td>
            <button class="edit-btn"   onclick="editFile(${r.id})">수정</button>
            <button class="delete-btn" onclick="deleteFile(${r.id},this)">삭제</button>
          </td>
        </tr>
      `).join('');
    }
    function doSearch(){
      let level = document.getElementById('search-level').value;
      let region= document.getElementById('search-region').value;
      let school= document.getElementById('search-school').value.trim();
      let title = document.getElementById('search-title').value.trim();
      let year  = document.getElementById('search-year').value.trim();
      let filtered = fileListOrigin.filter(r=>
        (!level || r.level===level) &&
        (!region|| r.region===region) &&
        (!school|| (r.school && r.school.includes(school))) &&
        (!title || (r.title  && r.title.includes(title))) &&
        (!year  || String(r.year).includes(year))
      );
      renderTable(filtered);
    }
    function resetSearch(){
      document.getElementById('search-level').value = '';
      document.getElementById('search-region').value = '';
      document.getElementById('search-school').value = '';
      document.getElementById('search-title').value = '';
      document.getElementById('search-year').value = '';
      renderTable(fileListOrigin);
    }
    async function deleteFile(id,btn){
      if(!confirm('정말 삭제하시겠습니까?')) return;
      btn.disabled = true;
      try{
        const res = await fetch('/api/files/'+id,{method:'DELETE',credentials:'include'});
        if(res.status===401){ alert('로그인 필요!'); location.href='/login.html'; return; }
        const r   = await res.json();
        document.getElementById('msg').textContent = r.message || r.msg;
        fetchFiles();
      }catch(e){
        document.getElementById('msg').textContent = '삭제 오류';
      }
      btn.disabled = false;
    }
    function editFile(id){
      editTargetId = id;
      const row    = fileListOrigin.find(r=>r.id===id);
      const form   = document.getElementById('edit-form');
      form.level.value    = row.level;
      form.region.value   = row.region;
      form.district.value = row.district;
      form.school.value   = row.school;
      form.grade.value    = row.grade;
      form.year.value     = row.year;
      form.semester.value = row.semester;
      form.title.value    = row.title;
      form.files.value    = '';
      document.getElementById('edit-bg').style.display='flex';
    }
    function closeEdit(){
      document.getElementById('edit-bg').style.display='none';
      document.getElementById('edit-form').reset();
    }
    document.getElementById('edit-form').onsubmit = async function(e){
      e.preventDefault();
      const btn = document.getElementById('edit-save-btn');
      btn.disabled = true;
      const fd  = new FormData(e.target);
      const res = await fetch('/api/files/'+editTargetId,{
        method:'PUT',
        body:fd,
        credentials:'include'
      });
      const r = await res.json();
      document.getElementById('msg').textContent = r.message||r.msg;
      btn.disabled = false;
      closeEdit();
      fetchFiles();
    }
    function previewFile(filename){
      const ext = filename.split('.').pop().toLowerCase();
      document.getElementById('preview-bg').style.display='flex';
      const body = document.getElementById('preview-body');
      if(ext==='pdf'){
        body.innerHTML = `<iframe src="/uploads/${filename}" style="width:60vw;height:60vh;" frameborder="0"></iframe>`;
      }else if(ext==='jpg'||ext==='jpeg'||ext==='png'){
        body.innerHTML = `<img src="/uploads/${filename}" alt="미리보기" />`;
      }else{
        body.innerHTML = `<div style="padding:50px 0;text-align:center;color:#888;font-size:1.1rem;">
          미리보기는 PDF/이미지 파일만 지원합니다.<br>
          <span style="color:#bbb;">(${filename})</span>
        </div>`;
      }
    }
    function closePreview(){
      document.getElementById('preview-bg').style.display='none';
      document.getElementById('preview-body').innerHTML='';
    }
    fetchFiles();
  </script>
</body>
</html>
