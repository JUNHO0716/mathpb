<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>자료 관리(관리자)</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:700,400&display=swap" rel="stylesheet">
  <style>
    body { background: #f5f5f7; font-family: 'Noto Sans KR', Arial, sans-serif; }
    .admin-table-box {
      max-width: 1480px;   /* ✅ 더 넓게 */
      margin: 50px auto 0;
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 4px 32px #0001;
      padding: 38px 36px 40px 36px;
    }
    h2 {
      margin-bottom: 30px;
      text-align: left;
      font-size: 1.48rem;  /* 글씨 약간 축소 */
      font-weight: 900;
      color: #181818;
      letter-spacing: -2px;
    }
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-bar select,
    .search-bar input {
      background: #fafafc;
      border: 1.5px solid #d3d4da;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.95rem;   /* 글씨 약간 축소 */
      color: #222;
      outline: none;
      transition: border 0.13s;
      min-width: 82px;
      margin-bottom: 3px;
    }
    .search-bar input[type="number"] {
      width: 70px;
      min-width: 60px;
    }
    .search-bar select:focus, .search-bar input:focus {
      border-color: #ffc400;
      background: #fffbe9;
    }
    .search-bar button {
      background: #ffc400;
      color: #181818;
      border: none;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 0.96rem;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 3px;
      box-shadow: 0 2px 7px #ffc40011;
      letter-spacing: 0.03em;
      transition: background 0.16s;
    }
    .search-bar button:last-child {
      background: #ececec;
      color: #222;
      margin-left: 4px;
      border: 1px solid #dedede;
      font-weight: 500;
    }
    .search-bar button:active { background: #ffd54f; }
    .msg { text-align: center; margin-top: 8px; font-size: 0.98rem; color: #181818; }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      font-size: 0.97rem;   /* 글씨 약간 축소 */
      table-layout: fixed;
      word-break: keep-all;
    }
    th, td {
      padding: 8px 7px;
      text-align: center;
      font-size: 0.97rem;    /* 글씨 약간 축소 */
      border-bottom: 1.1px solid #f1f1f3;
      word-break: keep-all;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      background: #181818;
      color: #fff;
      font-weight: 800;
      font-size: 1rem;
      letter-spacing: 0.01em;
      border-bottom: 2.2px solid #ffc400;
    }
    tr:last-child td { border-bottom: none; }
    td {
      color: #212327;
      background: #fff;
      transition: background 0.14s;
      vertical-align: middle;
    }
    tr:hover td {
      background: #fffbe8 !important;
      transition: background 0.16s;
    }
    /* 다운로드 버튼만 남기고, 노란색 */
    .download-btn {
      background: #fffbe8;
      color: #ffa900;
      border: 1.5px solid #ffd54f;
      border-radius: 6px;
      padding: 5px 14px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: bold;
      transition: background 0.12s, color 0.12s, border 0.12s;
      vertical-align: middle;
      margin: 0 2px;
      min-width: 72px;
    }
    .download-btn:hover {
      background: #fffde2;
      color: #181818;
      border-color: #ffc400;
    }
    /* 관리 버튼 */
    .delete-btn, .edit-btn {
      background: #181818;
      color: #ffc400;
      border: none;
      border-radius: 7px;
      padding: 5px 13px;
      cursor: pointer;
      font-size: 0.92rem;
      font-weight: bold;
      margin: 0 1.5px;
      transition: background .12s, color .12s;
      letter-spacing: 0.02em;
      min-width: 50px;
    }
    .edit-btn { background: #ffc400; color: #181818; }
    .edit-btn:hover { background: #ffe46e; }
    .delete-btn:hover { background: #2d2d2d; color: #ff5353; }
    .delete-btn:disabled, .edit-btn:disabled { opacity: 0.55; cursor: not-allowed; }
    /* 반응형 */
    @media (max-width: 1200px) {
      .admin-table-box { max-width: 99vw; padding: 14px 2vw 16px 2vw; }
      table, th, td { font-size: 0.93rem; }
      th, td { padding: 6px 2px; }
    }
    @media (max-width: 950px) {
      .admin-table-box { padding: 8px 1vw 10px 1vw; }
      .search-bar { flex-direction: column; gap: 4px; align-items: stretch; }
      table, th, td { font-size: 0.89rem; }
      th, td { padding: 4px 1px; }
    }
  </style>
</head>
<body>
  <div class="admin-table-box">
    <h2>자료 관리 (관리자)</h2>
    <div class="search-bar">
      <select id="search-level"><option value="">관 전체</option><option>중등</option><option>고등</option></select>
      <select id="search-region"><option value="">지역 전체</option><option>서울</option><option>경기</option><option>인천</option><option>부산</option><option>대구</option><option>광주</option><option>대전</option><option>기타</option></select>
      <input id="search-school" placeholder="학교명" style="width:95px;" />
      <input id="search-title"  placeholder="자료명" style="width:95px;" />
      <input id="search-year"   placeholder="연도"   style="width:70px;" type="number"/>
      <button onclick="doSearch()">검색</button>
      <button onclick="resetSearch()" style="margin-left:2px;">초기화</button>
    </div>
    <div class="msg" id="msg"></div>
    <table>
      <thead>
        <tr>
          <th style="width: 55px;">ID</th>
          <th style="width: 65px;">관</th>
          <th style="width: 75px;">지역</th>
          <th style="width: 85px;">구/군</th>
          <th style="width: 155px;">학교</th>
          <th style="width: 65px;">학년</th>
          <th style="width: 70px;">연도</th>
          <th style="width: 95px;">학기</th>
          <th style="width: 260px;">제목</th>
          <th style="width: 105px;">한글</th>
          <th style="width: 105px;">PDF</th>
          <th style="width: 98px;">관리</th>
        </tr>
      </thead>
      <tbody id="file-list"><!-- JS로 채움 --></tbody>
    </table>
  </div>
  <div id="edit-bg">
    <div class="modal-box">
      <h3 style="margin-top:0">자료 정보 수정</h3>
      <form id="edit-form" enctype="multipart/form-data">
        <select name="level" required>
          <option value="">관 선택</option>
          <option value="중등">중등</option>
          <option value="고등">고등</option>
        </select>
        <select name="region" required>
          <option value="">지역 선택</option>
          <option>서울</option>
          <option>경기</option>
          <option>인천</option>
          <option>부산</option>
          <option>대구</option>
          <option>광주</option>
          <option>대전</option>
          <option>기타</option>
        </select>
        <input name="district"  placeholder="구/군"         required />
        <input name="school"    placeholder="학교"          required />
        <select name="grade" required>
          <option value="">학년</option>
          <option>중1</option>
          <option>중2</option>
          <option>중3</option>
          <option>고1</option>
          <option>고2</option>
          <option>고3</option>
        </select>
        <input name="year"      type="number" placeholder="연도" required />
        <select name="semester" required>
          <option value="">학기</option>
          <option>1학기중간</option>
          <option>1학기기말</option>
          <option>2학기중간</option>
          <option>2학기기말</option>
        </select>
        <input name="title"     placeholder="제목"          required />
        <div style="font-size:.9rem;margin:4px 0 2px;">파일 교체(선택)</div>
        <input name="files" type="file" multiple />
        <div style="text-align:right;margin-top:12px;">
          <button type="button" onclick="closeEdit()" style="margin-right:6px;">취소</button>
          <button type="submit" id="edit-save-btn" style="background:#28b663;color:#fff;border:none;padding:6px 14px;border-radius:6px;">저장</button>
        </div>
      </form>
    </div>
  </div>
  <div class="preview-bg" id="preview-bg">
    <div class="preview-content" id="preview-content">
      <button onclick="closePreview()" style="float:right;font-size:1.1rem;background:none;border:none;color:#f45a6a;">✕</button>
      <div id="preview-body"></div>
    </div>
  </div>
  <script>
    // JS는 100% 그대로, 버튼만 수정
    let fileListOrigin = [];
    let editTargetId   = null;
    async function fetchFiles(){
      const res  = await fetch('/api/files',{credentials:'include'});
      if(res.status===401){
        alert('로그인 필요!'); location.href='/login.html'; return;
      }
      const list = await res.json();
      fileListOrigin = list;
      renderTable(list);
    }
    function renderTable(list){
      const tbody = document.getElementById('file-list');
      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;color:#bbb;">자료가 없습니다</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(r=>`
        <tr>
          <td>${r.id}</td>
          <td>${r.level||'-'}</td>
          <td>${r.region}</td>
          <td>${r.district}</td>
          <td>${r.school}</td>
          <td>${r.grade}</td>
          <td>${r.year}</td>
          <td>${r.semester}</td>
          <td>${r.title}</td>
          <td>
            ${r.hwp_filename ? `
              <a href="/download/${r.id}?type=hwp" class="download-btn" target="_blank">다운로드</a>
            ` : '-'}
          </td>
          <td>
            ${r.pdf_filename ? `
              <a href="/download/${r.id}?type=pdf" class="download-btn" target="_blank">다운로드</a>
            ` : '-'}
          </td>
          <td>
            <button class="edit-btn"   onclick="editFile(${r.id})">수정</button>
            <button class="delete-btn" onclick="deleteFile(${r.id},this)">삭제</button>
          </td>
        </tr>
      `).join('');
    }
    function doSearch(){
      let level = document.getElementById('search-level').value;
      let region= document.getElementById('search-region').value;
      let school= document.getElementById('search-school').value.trim();
      let title = document.getElementById('search-title').value.trim();
      let year  = document.getElementById('search-year').value.trim();
      let filtered = fileListOrigin.filter(r=>
        (!level || r.level===level) &&
        (!region|| r.region===region) &&
        (!school|| (r.school && r.school.includes(school))) &&
        (!title || (r.title  && r.title.includes(title))) &&
        (!year  || String(r.year).includes(year))
      );
      renderTable(filtered);
    }
    function resetSearch(){
      document.getElementById('search-level').value = '';
      document.getElementById('search-region').value = '';
      document.getElementById('search-school').value = '';
      document.getElementById('search-title').value = '';
      document.getElementById('search-year').value = '';
      renderTable(fileListOrigin);
    }
    async function deleteFile(id,btn){
      if(!confirm('정말 삭제하시겠습니까?')) return;
      btn.disabled = true;
      try{
        const res = await fetch('/api/files/'+id,{method:'DELETE',credentials:'include'});
        if(res.status===401){ alert('로그인 필요!'); location.href='/login.html'; return; }
        const r   = await res.json();
        document.getElementById('msg').textContent = r.message || r.msg;
        fetchFiles();
      }catch(e){
        document.getElementById('msg').textContent = '삭제 오류';
      }
      btn.disabled = false;
    }
    function editFile(id){
      editTargetId = id;
      const row    = fileListOrigin.find(r=>r.id===id);
      const form   = document.getElementById('edit-form');
      form.level.value    = row.level;
      form.region.value   = row.region;
      form.district.value = row.district;
      form.school.value   = row.school;
      form.grade.value    = row.grade;
      form.year.value     = row.year;
      form.semester.value = row.semester;
      form.title.value    = row.title;
      form.files.value    = '';
      document.getElementById('edit-bg').style.display='flex';
    }
    function closeEdit(){
      document.getElementById('edit-bg').style.display='none';
      document.getElementById('edit-form').reset();
    }
    document.getElementById('edit-form').onsubmit = async function(e){
      e.preventDefault();
      const btn = document.getElementById('edit-save-btn');
      btn.disabled = true;
      const fd  = new FormData(e.target);
      const res = await fetch('/api/files/'+editTargetId,{
        method:'PUT',
        body:fd,
        credentials:'include'
      });
      const r = await res.json();
      document.getElementById('msg').textContent = r.message||r.msg;
      btn.disabled = false;
      closeEdit();
      fetchFiles();
    }
    function previewFile(filename){
      // 이 함수는 더 이상 호출되지 않으나 미리보기 삭제 요청에 따라 내용 그대로 둡니다.
    }
    function closePreview(){
      document.getElementById('preview-bg').style.display='none';
      document.getElementById('preview-body').innerHTML='';
    }
    fetchFiles();
  </script>
</body>
</html>
