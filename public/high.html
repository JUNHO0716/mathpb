<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1200" />
  <title>ê¸°ì¶œìë£Œ ë¦¬ìŠ¤íŠ¸</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:700,400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/footer.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ========== ê¸°ì¡´ CSS ì½”ë“œëŠ” ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ========== */
    /* CSSëŠ” ë³€ê²½í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ìƒëµí–ˆìŠµë‹ˆë‹¤. */
    /* middle.html ë˜ëŠ” high.htmlì— ìˆë˜ <style> íƒœê·¸ ì•ˆì˜ ëª¨ë“  ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤. */
    :root{--c-main:#111;--c-text:#4b4f55;--c-light:#f4f5f7;--c-border:#e3e6ea;--c-btn:#FDC512;--c-btn-hov:#D9A90F;--c-accent:#202020;}
    *{box-sizing:border-box;font-family:'Noto Sans KR',sans-serif;margin:0;}
    body{background:#ffffff;;color:var(--c-text);min-height:100vh;display:flex;flex-direction:column;}
    .wrapper{width:95%;max-width:none;margin:40px auto 0;}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;}
    .filter-set{display:flex;gap:10px;flex:1 1 0;}
    .filter{appearance:none;outline:none !important;border:1px solid var(--c-border);border-radius:6px;padding:0 36px 0 12px;background:#fff url("data:image/svg+xml,%3Csvg viewBox='0 0 20 20' fill='%23343a40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 7l5 6 5-6H5z'/%3E%3C/svg%3E") no-repeat right 12px center/12px 12px;}
    .filter:focus{border-color:var(--c-main);box-shadow:none;}
    .filter::-ms-expand{display:none;}
    .btn{height:38px;padding:0 20px;border:none;border-radius:6px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background .15s;font-size:.93rem;}
    .btn--search{background:var(--c-accent);color:#fff;}
    .btn--search:hover{background:#4a4a4a;}
    .btn--primary{background:var(--c-btn);color:#fff;}
    .btn--primary:hover{background:var(--c-btn-hov);}
    .table-wrap{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.05);overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    thead{background:var(--c-light);color:var(--c-main);font-weight:700;}
    th,td{padding:10px 8px;font-size:.9rem;text-align:center;}
    tbody tr{border-bottom:1px solid var(--c-border);}
    tbody tr:hover{background:#f7f9fb;}
    .badge{padding:2px 10px;border-radius:12px;font-size:.78rem;font-weight:700;color:#fff;}
    .badge--green{background:var(--c-accent);}
    .badge--red{background:#ff5b62;}
    .download-btn{display:inline-block;margin-right:4px;vertical-align:middle;background:none;border:none;cursor:pointer;}
    .pagination{display:flex;justify-content:center;gap:8px;margin:28px 0;}
    .page{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border:1px solid var(--c-border);border-radius:4px;background:#fff;color:var(--c-main);cursor:pointer;transition:.15s;}
    .page:hover{background:var(--c-light);}
    .page.active{background:var(--c-accent);border-color:var(--c-accent);color:#fff;pointer-events:none;}
    .page-banner{width:100%;background:#ffffff;color:#111;padding:70px 0;border-bottom:1px solid #000000;}
    .page-banner .inner{max-width:1400px;margin:0 auto;padding:0 40px;}
    .page-banner h2{font-size:2.4rem;font-weight:900;margin:0 0 14px 0;}
    .page-banner p{font-size:1.05rem;line-height:1.5;opacity:.85;margin:0;}
    .bar-sep{color:#f8c900;font-weight:1000;}
    .level-toggle-container{display:inline-flex;align-items:center;margin-left:20px;gap:10px;font-size:0.98rem;font-weight:700;}
    .switch{position:relative;display:inline-block;width:52px;height:28px;}
    .switch input{opacity:0;width:0;height:0;}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--c-btn);transition:.4s;border-radius:28px;}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;}
    input:checked + .slider:before{transform:translateX(24px);}
    .with-toggle{display:flex;align-items:flex-end;gap:18px;}
    .with-toggle .level-toggle-container{margin:0;position:relative;top:-7px;}
    .swal2-actions-center{justify-content:center !important;}
  </style>
</head>
<body>

<section class="page-banner">
  <div class="inner">
    <h2 class="with-toggle">
      <span id="level-title"></span> <span class="bar-sep">|</span> ê¸°ì¶œìë£Œ
      <span class="level-toggle-container">
        <label class="switch">
          <input type="checkbox" id="levelToggle">
          <span class="slider"></span>
        </label>
        <span id="levelText"></span>
      </span>
    </h2>
    <p>ì „êµ­ í•™êµë³„ ê¸°ì¶œìë£Œë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•˜ê³ , í•„ìš”í•œ ìë£Œë¥¼ ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”.</p>
  </div>
</section>

<div class="wrapper">
  <div class="toolbar">
    <div class="filter-set">
      <select id="region" class="filter"><option value="">ì§€ì—­</option><option>ì„œìš¸</option><option>ê²½ê¸°</option></select>
      <input id="district" class="filter" placeholder="êµ¬/êµ°">
      <input id="school" class="filter" placeholder="í•™êµëª…">
      <select id="grade" class="filter"><option value="">í•™ë…„</option></select>
      <input id="year" class="filter" placeholder="ì—°ë„" type="number">
      <select id="semester" class="filter"><option value="">í•™ê¸°</option><option>1í•™ê¸°ì¤‘ê°„</option><option>1í•™ê¸°ê¸°ë§</option><option>2í•™ê¸°ì¤‘ê°„</option><option>2í•™ê¸°ê¸°ë§</option></select>
      <button class="btn btn--search" onclick="searchFiles()"><i class="fa-solid fa-magnifying-glass"></i> ê²€ìƒ‰</button>
      <button id="uploadBtn" class="btn btn--primary" style="display:none;margin-left:8px;"><i class="fa-solid fa-upload"></i> ì‹œí—˜ì§€ ì—…ë¡œë“œ</button>
      <button id="manageBtn" class="btn btn--primary" style="display:none;margin-left:8px;"><i class="fa-solid fa-gears"></i> ì‹œí—˜ì§€ ê´€ë¦¬</button>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:60px">No</th>
          <th style="text-align:left;padding-left:18px">ìë£Œëª…</th>
          <th>í•™ë…„</th>
          <th>í•™ê¸°</th>
          <th>ì—°ë„</th>
          <th>ì—…ë¡œë“œì¼</th>
          <th style="width:170px">ë‹¤ìš´ë¡œë“œ</th>
        </tr>
      </thead>
      <tbody id="file-list"></tbody>
    </table>
  </div>

  <div class="pagination" id="pagination"></div>
</div>

<script>
let currentUser = null;
let fileData = [];
let currentPage = 1;
const pageSize = 30;
// ğŸ”‘ ë³€ê²½ì : í˜„ì¬ ì„ íƒëœ ë ˆë²¨(ì¤‘ë“±/ê³ ë“±)ì„ ì €ì¥í•  ë³€ìˆ˜
let currentLevel = 'ì¤‘ë“±';

// ğŸ”‘ ë³€ê²½ì : ì¤‘ë“±/ê³ ë“±ë³„ í•™ë…„ ì˜µì…˜ ë¯¸ë¦¬ ì •ì˜
const gradeOptions = {
  'ì¤‘ë“±': ['ì¤‘1', 'ì¤‘2', 'ì¤‘3'],
  'ê³ ë“±': ['ê³ 1', 'ê³ 2', 'ê³ 3']
};

/**
 * ğŸ”‘ ìƒˆë¡œìš´ í•¨ìˆ˜: ì¤‘ë“±/ê³ ë“± ëª¨ë“œë¥¼ ì „í™˜í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
 * UI í…ìŠ¤íŠ¸, í•™ë…„ í•„í„° ì˜µì…˜ì„ ë³€ê²½í•˜ê³  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
 */
function switchLevel(level) {
  currentLevel = level; // í˜„ì¬ ë ˆë²¨ ìƒíƒœ ì—…ë°ì´íŠ¸

  // 1. UI í…ìŠ¤íŠ¸ ë° í† ê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸
  const levelTitle = document.getElementById('level-title');
  const levelText = document.getElementById('levelText');
  const levelToggle = document.getElementById('levelToggle');

  if (level === 'ì¤‘ë“±') {
    levelTitle.textContent = 'ì¤‘ë“±ê´€';
    levelText.textContent = 'ì¤‘ë“±';
    levelToggle.checked = true; // ì¤‘ë“±ì¼ ë•Œ í† ê¸€ ON
  } else {
    levelTitle.textContent = 'ê³ ë“±ê´€';
    levelText.textContent = 'ê³ ë“±';
    levelToggle.checked = false; // ê³ ë“±ì¼ ë•Œ í† ê¸€ OFF
  }

  // 2. í•™ë…„ í•„í„° ì˜µì…˜ ë™ì  ë³€ê²½
  const gradeSelect = document.getElementById('grade');
  gradeSelect.innerHTML = '<option value="">í•™ë…„</option>'; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
  gradeOptions[level].forEach(optionText => {
    const option = document.createElement('option');
    option.value = optionText;
    option.textContent = optionText;
    gradeSelect.appendChild(option);
  });
  
  // 3. í•„í„° ì´ˆê¸°í™” ë° ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
  clearFilters();
  fetchFiles();
}

// í•„í„° ì´ˆê¸°í™” í•¨ìˆ˜
function clearFilters() {
    document.getElementById('region').value = '';
    document.getElementById('district').value = '';
    document.getElementById('school').value = '';
    document.getElementById('grade').value = '';
    document.getElementById('year').value = '';
    document.getElementById('semester').value = '';
}


async function fetchFiles() {
  const params = new URLSearchParams({
    region:   document.getElementById('region').value,
    district: document.getElementById('district').value.trim(),
    school:   document.getElementById('school').value.trim(),
    grade:    document.getElementById('grade').value,
    year:     document.getElementById('year').value.trim(),
    semester: document.getElementById('semester').value
  });
  // ğŸ”‘ ë³€ê²½ì : í•˜ë“œì½”ë”©ëœ 'ì¤‘ë“±' ëŒ€ì‹  currentLevel ë³€ìˆ˜ ì‚¬ìš©
  params.append('level', currentLevel);

  try {
    const res = await fetch('/api/files?' + params.toString());
    fileData = await res.json();
    currentPage = 1;
    renderPage();
  } catch (error) {
    console.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
    const tb = document.getElementById('file-list');
    tb.innerHTML = '<tr><td colspan="7" style="padding:20px;color:#c0392b;">ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
  }
}

function searchFiles(){
  fetchFiles();
}

function renderPage(){
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const list = Array.isArray(fileData) ? fileData : (fileData.items || []);
  const pageData = list.slice(start, end);
  renderTable(pageData);
  renderPagination();
}

function renderPagination(){
  const list = Array.isArray(fileData) ? fileData : (fileData.items || []);
  const totalPages = Math.ceil(list.length / pageSize) || 1;
  const p = document.getElementById('pagination');
  p.innerHTML = '';
  for(let i=1; i<=totalPages; i++){
    const d = document.createElement('div');
    d.className = 'page' + (i === currentPage ? ' active' : '');
    d.textContent = i;
    if(i !== currentPage) {
      d.onclick = () => {
        currentPage = i;
        renderPage();
      };
    }
    p.appendChild(d);
  }
}

function renderTable(list) {
  const tb = document.getElementById('file-list');
  if (!list.length) {
    tb.innerHTML = '<tr><td colspan="7" style="padding:20px;color:#9ba4b0;">ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }
  tb.innerHTML = list.map((row, i) => `
    <tr>
      <td>${(currentPage - 1) * pageSize + i + 1}</td>
      <td style="text-align:left;padding-left:18px">
        ${row.title}
        ${row.tag ? `<span class="badge badge--${row.tag === 'í†µê³¼' ? 'green' : 'red'}" style="margin-left:6px;">${row.tag}</span>` : ''}
      </td>
      <td>${row.grade || ''}</td>
      <td>${row.semester || ''}</td>
      <td>${row.year || ''}</td>
      <td>${formatDate(row.uploaded_at || row.date)}</td>
      <td>
        <button class="download-btn" title="PDF ë‹¤ìš´ë¡œë“œ" onclick="downloadFile('${row.id}','pdf')">
          <img src="/pdf_download.png" alt="PDF ë‹¤ìš´ë¡œë“œ" style="width:32px;height:32px;">
        </button>
        <button class="download-btn" title="HWP ë‹¤ìš´ë¡œë“œ" onclick="downloadFile('${row.id}','hwp')">
          <img src="/hwp_download.png" alt="HWP ë‹¤ìš´ë¡œë“œ" style="width:32px;height:32px;">
        </button>
      </td>
    </tr>`).join('');
}

function downloadFile(id, type) {
  if (!currentUser || (!currentUser.hasPaid && currentUser.role !== 'admin')) {
    Swal.fire({
      icon: 'warning',
      title: 'ë‹¤ìš´ë¡œë“œ ê¶Œí•œ ì—†ìŒ',
      text: 'ê²°ì œ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.',
      showCancelButton: true,
      showConfirmButton: false,
      cancelButtonText: 'ë‹«ê¸°',
      cancelButtonColor: '#444',
      background: '#1a1a1a',
      color: '#ffffff',
      iconColor: '#FDC512',
      customClass: { actions: 'swal2-actions-center' }
    });
    return;
  }
  const url = `/api/download/${id}?type=${encodeURIComponent(type)}`;
  window.location.href = url;
}

function formatDate(dateString) {
  if(!dateString) return '';
  const d = new Date(dateString);
  if(isNaN(d)) return (dateString.split('T')[0] || dateString);
  return d.toISOString().slice(0, 10);
}

async function showAdminButtons(){
  try{
    const {isLoggedIn,user={}} = await (await fetch('/check-auth',{credentials:'include'})).json();
    if(isLoggedIn){
      currentUser = user;
      if(user.role==='admin'){
        const uploadBtn = document.getElementById('uploadBtn');
        const manageBtn = document.getElementById('manageBtn');
        if(uploadBtn){
          uploadBtn.style.display = 'inline-flex';
          uploadBtn.onclick = ()=> location.href = 'admin_upload.html';
        }
        if(manageBtn){
          manageBtn.style.display = 'inline-flex';
          manageBtn.onclick = () => location.href = 'admin_files.html';
        }
      }
    }
  }catch(e){
    console.error('ê´€ë¦¬ì ì²´í¬ ì‹¤íŒ¨', e);
  }
}

// ğŸ”‘ ë³€ê²½ì : í† ê¸€ ìŠ¤ìœ„ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³€ê²½
document.getElementById('levelToggle').addEventListener('change', function(event) {
  // ìŠ¤ìœ„ì¹˜ê°€ ì²´í¬(ON) ìƒíƒœì´ë©´ 'ì¤‘ë“±', ì•„ë‹ˆë©´ 'ê³ ë“±'ìœ¼ë¡œ ì „í™˜
  if (event.target.checked) {
    switchLevel('ì¤‘ë“±');
  } else {
    switchLevel('ê³ ë“±');
  }
});

// footer ë¡œë“œ
document.addEventListener("DOMContentLoaded", function() {
  fetch('/footer.html')
    .then(response => response.text())
    .then(data => {
      document.body.insertAdjacentHTML('beforeend', data);
    });
});

/* ===== ì‹œì‘ ===== */
window.onload = () => {
  showAdminButtons();
  // ğŸ”‘ ë³€ê²½ì : í˜ì´ì§€ ë¡œë“œ ì‹œ 'ì¤‘ë“±'ì„ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•˜ê³  ë°ì´í„° ë¡œë“œ
  switchLevel('ì¤‘ë“±');
};
</script>

</body>
</html>
