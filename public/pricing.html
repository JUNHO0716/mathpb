<script>
  document.addEventListener('DOMContentLoaded', () => {
    // ★ 테스트 클라이언트키로 교체
    const TOSS_CLIENT_KEY = "test_ck_xxxxxxxxxxxxxxxxx";

    // 엘리먼트
    const mBtn = document.getElementById('mBtn');
    const yBtn = document.getElementById('yBtn');
    const planCards = [...document.querySelectorAll('.plan')];
    const subscribeBtn = document.getElementById('subscribeBtn');
    const agree = document.getElementById('agree');
    const chosen = document.getElementById('chosen');
    const methodChips = [...document.querySelectorAll('.chip')];

    // 상태
    let billingCycle = 'month'; // 'month' | 'year'
    let selected = null;
    let method = 'toss';        // 지금은 토스만 지원

    // 결제수단 토글 (UI만, 실제로는 토스만 동작)
    methodChips.forEach(chip => {
      chip.addEventListener('click', () => {
        methodChips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        method = chip.dataset.method || 'toss';
      });
    });

    // 요금제 카드 선택
    planCards.forEach(card => {
      card.addEventListener('click', () => {
        planCards.forEach(c => c.classList.remove('active'));
        card.classList.add('active');

        const id = card.dataset.plan; // basic | standard | premium(or pro)
        const priceMonth = Number(card.dataset.month);
        const priceYear  = Number(card.dataset.year);

        selected = {
          id,
          price: billingCycle === 'year' ? priceYear : priceMonth
        };

        const title = card.querySelector('.title')?.textContent || id;
        chosen.textContent = `${title} - ${selected.price.toLocaleString()}원 / ${billingCycle === 'year' ? '년' : '월'}`;
        refreshSubscribeBtn();
      });
    });

    // 월/연 전환
    [mBtn, yBtn].forEach(btn => {
      btn.addEventListener('click', () => {
        const month = btn === mBtn;
        mBtn.classList.toggle('active', month);
        yBtn.classList.toggle('active', !month);
        billingCycle = month ? 'month' : 'year';

        const active = document.querySelector('.plan.active');
        if (active) {
          const price = month ? Number(active.dataset.month) : Number(active.dataset.year);
          selected.price = price;
          const title = active.querySelector('.title')?.textContent || selected.id;
          chosen.textContent = `${title} - ${price.toLocaleString()}원 / ${billingCycle === 'year' ? '년' : '월'}`;
        }
        refreshSubscribeBtn();
      });
    });

    agree.addEventListener('change', refreshSubscribeBtn);
    function refreshSubscribeBtn() {
      subscribeBtn.disabled = !(agree.checked && selected);
    }

    // Toss 결제창 열기(로드 대기 포함)
    async function openTossBilling(init) {
      // SDK 로드 대기 (최대 2초)
      for (let i = 0; i < 20 && typeof window.TossPayments === 'undefined'; i++) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (typeof window.TossPayments === 'undefined') {
        alert('결제 모듈이 로드되지 않았습니다. 광고 차단/보안 확장프로그램을 끄고 새로고침 해주세요.');
        return;
      }

      const payments = window.TossPayments(TOSS_CLIENT_KEY);
      const payment  = payments.payment({ customerKey: init.customerKey });

      await payment.requestBillingAuth({
        method: 'CARD',
        amount: { value: 0, currency: 'KRW' }, // 등록창은 0원
        orderId: init.orderId,
        orderName: `${selected.id} ${billingCycle}`,
        customerKey: init.customerKey,
        successUrl: init.successUrl,
        failUrl: init.failUrl
      });
    }

    // 구독 시작하기 클릭
    subscribeBtn.addEventListener('click', async () => {
      if (subscribeBtn.disabled) return;
      if (method !== 'toss') {
        alert('지금은 토스만 지원합니다.');
        return;
      }

      try {
        const res = await fetch('/api/billing/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            plan: selected.id,     // 'basic' | 'standard' | 'pro/premium'
            cycle: billingCycle    // 'month' | 'year'
          })
        });

        if (!res.ok) {
          const msg = await res.text().catch(()=>res.statusText);
          throw new Error(`초기화 실패: ${res.status} ${msg}`);
        }

        const init = await res.json();
        await openTossBilling(init);
      } catch (err) {
        console.error(err);
        alert('결제를 시작할 수 없습니다. 잠시 후 다시 시도하거나 로그인 상태/광고차단기를 확인하세요.');
      }
    });

    // 초기 버튼 상태
    refreshSubscribeBtn();
  });
</script>
