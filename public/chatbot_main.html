<link rel="stylesheet" href="css/chatbot-main.css">

<div class="chatbot-layout">
  <!-- â–· ìµœì´ˆ ë°©ë¬¸ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="chatLoading" class="loading-overlay" aria-busy="true" role="status" style="display:none">
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <div class="loading-text">ì±—ë´‡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
  </div>

  <aside class="chat-history">
    <div class="history-head">
      <h3>ì´ì „ ëŒ€í™”</h3>
      <button id="newChatBtn" type="button" class="new-chat-btn" aria-label="ìƒˆ ëŒ€í™”">+ ìƒˆ ëŒ€í™”</button>
    </div>
    <div id="chatHistoryList"></div>
  </aside>
  <section class="chat-main">
  <!-- ğŸ“¢ ìƒë‹¨ ê³µì§€ -->
  <div class="chat-top-banner">
    <div class="banner-icon">ğŸ“¢</div>
    <div class="banner-text">
      MathPB êµ¬ë…í˜• ì„œë¹„ìŠ¤ ë¦¬ë‰´ì–¼ ì™„ë£Œ! ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ë§Œë‚˜ë³´ì„¸ìš”!
      <span class="banner-date" id="bannerDate"></span>
    </div>
  </div>

  <div class="chat-center" id="chatMessages"></div>
    <!-- ì±„íŒ… ì‹œì‘ í›„: í•˜ë‹¨ ê³ ì • ì…ë ¥ -->
  <div id="chatBottom" class="chat-bottom">
  <form id="chatFormBottom" class="chatbot-form">
    <button type="button" id="chat-attach-btn" class="chat-icon-btn" aria-label="íŒŒì¼ ì²¨ë¶€">
      <i class="fa-solid fa-plus"></i>
    </button>

    <textarea id="chatInputBottom" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" rows="1"></textarea>

    <div class="chat-input-actions">
      <button type="button" id="chat-suggest-btn" class="chat-icon-btn chat-suggest-btn" aria-label="ì¶”ì²œ ì§ˆë¬¸ ë³´ê¸°">
        <i class="fa-solid fa-hashtag"></i>
      </button>
      <button type="submit" id="chat-send-btn" class="chat-icon-btn send" aria-label="ì „ì†¡">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
    </div>
  </form>
  <div id="bottom-suggest-panel" class="suggestion-panel" aria-hidden="true">
  <div class="suggestion-header">
    <span>ì¶”ì²œ ì§ˆë¬¸</span>
    <button id="bottom-close-suggest" aria-label="ë‹«ê¸°">&times;</button>
  </div>
  <div class="suggestion-grid" id="bottom-suggest-grid"></div>
</div>
</div>


<script>
(async function(){
  // --- âœ… ë¡œê·¸ì¸ ì‚¬ìš©ì ì‹ë³„ ë³´ê°•: __USER_IDê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì±„ì›€
async function ensureUserId() {
  if (window.__USER_ID) return window.__USER_ID;
  try {
    const r = await fetch('/check-auth?ts=' + Date.now(), {
      credentials: 'include',
      cache: 'no-store'
    });
    const d = await r.json();
    const u = d?.user || {};
    window.__USER_ID = `u_${u.id ?? ((u.email || '').split('@')[0] || 'unknown')}`;
    return window.__USER_ID;
  } catch {
    // ë¹„ë¡œê·¸ì¸ ëŒ€ë¹„: ê²ŒìŠ¤íŠ¸ ì•„ì´ë””ë¼ë„ ê³ ì •
    let gid = localStorage.getItem('mathpb_guest_id');
    if (!gid) {
      gid = 'g_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('mathpb_guest_id', gid);
    }
    window.__USER_ID = gid;
    return gid;
  }
}

// --- âœ… anon â†’ ì‚¬ìš©ì í‚¤ë¡œ 1íšŒ ìŠ¹ê²©(ìˆì„ ë•Œë§Œ)
function migrateAnonToUserIfNeeded() {
  try {
    const user = window.__USER_ID;
    if (!user || user.startsWith('g_')) return; // ê²ŒìŠ¤íŠ¸ë©´ íŒ¨ìŠ¤
    const anonIndexKey = `mathpb_chat_history_v1:anon:/index.html`;
    const userIndexKey = `mathpb_chat_history_v1:${user}:/index.html`;
    const raw = localStorage.getItem(anonIndexKey);
    if (raw && !localStorage.getItem(userIndexKey)) {
      localStorage.setItem(userIndexKey, raw);
      // í•„ìš”í•˜ë©´ anon í‚¤ ì œê±°:
      // localStorage.removeItem(anonIndexKey);
    }
  } catch {}
}

await ensureUserId();          // âœ… ì‚¬ìš©ì ì‹ë³„ ë¨¼ì € í™•ë³´
migrateAnonToUserIfNeeded();   // âœ… anon ê¸°ë¡ì´ ìˆìœ¼ë©´ ì‚¬ìš©ì í‚¤ë¡œ ìŠ¹ê²©

// âœ… ì‚¬ìš©ìë³„ ìŠ¤ë ˆë“œ ì €ì¥ í‚¤
const THREADS_BASE = 'mathpb_threads_v1';
function getThreadKeys() {
  const user = window.__USER_ID || 'anon';
  return {
    LIST_KEY:   `${THREADS_BASE}:${user}:list`,
    ACTIVE_KEY: `${THREADS_BASE}:${user}:active`,
    // êµ¬ë²„ì „ ë‹¨ì¼ ê¸°ë¡(ë§ˆì´ê·¸ë ˆì´ì…˜ìš©)
    OLD_INDEX_KEY: `mathpb_chat_history_v1:${user}:/index.html`,
    OLD_THIS_KEY:  `mathpb_chat_history_v1:${user}:${location.pathname}`
  };
}

function loadAllThreads() {
  const { LIST_KEY } = getThreadKeys();
  try {
    const raw = localStorage.getItem(LIST_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}
function saveAllThreads(list) {
  const { LIST_KEY } = getThreadKeys();
  try { localStorage.setItem(LIST_KEY, JSON.stringify(list.slice(-200))); } catch {}
}

function getActiveThreadId() {
  const { ACTIVE_KEY } = getThreadKeys();
  return localStorage.getItem(ACTIVE_KEY);
}
function setActiveThreadId(id) {
  const { ACTIVE_KEY } = getThreadKeys();
  localStorage.setItem(ACTIVE_KEY, id || '');
}

function getActiveThread() {
  const id = getActiveThreadId();
  const list = loadAllThreads();
  return list.find(t => t.id === id) || null;
}
function upsertThread(thread) {
  const list = loadAllThreads();
  const i = list.findIndex(t => t.id === thread.id);
  if (i >= 0) list[i] = thread; else list.push(thread);
  saveAllThreads(list);
}

function startNewThread() {
  // â–¶ ì•„ì§ ì‚¬ìš©ìê°€ ì•„ë¬´ê²ƒë„ ì•ˆ ì¹œ ìƒíƒœ: draft=true
  const t = { id: 'thread_' + Date.now(), title: 'ìƒˆ ëŒ€í™”', created: Date.now(), messages: [], draft: true };
  upsertThread(t);
  setActiveThreadId(t.id);
  return t;
}

// â¬‡ êµ¬ë²„ì „ ë‹¨ì¼ ê¸°ë¡ â†’ ìŠ¤ë ˆë“œ 1ê°œë¡œ 1íšŒ ìŠ¹ê²©
function migrateSingleHistoryToThreadsOnce() {
  const threads = loadAllThreads();
  if (threads.length) return; // ì´ë¯¸ ìŠ¤ë ˆë“œ ì‚¬ìš© ì¤‘

  const { OLD_INDEX_KEY, OLD_THIS_KEY } = getThreadKeys();
  const raw = localStorage.getItem(OLD_INDEX_KEY) || localStorage.getItem(OLD_THIS_KEY);
  if (!raw) return;

  try {
    const msgs = JSON.parse(raw);
    if (!Array.isArray(msgs) || !msgs.length) return;
    const firstUser = msgs.find(m => m.role === 'user');
    const title = (firstUser?.content || 'ì´ì „ ëŒ€í™”').split('\n')[0].slice(0, 30);
    const t = {
      id: 'thread_' + Date.now(),
      title, created: msgs[0]?.time || Date.now(),
      messages: msgs
    };
    saveAllThreads([t]);
    setActiveThreadId(t.id);
  } catch {}
}

  const msgBox    = document.getElementById('chatMessages');
  const formBot   = document.getElementById('chatFormBottom');
  const bottomBar = document.getElementById('chatBottom');
  const list      = document.getElementById('chatHistoryList');
  const loadingEl = document.getElementById('chatLoading');

 function getBotAvatar(){
  return localStorage.getItem('mathpb_bot_avatar')
         || '/image_logo/mybot.png'; // â† indexì™€ ë™ì¼ ê¸°ë³¸ê°’
}

  /* â–· ì…ë ¥ì°½: ë¹„ì—ˆì„ ë•Œ + / ë‚´ìš© ìˆìœ¼ë©´ â†‘ í† ê¸€ + ìë™ ë†’ì´ */
  function wireFormBehavior(form){
    if(!form) return;
    const ta = form.querySelector('textarea');
    const update = ()=>{
      const has = !!ta.value.trim();
      form.classList.toggle('has-text', has);  // css/chatbot-main.cssì˜ .has-text ê·œì¹™ ì‚¬ìš©
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 4*24 + 22) + 'px';
    };
    ta.addEventListener('input', update);
    update();
  }

  /* â–· ë¡œë”© ì˜¤ë²„ë ˆì´/ìŠ¤ì¼ˆë ˆí†¤ */
  function showLoading(){
    if(loadingEl) loadingEl.style.display = 'flex';

    // ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼ˆë ˆí†¤
    list.innerHTML = Array.from({length:6}).map(()=>(
      `<div class="skeleton-item">
         <div class="skel skel-line" style="width:60%"></div>
         <div class="skel skel-line" style="width:80%"></div>
       </div>`
    )).join('');

    // ìš°ì¸¡ ë©”ì‹œì§€ ìŠ¤ì¼ˆë ˆí†¤
    msgBox.innerHTML =
      `<div class="chat-skel-row"><div class="skel skel-line" style="width:70%"></div></div>
       <div class="chat-skel-row"><div class="skel skel-line" style="width:55%"></div></div>
       <div class="chat-skel-row"><div class="skel skel-line" style="width:62%"></div></div>`;
  }
  function hideLoading(){ if(loadingEl) loadingEl.style.display = 'none'; }

// === typewriter ìœ í‹¸ ===
function escapeHTML(s){ return (s||"").replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }
function createTypewriter(targetEl, { speed=16 } = {}) {
  let buf = "";
  let tick = null;
  const pump = () => {
    if (!buf.length) return;
    const ch = buf[0];
    buf = buf.slice(1);
    targetEl.insertAdjacentHTML('beforeend', ch === '\n' ? '<br>' : escapeHTML(ch));
  };
  tick = setInterval(pump, speed);
  return {
    push(text){ if (text) buf += text; },
    async done(){
      return new Promise((res)=>{
        const wait = setInterval(()=>{
          if (!buf.length){
            clearInterval(wait); clearInterval(tick);
            res();
          }
        }, speed);
      });
    }
  };
}


async function renderMessages() {
  let t = getActiveThread();
  if (!t) t = startNewThread();

  msgBox.innerHTML = '';

  // ë¹ˆ ìŠ¤ë ˆë“œë©´ íˆì–´ë¡œ ì…ë ¥ì°½
  if (!t.messages.length) {
    bottomBar.style.display = 'none';
    msgBox.innerHTML = `
      <div class="chat-hero">
        <h1 class="hero-title">ì–´ë””ì„œë¶€í„° ì‹œì‘í• ê¹Œìš”?</h1>
        <form id="chatFormCenter" class="chatbot-form hero-form" autocomplete="off">
          <button type="button" id="hero-attach-btn" class="chat-icon-btn" aria-label="íŒŒì¼ ì²¨ë¶€">ï¼‹</button>
          <textarea id="chatInputCenter" rows="1" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" autocomplete="off"></textarea>
          <div class="chat-input-actions hero-actions">
            <button type="button" id="hero-suggest-btn" class="chat-icon-btn chat-suggest-btn" aria-label="ì¶”ì²œ">#</button>
            <button type="submit" id="hero-send-btn" class="chat-icon-btn chat-send-btn" aria-label="ì „ì†¡"><span class="arrow-up">â†‘</span></button>
          </div>
        </form>
      </div>`;
    // íˆì–´ë¡œ í¼ ì´ˆê¸°í™” ì§í›„
    const nf = msgBox.querySelector('#chatFormCenter');
    const ni = msgBox.querySelector('#chatInputCenter');
    wireFormBehavior(nf);
    bindSuggest(nf);

    // âœ… Enter=ì „ì†¡ / Shift+Enter=ì¤„ë°”ê¿ˆ
    ni.addEventListener('keydown', (e) => {
      if (e.isComposing) return;
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const v = ni.value.trim();
        if (v) { ni.value = ''; send(v); }
      }
    });

    // ë²„íŠ¼(â†‘) ì „ì†¡ë„ ë™ì¼ ë™ì‘
    nf.addEventListener('submit', e => { 
      e.preventDefault(); 
      const v = ni.value.trim(); 
      if (!v) return;
      ni.value = ''; 
      send(v); 
    });
    return;
  }

  // ë©”ì‹œì§€ ë Œë”
  bottomBar.style.display = 'block';
  const avatarUrl = getBotAvatar();
  t.messages.forEach(m => {
    const row = document.createElement('div');
    if (m.role === 'user') {
      row.className = 'chat-message user';
      row.innerHTML = `<div class="bubble">${m.content}</div>`;
    } else {
      row.className = 'chat-message bot';
      row.innerHTML = `<div class="avatar" style="background-image:url('${avatarUrl}');"></div>
                       <div class="bubble">${m.content}</div>`;
    }
    msgBox.appendChild(row);
  });

  requestAnimationFrame(()=>{ msgBox.scrollTop = msgBox.scrollHeight; });
}

function renderHistoryList() {
  // â–¶ user / bot ë©”ì‹œì§€ê°€ ëª¨ë‘ ìˆê³  draft=false ì¸ ê²ƒë§Œ ë…¸ì¶œ
  const threads = loadAllThreads()
    .filter(t => !t.draft && t.messages?.some(m=>m.role==='user') && t.messages?.some(m=>m.role==='bot'))
    .sort((a,b)=>b.created - a.created);
  const activeId = getActiveThreadId();

  if (!threads.length) {
    list.innerHTML = `<div class="chat-thread empty">ì´ì „ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
    return;
  }

  list.innerHTML = threads.map(t => {
    const first = t.messages.find(m=>m.role==='user') || t.messages[0] || {};
    const sub = (first?.content || '').replace(/\n/g,' ').slice(0, 42);
    const time = new Date(t.created).toLocaleString();
    const active = t.id === activeId ? ' active' : '';
    return `
      <div class="chat-thread${active}" data-id="${t.id}">
        <div class="t-main">
          <div class="t-title" title="${t.title}">${t.title}</div>
          <div class="t-sub">${sub}</div>
          <div class="t-time">${time}</div>
        </div>
        <div class="item-actions">
          <button class="icon-btn rename" title="ì œëª© ë°”ê¾¸ê¸°" aria-label="ì œëª© ë°”ê¾¸ê¸°">âœ</button>
          <button class="icon-btn delete" title="ì‚­ì œ" aria-label="ì‚­ì œ">ğŸ—‘</button>
        </div>
      </div>
    `;
  }).join('');

  // í•­ëª© í´ë¦­ â†’ ìŠ¤ë ˆë“œ ì—´ê¸°
  list.querySelectorAll('.chat-thread').forEach(el => {
    const id = el.dataset.id;
    el.addEventListener('click', (e) => {
      if (e.target.closest('.item-actions')) return; // ë²„íŠ¼ ì˜ì—­ í´ë¦­ì€ ë¬´ì‹œ
      setActiveThreadId(id);
      renderMessages();
      renderHistoryList();
    });
  });

  // ì œëª© ë°”ê¾¸ê¸°
  list.querySelectorAll('.icon-btn.rename').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const wrap = btn.closest('.chat-thread');
      const id = wrap.dataset.id;
      const threads = loadAllThreads();
      const t = threads.find(x=>x.id===id); if(!t) return;
      const name = prompt('ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', t.title);
      if (!name) return;
      t.title = name.trim().slice(0, 60) || t.title;
      saveAllThreads(threads);
      renderHistoryList();
    });
  });

  // ì‚­ì œ
  list.querySelectorAll('.icon-btn.delete').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const wrap = btn.closest('.chat-thread');
      const id = wrap.dataset.id;
      if (!confirm('ì´ ëŒ€í™”ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

      const threads = loadAllThreads().filter(x=>x.id!==id);
      saveAllThreads(threads);

      if (getActiveThreadId()===id) {
        setActiveThreadId(threads[0]?.id || '');
        if (!threads.length) startNewThread();
      }
      renderMessages();
      renderHistoryList();
    });
  });
}

async function send(text){
  if(!text || !text.trim()) return;
  const q = text.trim();

  // í™œì„± ìŠ¤ë ˆë“œ í™•ë³´
  let t = getActiveThread();
  if (!t) t = startNewThread();

  // ì²« ì‚¬ìš©ì ë©”ì‹œì§€ â†’ ì œëª© ìë™
  if (t.title === 'ìƒˆ ëŒ€í™”') {
    t.title = q.split('\n')[0].slice(0, 30) || 'ìƒˆ ëŒ€í™”';
  }

  // ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
  t.messages.push({ role:'user', content:q, time:Date.now() });
  upsertThread(t);
  renderMessages(); renderHistoryList();

  try {
    // íƒ€ì´í•‘(â€¦)
    const typingEl = document.createElement('div');
    typingEl.className = 'chat-message bot typing';
    typingEl.innerHTML = `<div class="avatar" style="background-image:url('${getBotAvatar()}');"></div>
                          <div class="bubble typing"><span class="dots"><i></i><i></i><i></i></span></div>`;
    msgBox.appendChild(typingEl);
    msgBox.scrollTop = msgBox.scrollHeight;

// âœ… ì˜¬ë°”ë¥¸ ë°”ë”” í˜•ì‹ìœ¼ë¡œ ì „ì†¡
const res = await fetch('/api/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include',
  body: JSON.stringify({ messages: [{ role: 'user', content: q }] })
});

let botText = '';
const reader = res.body && res.body.getReader ? res.body.getReader() : null;

const bubble = typingEl.querySelector('.bubble');
typingEl.classList.remove('typing');
bubble.classList.remove('typing');
bubble.innerHTML = '';
const tw = createTypewriter(bubble, { speed: 16 });

// ë‹¤ì–‘í•œ ì„œë²„ í¬ë§·ì„ ìˆ˜ìš©í•˜ëŠ” ì¶”ì¶œê¸°
const pick = (j) => {
  if (j == null) return '';
  if (typeof j === 'string') return j;
  if (j.output_text) return j.output_text;
  if (j.text) return j.text;
  if (j.content) return j.content;
  if (j.message && j.message.content) return j.message.content;
  if (j.delta && j.delta.content) return j.delta.content;
  if (Array.isArray(j.choices) && j.choices[0]) {
    const c = j.choices[0];
    if (c.delta && c.delta.content) return c.delta.content;
    if (c.message && c.message.content) return c.message.content;
    if (c.text) return c.text;
  }
  return '';
};

if (reader) {
  const decoder = new TextDecoder('utf-8');
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value, { stream: true });
    for (const line of chunk.split('\n')) {
      if (!line.startsWith('data: ')) continue;
      const data = line.slice(6).trim();
      if (!data || data === '[DONE]') continue;
      try {
        const j = JSON.parse(data);
        const piece = pick(j);
        if (piece) { botText += piece; tw.push(piece); }
      } catch {}
    }
  }
} else {
  const j = await res.json();
  botText = pick(j);
  if (botText) tw.push(botText);
}


// ë‚¨ì€ ë²„í¼ ëª¨ë‘ ì¶œë ¥ë  ë•Œê¹Œì§€ ëŒ€ê¸°
await tw.done();

const finalOut = botText?.trim() ? botText : 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.';
// ì €ì¥/íˆìŠ¤í† ë¦¬ ê°±ì‹ ì€ ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ ì•„ë˜ ìœ ì§€


    // âœ… ì €ì¥
    t = getActiveThread() || t;
    t.messages.push({ role:'bot', content: finalOut, time: Date.now() }); // â¬… finalOut ì‚¬ìš©
    t.draft = false;
    upsertThread(t);
    renderMessages(); renderHistoryList();


  } catch (e) {
    t.messages.push({ role:'bot', content:'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', time:Date.now() });
    // â–¶ ì˜¤ë¥˜ ë©”ì‹œì§€ë¼ë„ â€˜ë‹µë³€ì„ ë°›ì€ ê²½ìš°â€™ë¡œ ê°„ì£¼ â†’ draft í•´ì œ
    t.draft = false;
    upsertThread(t);
    renderMessages(); renderHistoryList();
  }
}

  if(formBot){
    wireFormBehavior(formBot);
    formBot.addEventListener('submit',e=>{
      e.preventDefault();
      const ta=formBot.querySelector('textarea');
      const v = ta.value.trim();
      if (!v) return;
      ta.value = '';
      formBot.classList.remove('has-text');   // â¬… ì „ì†¡ í›„ # ì•„ì´ì½˜ ë‹¤ì‹œ ë³´ì´ê²Œ
      send(v);
    });
  }

    // âœ… Enterë¡œ ì „ì†¡, Shift+Enterë¡œ ì¤„ë°”ê¿ˆ
  const chatInput = document.getElementById('chatInputBottom');
  if (chatInput) {
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const form = document.getElementById('chatFormBottom');
        const ta = form.querySelector('textarea');
        const text = ta.value.trim();
        if (text) {
          ta.value = '';
          form.classList.remove('has-text');
          send(text);
        }
      }
    });
  }
  
// â–¼ ì „ì—­ ë“œë¡­ë‹¤ìš´ 1ê°œë§Œ ì¬ì‚¬ìš©
let __suggestDD = null;
let __ddClickBound = false;
const SUGG_KEY = 'mathpb_suggestions_v1';

function ensureDropdown(){
  if (!__suggestDD) {
    __suggestDD = document.getElementById('hero-suggest-dropdown');
    if (!__suggestDD) {
      __suggestDD = document.createElement('div');
      __suggestDD.id = 'hero-suggest-dropdown';
      __suggestDD.className = 'hero-suggest-dropdown';
      __suggestDD.hidden = true;
    }
  }
  // âœ… í•­ìƒ body ì§ì† + ê³ ì • ì¢Œí‘œê³„
  if (__suggestDD.parentElement !== document.body) {
    document.body.appendChild(__suggestDD);
  }
  __suggestDD.style.position = 'fixed';
  return __suggestDD;
}


function getSuggestions(){
  try {
    const raw = localStorage.getItem(SUGG_KEY);
    const arr = raw ? JSON.parse(raw) : null;
    return (Array.isArray(arr) && arr.length) ? arr :
      ["ì‹œí—˜ì§€ ìš”ì²­","ê³µì§€ì‚¬í•­ ë³´ê¸°","ê²°ì œìƒíƒœ í™•ì¸","ì‹œí—˜ì§€ ì°¾ê¸°","ë‚´ ì±…ì¥ ì‚¬ìš©ë²•","êµ¬ë… í”Œëœ ì•ˆë‚´"];
  } catch {
    return ["ì‹œí—˜ì§€ ìš”ì²­","ê³µì§€ì‚¬í•­ ë³´ê¸°","ê²°ì œìƒíƒœ í™•ì¸","ì‹œí—˜ì§€ ì°¾ê¸°","ë‚´ ì±…ì¥ ì‚¬ìš©ë²•","êµ¬ë… í”Œëœ ì•ˆë‚´"];
  }
}

function bindSuggest(form){
  if (!form) return;
  const input = form.querySelector('textarea');
  const btn   = form.querySelector('.chat-suggest-btn, #chat-suggest-btn'); // â¬… id/í´ë˜ìŠ¤ ëª¨ë‘ ëŒ€ì‘
  if (!input || !btn) return;

// â–¼ í•˜ë‹¨ ì…ë ¥ì°½ë„ ì „ì—­ ë“œë¡­ë‹¤ìš´ ì¬ì‚¬ìš© (íˆì–´ë¡œì™€ ë™ì¼í•œ dd ì‚¬ìš©)
if (form.id === 'chatFormBottom') {
  const dd = ensureDropdown();          // body ì§ì†, position:fixed
  let _bound = false;

  function openBottomDD(){
    const items = getSuggestions();
    dd.innerHTML = items.map(t => `<button class="hero-suggest-chip" data-t="${t}">${t}</button>`).join('');

    dd.hidden = false;
    dd.style.position = 'fixed';
    dd.style.opacity = '0';
    dd.style.transform = 'translateY(6px)';
    dd.style.transition = 'opacity .18s ease, transform .18s ease';

    const r = btn.getBoundingClientRect();

    requestAnimationFrame(()=>{
      const h = dd.offsetHeight || 0;
      const w = dd.offsetWidth  || 0;

      // â–¶ íŒ¨ë„ ìš°í•˜ë‹¨ì„ # ë²„íŠ¼ ìœ„ìª½ì— ë§ì¶¤ (ì˜¤ë¥¸ìª½ ì •ë ¬)
      let left = Math.round(r.right - w);
      left = Math.max(16, Math.min(left, window.innerWidth - w - 16));

      dd.style.left = left + 'px';
      dd.style.top  = Math.max(8, Math.round(r.top - h - 8)) + 'px';
      dd.style.opacity = '1';
      dd.style.transform = 'translateY(0)';
    });

    dd.querySelectorAll('.hero-suggest-chip').forEach(b=>{
      b.addEventListener('click', ()=>{
        input.value = b.dataset.t;
        form.classList.add('has-text'); // # â†’ â†‘ í† ê¸€
        input.focus();
        closeBottomDD();
      });
    });

    if (!_bound) {
      document.addEventListener('click', (ev)=>{
        const clickedBtn = ev.target.closest('.chat-suggest-btn, #chat-suggest-btn'); // âœ… ë²„íŠ¼ ë‚´ë¶€ ì•„ì´ì½˜ë„ í—ˆìš©
        if (!dd.hidden && !dd.contains(ev.target) && !clickedBtn) {
          closeBottomDD();
        }
      });
      _bound = true;
    }
  }

  function closeBottomDD(){
    dd.style.opacity = '0';
    dd.style.transform = 'translateY(6px)';
    setTimeout(()=>{ dd.hidden = true; }, 180);
  }

  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    (dd.hidden ? openBottomDD : closeBottomDD)();
  });

  // â›” íŒ¨ë„ ë°©ì‹ ë°˜í™˜ ì œê±° (ì „ì—­ dd ë¡œì§ë„ ì´ì–´ì„œ ì‚¬ìš©)
  return;
}
  
const chatForm = document.getElementById('chatFormBottom');
const chatInput = document.getElementById('chatInputBottom');

if (chatInput && chatForm) {
  chatInput.addEventListener('input', () => {
    const hasText = chatInput.value.trim().length > 0;
    chatForm.classList.toggle('has-text', hasText);
  });
}

const dd = ensureDropdown();
let __ddClickBound = false;

function openDropdown(){
  const items = getSuggestions();
  dd.innerHTML = items.map(t => `<button class="hero-suggest-chip" data-t="${t}">${t}</button>`).join('');

  dd.hidden = false;
  dd.style.position = 'fixed';
  dd.style.right = '';      // âœ… í˜¹ì‹œ ë‚¨ì•„ìˆì„ ê°’ ì´ˆê¸°í™”
  dd.style.bottom = '';
  dd.style.opacity = '0';
  dd.style.transform = 'translateY(6px)';
  dd.style.transition = 'opacity .18s ease, transform .18s ease';

  const r = btn.getBoundingClientRect();

  requestAnimationFrame(()=>{
    const h = dd.offsetHeight || 0;
    const w = dd.offsetWidth  || 0;

    // ì˜¤ë¥¸ìª½ ì •ë ¬: íŒ¨ë„ right == ë²„íŠ¼ right
    let left = Math.round(r.right - w);
    // í™”ë©´ ë°–ìœ¼ë¡œ íŠ€ì§€ ì•Šë„ë¡ í´ë¨í”„
    left = Math.max(16, Math.min(left, window.innerWidth - w - 16));

    dd.style.left = left + 'px';
    dd.style.top  = Math.max(8, Math.round(r.top - h - 8)) + 'px'; // ë²„íŠ¼ ìœ„ 8px
    dd.style.opacity = '1';
    dd.style.transform = 'translateY(0)';
  });


  // ì„ íƒì‹œ ì…ë ¥ì°½ìœ¼ë¡œ ë°˜ì˜
  dd.querySelectorAll('.hero-suggest-chip').forEach(b=>{
    b.addEventListener('click', ()=>{
      input.value = b.dataset.t;
      form.classList.add('has-text');
      input.focus();
      closeDropdown();
    });
  });

  // ë°”ê¹¥ í´ë¦­ìœ¼ë¡œ ë‹«ê¸° (1íšŒë§Œ ë°”ì¸ë”©)
  if (!__ddClickBound) {
    document.addEventListener('click', (ev)=>{
      const clickedBtn = ev.target.closest('.chat-suggest-btn, #chat-suggest-btn'); // âœ… ë²„íŠ¼ ë‚´ë¶€ í´ë¦­ ì˜ˆì™¸
      if (!dd.hidden && !dd.contains(ev.target) && !clickedBtn) {
        closeDropdown();
      }
    });
    __ddClickBound = true;
  }
}

function closeDropdown(){
  dd.style.opacity = '0';
  dd.style.transform = 'translateY(6px)';
  setTimeout(()=>{ dd.hidden = true; }, 180);
}

btn.addEventListener('click', (e)=>{
  e.preventDefault();
  dd.hidden ? openDropdown() : closeDropdown();
});

}

// (ì´ ì¤„ì„ showLoading() í˜¸ì¶œ "ì•"ì— ë„£ì–´ì£¼ì„¸ìš”)
const SESSION_FLAG = `mathpb_chat_session_started:${window.__USER_ID}`;
if (!sessionStorage.getItem(SESSION_FLAG)) {
  startNewThread();                       // â† ì´ì œ ìŠ¤ì½”í”„ ì•ˆì´ë¼ ì°¸ì¡° ê°€ëŠ¥
  sessionStorage.setItem(SESSION_FLAG, '1');
}

// (IIFE ë‚´ë¶€ì˜ ê°€ì¥ ë§ˆì§€ë§‰ ìª½, storage ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì´í›„ ë“±)ì— ë„£ê¸°
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('#newChatBtn');
  if (!btn) return;
  e.preventDefault();

  startNewThread();        // â† ìŠ¤ì½”í”„ OK
  renderMessages();
  renderHistoryList();
  setTimeout(()=> document.getElementById('chatInputCenter')?.focus(), 0);
});

// â–· ìµœì´ˆ ì§„ì… ì‹œ: í•˜ë‹¨ í¼ì—ë„ ë°”ì¸ë”©
bindSuggest(document.getElementById('chatFormBottom'));

  // ìµœì´ˆ ì§„ì…: ë¡œë”© â†’ ë Œë” â†’ ë¡œë”© ì¢…ë£Œ
  showLoading();
  await renderMessages();
  renderHistoryList();
  hideLoading();
  // âœ… index/ë‹¤ë¥¸ íƒ­ì—ì„œ ë³€ê²½ë˜ë©´ ì¦‰ì‹œ ê°±ì‹  (ìŠ¤ë ˆë“œ í‚¤ ê¸°ì¤€)
  window.addEventListener('storage', (e) => {
    const k = e.key || '';
    if (k.startsWith(THREADS_BASE)) {
      try {
        renderMessages();
        renderHistoryList();
      } catch {}
    }
  });

  })();

  // ë°°ë„ˆ ë‚ ì§œ ì„¸íŒ…
  (function(){
    const dateEl = document.getElementById('bannerDate');
    if (!dateEl) return;
    const today = new Date();
    const formatted = today.getFullYear() + '.' +
                      String(today.getMonth()+1).padStart(2,'0') + '.' +
                      String(today.getDate()).padStart(2,'0');
    dateEl.textContent = formatted;
  })();


</script>

