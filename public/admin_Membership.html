<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex, nofollow">
  <title>íšŒì›ê´€ë¦¬ & í†µê³„ | ê´€ë¦¬ìí˜ì´ì§€</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 40px;
      box-sizing: border-box;
    }
    h1 {
      font-size: 24px;
      margin: 0 0 20px;
    }

    /* ===== ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ ===== */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15,23,42,0.06);
    }

    /* ===== KPI ì¹´ë“œ í–‰ ===== */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15,23,42,0.04);
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 80px;
    }
    .kpi-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .kpi-value {
      font-size: 22px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    .kpi-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    /* ===== ë©”ì¸ ë ˆì´ì•„ì›ƒ (ê·¸ë˜í”„ + ì‚¬ì´ë“œ ì¹´ë“œ) ===== */
    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 1.4fr);
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 24px;
    }
    .main-left {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .main-right {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ===== ê·¸ë˜í”„ ì¹´ë“œ ===== */
    .chart-card {
      min-height: 280px;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .chart-title {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
    }
    .chart-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .chart-series {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #374151;
    }
    .chart-series label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 9999px;
      background: #f3f4f6;
    }
    .chart-range-select {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 9999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }
    .chart-body {
      margin-top: 6px;
      height: 240px;
    }
    #userChart {
      width: 100%;
      height: 100%;
    }

    /* ===== ì‚¬ì´ë“œ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ===== */
    .side-card h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 8px;
      color: #111827;
    }
    .side-card-sub {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .side-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    .side-list li {
      font-size: 12px;
      color: #374151;
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }
    .side-list li:last-child {
      border-bottom: none;
    }
    .side-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 9999px;
      background: #eef2ff;
      color: #4338ca;
      white-space: nowrap;
    }
    .side-id {
      font-weight: 500;
      color: #111827;
    }
    .side-empty {
      font-size: 12px;
      color: #9ca3af;
      padding: 4px 0;
    }

    /* ===== íƒ­ ì¹´ë“œ ===== */
    .tabs-card {
      padding: 0;
    }
    .tab-header {
      display: flex;
      gap: 4px;
      padding: 0 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .tab-btn {
      border: none;
      background: transparent;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      color: #6b7280;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active {
      color: #111827;
      font-weight: 600;
      border-bottom-color: #3b82f6;
    }
    .tab-body {
      padding: 14px 18px 18px;
    }
    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }

/* ===== ê²€ìƒ‰ë°” / í…Œì´ë¸” (íšŒì› ë¦¬ìŠ¤íŠ¸ìš© ì¹´ë“œí˜• ìŠ¤íƒ€ì¼) ===== */
    .search-bar {
      margin-bottom: 20px;
      display: flex;              /* ê°™ì€ ì¤„ì— ë°°ì¹˜ */
      align-items: center;
      justify-content: space-between;  /* ì™¼ìª½: ê²€ìƒ‰ + í”Œëœí•„í„°, ì˜¤ë¥¸ìª½: ê´€ë¦¬ì ë³´ê¸° */
      gap: 12px;
      width: 100%;                /* ì „ì²´ í­ ì‚¬ìš©í•´ì„œ ê´€ë¦¬ì ë³´ê¸°ê°€ ë§¨ ì˜¤ë¥¸ìª½ìœ¼ë¡œ */
    }
    .search-left {
      display: flex;
      align-items: center;
      gap: 8px;      /* ê²€ìƒ‰ì°½ê³¼ í”Œëœ í•„í„° ì‚¬ì´ ê°„ê²© */
      flex: 1;
    }

    .search-plan-select {
      padding: 7px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #374151;
    }
    .search-bar input {
      padding: 8px 12px;
      width: 300px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .search-admin-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: #4b5563;
      cursor: pointer;
      user-select: none;
    }
    .search-admin-toggle input[type="checkbox"] {
      margin: 0;
      width: 14px;
      height: 14px;
    }
    /* íšŒì› ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸”ì„ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ì²˜ëŸ¼ ë³´ì´ê²Œ */
    #userTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px; /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
      background: transparent;
      border: none;
    }
    #userTable thead {
      display: none; /* ì•„ì´ë””/ì´ë©”ì¼/ì´ë¦„ í—¤ë” í–‰ ìˆ¨ê¹€ */
    }
    #userTable tbody tr {
      border: none;
    }
    #userTable td {
      padding: 0;
      border: none;
      text-align: left;
      font-size: 13px;
    }
    /* ===== íšŒì› ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ===== */
    .user-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(15,23,42,0.04);
    }
    .user-main {
      flex: 1;
      min-width: 0;
      display: grid;
      /* 6ê°œ ì»¬ëŸ¼: ì•„ë°”íƒ€ / ì•„ì´ë””+ì´ë©”ì¼ / ì´ë¦„+ê´€ë¦¬ì / ê°€ì…+êµ¬ë…ìƒíƒœ / í”Œëœ / ê¸°ê°„ */
      grid-template-columns:
        auto                 /* í”„ë¡œí•„ ì´ë¯¸ì§€ */
        minmax(0, 260px)     /* ì•„ì´ë”” + ì´ë©”ì¼ (ì¡°ê¸ˆ ë„“ê²Œ) */
        minmax(0, 120px)     /* ì´ë¦„ + ê´€ë¦¬ì ë°°ì§€ */
        minmax(0, 140px)     /* ê°€ì…ì¼ + êµ¬ë… ìƒíƒœ */
        minmax(0, 130px)     /* êµ¬ë… í”Œëœ ì…€ë ‰íŠ¸ */
        minmax(0, 180px);    /* ì‹œì‘ì¼ / ì¢…ë£Œì¼ */
      column-gap: 20px;
      align-items: center;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      overflow: hidden;
      background: #e5e7eb;
      flex-shrink: 0;
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .user-id-email {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      min-width: 130px;
    }
    .user-id-email .uid {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 220px;  /* ì•„ì´ë”” ì¡°ê¸ˆ ë” ê¸¸ê²Œ */
    }
    .user-id-email .uemail {
      color: #6b7280;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 220px;
    }
    .user-name {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
      color: #111827;
      min-width: 60px;
      white-space: nowrap;
    }
    .user-name .name-line {
      font-weight: 500;
    }
    .user-name .admin-tag {
      align-self: flex-start;
      margin-left: 0;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      font-size: 11px;
    }
    .user-join-sub {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      color: #4b5563;
      min-width: 120px;
    }
    .user-join-sub .join {
      font-weight: 500;
    }
    .user-join-sub .substate-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 11px;
      width: fit-content;
    }
    .user-join-sub .substate-pill.on {
      background: #ecfdf3;
      color: #166534;
    }
    .user-plan {
      min-width: 120px;
    }
    .user-plan select {
      width: 100%;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }
    .user-period {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      color: #4b5563;
      min-width: 140px;
    }
    .user-period span {
      white-space: nowrap;
    }

    .user-more-wrap {
      position: relative;
      flex-shrink: 0;
    }
    .more-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent; /* íšŒìƒ‰ ë™ê·¸ë¼ë¯¸ ì œê±° */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .more-btn:hover {
      background: transparent; /* hover ë•Œë„ ë°°ê²½ ì—†ìŒ */
      transform: none;
    }
    .more-btn-icon {
      font-size: 18px;
      line-height: 1;
    }
    .more-menu {
      position: absolute;
      top: 34px;
      right: 0;
      min-width: 150px;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(15,23,42,0.16);
      padding: 6px 0;
      z-index: 20;
      display: none;
    }
    .more-menu.open {
      display: block;
    }
    .more-menu-item {
      padding: 7px 12px;
      font-size: 12px;
      color: #374151;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    .more-menu-item:hover {
      background: #f3f4ff;
      color: #1d4ed8;
    }
    .more-menu-item.danger {
      color: #b91c1c;
    }
    .more-menu-item.danger:hover {
      background: #fef2f2;
      color: #b91c1c;
    }
    .more-menu-item .label {
      flex: 1;
    }

    .btn {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-extend {
      background: #4CAF50;
      color: #fff;
    }
    .btn-cancel {
      background: #f44336;
      color: #fff;
    }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
    }
    .modal {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 300px;
      margin: 150px auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-buttons {
      text-align: right;
      margin-top: 20px;
    }
    .modal-buttons button {
      margin-left: 8px;
    }

    /* â–¼â–¼ ì¶”ê°€: ê¶Œí•œ/í”Œëœ/êµ¬ë… ë°°ì§€ (ê¸°ì¡´ ìœ ì§€) */
    .role-badge {
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid #ddd;
      display: inline-block;
      margin-right: 6px;
      font-size: 12px;
    }
    .role-admin {
      background: #eef5ff;
    }
    .role-user {
      background: #f6f6f6;
    }
    .plan-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      margin-right: 6px;
      display: inline-block;
    }
    .plan-basic {
      background: #f3f4f6;
      color: #6b7280;
    }
    .plan-standard {
      background: #eafaf1;
      color: #15803d;
      border-color: #ccebd8;
    }
    .plan-pro {
      background: #eef2ff;
      color: #4338ca;
      border-color: #d9ddff;
    }
    .substate {
      font-size: 12px;
      color: #6b7280;
    }
    .substate.on {
      color: #16a34a;
    }

    /* ===== ë¡œë”© ìŠ¤í”¼ë„ˆ ===== */
    #loadingArea {
      display: none;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
    }
    .loader {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 4px solid #e5e7eb;
      border-top-color: #3f5ba9;
      animation: spin 0.9s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== íƒ­ ì•ˆì˜ ì•ˆë‚´ í…ìŠ¤íŠ¸ ===== */
    .placeholder-text {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.6;
    }

    /* ê° ì˜ì—­ì´ ì¤„ ì•ˆ ë„˜ì¹˜ê²Œ ê³µí†µ ì„¤ì • */
.user-id-email,
.user-name-block,
.user-join-sub,
.user-period {
  min-width: 0;
}

/* í•œ ì¤„ + ë§ì¤„ì„ ì²˜ë¦¬ */
.user-id-email .uid,
.user-id-email .uemail,
.user-name-block .uname,
.user-name-block .role-line,
.user-join-sub div,
.user-period div {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* í”Œëœ ì…€ë ‰íŠ¸ ê³ ì • í­ */
.user-plan {
  min-width: 130px;
}
.user-plan select {
  width: 100%;
}
  </style>
</head>
<body>
  <h1>íšŒì› ê´€ë¦¬ & í†µê³„</h1>

  <!-- ===== ìƒë‹¨ KPI ì¹´ë“œ 6ê°œ ===== -->
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-label">ì˜¤ëŠ˜ ë°©ë¬¸ììˆ˜</div>
      <div class="kpi-value" id="kpiTodayVisitors">-</div>
      <div class="kpi-sub" id="kpiTodayVisitorsSub">ë¡œê·¸ ì—°ë™ í›„ í‘œì‹œ</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">ì˜¤ëŠ˜ ê°€ì…ìˆ˜</div>
      <div class="kpi-value" id="kpiTodaySignups">-</div>
      <div class="kpi-sub" id="kpiTodaySignupsSub">íšŒì› ê°€ì…ì¼ ê¸°ì¤€</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">í™œì„± íšŒì› ìˆ˜ (ìµœê·¼ 30ì¼ ë¡œê·¸ì¸)</div>
      <div class="kpi-value" id="kpiActiveUsers">-</div>
      <div class="kpi-sub" id="kpiActiveUsersSub">last_login í•„ë“œ ê¸°ì¤€</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">êµ¬ë… ì¤‘ íšŒì› ìˆ˜</div>
      <div class="kpi-value" id="kpiSubscribers">-</div>
      <div class="kpi-sub" id="kpiSubscribersSub">Basic / Standard / Pro í•©ê³„</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">ì˜¤ëŠ˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìˆ˜</div>
      <div class="kpi-value" id="kpiTodayDownloads">-</div>
      <div class="kpi-sub" id="kpiTodayDownloadsSub">ë¡œê·¸ ì—°ë™ í›„ í‘œì‹œ</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">ì˜¤ëŠ˜ ì‹œí—˜ì§€ ì—…ë¡œë“œ ìˆ˜</div>
      <div class="kpi-value" id="kpiTodayUploads">-</div>
      <div class="kpi-sub" id="kpiTodayUploadsSub">ë¡œê·¸ ì—°ë™ í›„ í‘œì‹œ</div>
    </div>
  </div>

  <!-- ===== ê°€ìš´ë°: ê·¸ë˜í”„ + ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œ ì¹´ë“œ ===== -->
  <div class="main-layout">
    <!-- ì™¼ìª½: ê·¸ë˜í”„ + íƒ­ -->
    <div class="main-left">
      <!-- ê·¸ë˜í”„ ì¹´ë“œ -->
      <div class="card chart-card">
        <div class="chart-header">
          <div class="chart-title">ì¼ë³„ ì§€í‘œ ì¶”ì´</div>
          <div class="chart-filters">
            <div class="chart-series">
              <label>
                <input type="checkbox" class="series-toggle" data-series="visitors" checked>
                ë°©ë¬¸ì
              </label>
              <label>
                <input type="checkbox" class="series-toggle" data-series="signups" checked>
                ê°€ì…
              </label>
              <label>
                <input type="checkbox" class="series-toggle" data-series="downloads" checked>
                ë‹¤ìš´ë¡œë“œ
              </label>
              <label>
                <input type="checkbox" class="series-toggle" data-series="uploads" checked>
                ì—…ë¡œë“œ
              </label>
            </div>
            <select id="chartRange" class="chart-range-select">
              <option value="7">ìµœê·¼ 7ì¼</option>
              <option value="30" selected>ìµœê·¼ 30ì¼</option>
              <option value="90">ìµœê·¼ 90ì¼</option>
            </select>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="userChart"></canvas>
        </div>
      </div>

      <!-- ì•„ë˜ íƒ­ ì¹´ë“œ -->
      <div class="card tabs-card">
        <div class="tab-header">
          <button class="tab-btn active" data-target="tab-members">íšŒì› ë¦¬ìŠ¤íŠ¸</button>
          <button class="tab-btn" data-target="tab-subscription">êµ¬ë… / ê²°ì œ</button>
          <button class="tab-btn" data-target="tab-logs">ë¡œê·¸ / í™œë™</button>
        </div>
        <div class="tab-body">
          <!-- íšŒì› ë¦¬ìŠ¤íŠ¸ íƒ­ (ê¸°ì¡´ íšŒì› ê´€ë¦¬ UI ì „ë¶€ ì—¬ê¸°ë¡œ ì´ë™) -->
          <div class="tab-pane active" id="tab-members">
            <div class="search-bar">
              <div class="search-left">
                <input
                  type="text"
                  id="searchInput"
                  name="userSearch"
                  onkeyup="filterTable()"
                  placeholder="ì•„ì´ë””, ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰"
                  autocomplete="off"
                  value=""
                />
                <select
                  id="planFilter"
                  class="search-plan-select"
                  onchange="filterTable()"
                >
                  <option value="">êµ¬ë… í”Œëœ ì „ì²´</option>
                  <option value="none">ë¯¸êµ¬ë…</option>
                  <option value="basic">ë² ì´ì§</option>
                  <option value="standard">ìŠ¤íƒ ë‹¤ë“œ</option>
                  <option value="pro">í”„ë¡œ</option>
                </select>
              </div>

              <label class="search-admin-toggle">
                <input
                  type="checkbox"
                  id="showAdminCheckbox"
                  checked
                  onchange="filterTable()"
                >
                <span>ê´€ë¦¬ì ë³´ê¸°</span>
              </label>
            </div>

            <!-- íšŒì› ëª©ë¡ ë¡œë”© ì¤‘ì—ë§Œ ë³´ì´ëŠ” ì˜ì—­ -->
            <div id="loadingArea">
              <div class="loader"></div>
              <span style="font-size:14px;color:#666;">íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>

            <table id="userTable">
              <thead>
                <tr>
                  <th>ì•„ì´ë””</th>
                  <th>ì´ë©”ì¼</th>
                  <th>ì´ë¦„</th>
                  <th>ê°€ì…ì¼</th>
                  <th>êµ¬ë… ìƒíƒœ</th>
                  <th>êµ¬ë… í”Œëœ</th>
                  <th>ì‹œì‘ì¼</th>
                  <th>ì¢…ë£Œì¼</th>
                  <th>ê¶Œí•œ</th>
                  <th>ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody id="userTbody">
                <!-- JSì—ì„œ ë¶ˆëŸ¬ì˜´ -->
              </tbody>
            </table>
          </div>

          <!-- êµ¬ë… / ê²°ì œ íƒ­ (ì¶”í›„ í™•ì¥ìš©) -->
          <div class="tab-pane" id="tab-subscription">
            <p class="placeholder-text">
              ì´ ì˜ì—­ì—ëŠ” êµ¬ë…/ê²°ì œ í†µê³„ë¥¼ ìš”ì•½í•´ì„œ ë³´ì—¬ì¤„ ìˆ˜ ìˆì–´ìš”.<br/>
              ì˜ˆ: í”Œëœë³„ íšŒì› ìˆ˜, ì›”ë³„ ê²°ì œ ê¸ˆì•¡, ê²°ì œ ìˆ˜ë‹¨ ë¹„ìœ¨ ë“±.<br/>
              ìš°ì„ ì€ ìœ„ì˜ KPIì™€ íšŒì› ë¦¬ìŠ¤íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìš´ì˜í•˜ê³ ,<br/>
              ë‚˜ì¤‘ì— server.jsì—ì„œ ê²°ì œ ë¡œê·¸ APIê°€ ì •ë¦¬ë˜ë©´ ì—¬ê¸°ë¡œ ë¶™ì´ë©´ ë©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- ë¡œê·¸ / í™œë™ íƒ­ (ì¶”í›„ í™•ì¥ìš©) -->
          <div class="tab-pane" id="tab-logs">
            <p class="placeholder-text">
              ì´ ì˜ì—­ì—ëŠ” ë¡œê·¸ì¸ ë¡œê·¸ / ë‹¤ìš´ë¡œë“œ ë¡œê·¸ / ì—…ë¡œë“œ ë¡œê·¸ì˜ ìš”ì•½ì„ ë„£ì„ ìˆ˜ ìˆì–´ìš”.<br/>
              ì˜ˆ: ìµœê·¼ 7ì¼ê°„ ë¡œê·¸ì¸ ë§ì€ íšŒì› TOP5, ë‹¤ìš´ë¡œë“œ ë§ì€ íšŒì› TOP5 ë“±.<br/>
              ì§€ê¸ˆì€ ê¸°ë³¸ UI êµ¬ì¡°ë§Œ ë§Œë“¤ì–´ë‘ì—ˆê³ ,<br/>
              ë¡œê·¸ í…Œì´ë¸”ê³¼ APIê°€ ì¤€ë¹„ë˜ë©´ í…Œì´ë¸”/ê·¸ë˜í”„ë¥¼ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì‚¬ì´ë“œ ì¹´ë“œ 3ê°œ -->
    <div class="main-right">
      <!-- êµ¬ë… í•´ì§€í•œ íšŒì› 10ëª… (ìµœì‹ ìˆœ) -->
      <div class="card side-card">
        <h3>êµ¬ë… í•´ì§€í•œ íšŒì› 10ëª…</h3>
        <div class="side-card-sub">ìµœê·¼ í•´ì§€ ìˆœ</div>
        <ul class="side-list" id="cancelledList">
          <li class="side-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘.</li>
        </ul>
      </div>

      <!-- ìµœê·¼ ì‹ ê·œ êµ¬ë…ê²°ì œ 20ëª… -->
      <div class="card side-card">
        <h3>ìµœê·¼ ì‹ ê·œ êµ¬ë…ê²°ì œ 20ëª…</h3>
        <div class="side-card-sub">ìµœê·¼ ê²°ì œ ìˆœ</div>
        <ul class="side-list" id="newSubsList">
          <li class="side-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘.</li>
        </ul>
      </div>

      <!-- ì‹ ê·œ ê°€ì… 15ëª… (ìµœê·¼ ê°€ì…ìˆœ) -->
      <div class="card side-card">
        <h3>ì‹ ê·œ ê°€ì… 15ëª…</h3>
        <div class="side-card-sub">ìµœê·¼ ê°€ì…ìˆœ</div>
        <ul class="side-list" id="newUsersList">
          <li class="side-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘.</li>
        </ul>
      </div>

      <!-- ì—…ë¡œë“œ í™•ì¸ ìš”ì²­ ëª©ë¡ (í™•ì¸ì¤‘) -->
      <div class="card side-card">
        <h3>ì—…ë¡œë“œ í™•ì¸ ìš”ì²­ ëª©ë¡</h3>
        <div class="side-card-sub">í™•ì¸ì¤‘ ìƒíƒœ Â· ìš”ì²­ ë¹ ë¥¸ ìˆœ</div>
        <ul class="side-list" id="uploadPendingList">
          <li class="side-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘.</li>
        </ul>
      </div>

      <!-- ì—…ë¡œë“œ ì œì‘ ì§„í–‰ ëª©ë¡ (ì œì‘ì¤‘) -->
      <div class="card side-card">
        <h3>ì—…ë¡œë“œ ì œì‘ ì§„í–‰ ëª©ë¡</h3>
        <div class="side-card-sub">ì œì‘ì¤‘ ìƒíƒœ Â· ì§„í–‰ ì‹œì‘ ë¹ ë¥¸ ìˆœ</div>
        <ul class="side-list" id="uploadInProgressList">
          <li class="side-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘.</li>
        </ul>
      </div>
    </div>
  </div>


  <!-- ëª¨ë‹¬ -->
  <div id="subscriptionModal" class="modal-overlay">
    <div class="modal">
      <p id="modalText">ì´ ì‚¬ìš©ìì˜ êµ¬ë…ì„ ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>

      <!-- íšŒì› ì‚­ì œ ë•Œë§Œ ì‚¬ìš©í•˜ëŠ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
      <div id="adminPwWrapper" style="margin-top:10px; display:none;">
        <label style="font-size:13px; color:#555; display:block; margin-bottom:4px;">
          ê´€ë¦¬ì ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        </label>
        <input
          type="password"
          id="adminPasswordInput"
          placeholder="ë¹„ë°€ë²ˆí˜¸"
          style="width:100%; padding:6px 8px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px;"
        >
      </div>

      <div class="modal-buttons">
        <button onclick="confirmAction()">âœ… í™•ì¸</button>
        <button onclick="closeModal()">âŒ ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- Chart.js (ê·¸ë˜í”„ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let selectedUser = null;
    let selectedAction = null;

    // ëŒ€ì‹œë³´ë“œ ìƒíƒœ
    const dashboardState = {
      users: [],
      userMap: new Map(),   // ğŸ”¹ id â†’ user ê°ì²´ ë§¤í•‘
      chart: null,
      range: 30, // ê¸°ë³¸ 30ì¼
      seriesEnabled: {
        visitors: true,
        signups: true,
        downloads: true,
        uploads: true
      }
    };

    // ===== íšŒì› ëª©ë¡ ë¡œë“œ (ëŒ€ì‹œë³´ë“œ ì—°ë™ + ì¹´ë“œí˜• ë Œë”) =====
    async function loadUsers() {
      const tbody   = document.getElementById('userTbody');
      const table   = document.getElementById('userTable');
      const loading = document.getElementById('loadingArea');

      // ë¡œë”© ì‹œì‘: í…Œì´ë¸” ê°ì¶”ê³  ìŠ¤í”¼ë„ˆ ë³´ì´ê¸°
      if (loading) loading.style.display = 'flex';
      if (table)   table.style.display   = 'none';

      try {
        const res  = await fetch('/api/admin/users', { credentials: 'include' });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          throw new Error(data.message || 'íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        const users = data.users || [];
        dashboardState.users = users;

        // ğŸ”¹ id / email ë‘˜ ë‹¤ë¡œ ì°¾ì•„ì“¸ ìˆ˜ ìˆê²Œ ë§¤í•‘
        const map = new Map();
        users.forEach(u => {
          if (!u) return;

          const idKey    = (u.id    != null) ? String(u.id).trim()    : '';
          const emailKey = (u.email != null) ? String(u.email).trim() : '';

          if (idKey)    map.set(idKey, u);    // social ID, ë¡œì»¬ ID
          if (emailKey) map.set(emailKey, u); // ì´ë©”ì¼ë¡œë„ ì ‘ê·¼ ê°€ëŠ¥
        });
        dashboardState.userMap = map;

        if (tbody) tbody.innerHTML = '';

        users.forEach(u => {
          const isAdmin = !!u.isAdmin;
          const plan = (u.plan || '').toLowerCase();
          const subscribedByPlan = ['basic','standard','pro'].includes(plan);

          const subStartRaw =
            u.subscription_start ?? u.sub_start ?? u.plan_start ?? u.start_at ?? u.start_date ?? null;
          const subEndRaw =
            u.subscription_end   ?? u.sub_end   ?? u.plan_end   ?? u.end_at   ?? u.end_date   ?? null;

          const avatar    = u.avatarUrl || 'default-avatar.png'; // í”„ë¡œí•„ì‚¬ì§„ (ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€)
          const displayId = getDisplayId(u) || (u.id && String(u.id)) || '';
          const createdAtStr = formatDateYMD(u.created_at || u.createdAt);

          const subStateLabel = subscribedByPlan
            ? (plan === 'basic'
                ? 'ë² ì´ì§'
                : plan === 'standard'
                  ? 'ìŠ¤íƒ ë‹¤ë“œ'
                  : plan === 'pro'
                    ? 'í”„ë¡œ'
                    : plan)
            : 'ë¯¸êµ¬ë…';

          const row = document.createElement('tr');
          // ê²€ìƒ‰/í•„í„°ìš© ë°ì´í„° ì…‹íŒ…
          row.dataset.id      = displayId;
          row.dataset.email   = u.email || '';
          row.dataset.name    = u.name || '';
          row.dataset.isAdmin = isAdmin ? '1' : '0';
          row.dataset.plan    = subscribedByPlan ? plan : 'none';  // basic / standard / pro / none


          row.innerHTML = `
            <td colspan="10">
              <div class="user-card">
                <div class="user-main">
                  <div class="user-profile">
                    <img
                      class="user-avatar"
                      src="${u.avatarUrl || '/image_index/profile.svg'}"
                      alt="í”„ë¡œí•„"
                    >
                  </div>

                  <div class="user-id-email">
                    <div class="uid">${displayId || '-'}</div>
                    <div class="uemail">${u.email || '-'}</div>
                  </div>

                  <div class="user-name">
                    <div class="name-line">${u.name || '-'}</div>
                    ${isAdmin ? '<div class="admin-tag">ê´€ë¦¬ì</div>' : ''}
                  </div>

                  <div class="user-join-sub">
                    <div class="join">${createdAtStr}</div>
                    <div class="substate-pill ${subscribedByPlan ? 'on' : ''}">
                      ${subStateLabel}
                    </div>
                  </div>

                  <div class="user-plan">
                    <select data-user-id="${u.id}" onchange="changePlan(this)">
                      <option value="">-</option>
                      <option value="basic" ${plan === 'basic' ? 'selected' : ''}>Basic</option>
                      <option value="standard" ${plan === 'standard' ? 'selected' : ''}>Standard</option>
                      <option value="pro" ${plan === 'pro' ? 'selected' : ''}>Pro</option>
                    </select>
                  </div>

                  <div class="user-period">
                    <span>ì‹œì‘ì¼: ${formatDateYMD(subStartRaw)}</span>
                    <span>ì¢…ë£Œì¼: ${formatDateYMD(subEndRaw)}</span>
                  </div>
                </div>

                <div class="user-more-wrap">
                  <button type="button" class="more-btn" data-user-id="${u.id}">
                    <span class="more-btn-icon">â‹®</span>
                  </button>
                  <div class="more-menu">
                    <div class="more-menu-item" data-action="extend" data-user-id="${u.id}">
                      <span class="label">ì—°ì¥</span>
                    </div>
                    <div class="more-menu-item" data-action="cancel" data-user-id="${u.id}">
                      <span class="label">í•´ì§€</span>
                    </div>
                    <div class="more-menu-item"
                         data-action="${isAdmin ? 'revoke_admin' : 'grant_admin'}"
                         data-user-id="${u.id}">
                      <span class="label">${isAdmin ? 'ê´€ë¦¬ì í•´ì œ' : 'ê´€ë¦¬ì ë¶€ì—¬'}</span>
                    </div>
                    <div class="more-menu-item danger" data-action="delete_user" data-user-id="${u.id}">
                      <span class="label">íšŒì› ì‚­ì œ</span>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          `;

          if (tbody) tbody.appendChild(row);
        });

        // ëŒ€ì‹œë³´ë“œ, ì‚¬ì´ë“œë°”, ê·¸ë˜í”„ ê°±ì‹ 
        updateKpiFromUsers(users);
        updateSidebarFromUsers(users);
        rebuildChart();

        // ë”ë³´ê¸° ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ (ìµœì´ˆ 1íšŒë§Œ ë°”ì¸ë”©)
        bindMoreMenuEvents();

      } catch (e) {
        console.error('íšŒì› ë¡œë“œ ì‹¤íŒ¨:', e);
        alert(e.message || 'íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        if (loading) loading.style.display = 'none';
        if (table)   table.style.display   = 'table';
      }
    }

    function updateKpiFromUsers(users) {
      const today = new Date();
      today.setHours(0,0,0,0);
      const todayKey = today.toISOString().slice(0,10);

      let todaySignups   = 0;
      let subscribers    = 0;
      let activeUsers30d = 0;

      // í”Œëœë³„ ì¹´ìš´íŠ¸
      let basicCount    = 0;
      let standardCount = 0;
      let proCount      = 0;

      const nowMs = Date.now();
      const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

      let hasLastLoginField = false;

      users.forEach(u => {
        const plan = (u.plan || '').toLowerCase();
        if (['basic','standard','pro'].includes(plan)) {
          subscribers++;
          if (plan === 'basic')      basicCount++;
          else if (plan === 'standard') standardCount++;
          else if (plan === 'pro')   proCount++;
        }

        const created = u.created_at || u.createdAt || null;
        if (created) {
          const d = new Date(created);
          if (!isNaN(d)) {
            const key = d.toISOString().slice(0,10);
            if (key === todayKey) {
              todaySignups++;
            }
          }
        }

        const lastLoginRaw =
          u.last_login || u.lastLogin || u.last_login_at || u.lastLoginAt || null;
        if (lastLoginRaw) {
          hasLastLoginField = true;
          const d = new Date(lastLoginRaw);
          if (!isNaN(d)) {
            if (nowMs - d.getTime() <= THIRTY_DAYS) {
              activeUsers30d++;
            }
          }
        }
      });

      // KPI ë°˜ì˜
      const elTodaySignups     = document.getElementById('kpiTodaySignups');
      const elTodaySignupsSub  = document.getElementById('kpiTodaySignupsSub');
      if (elTodaySignups)    elTodaySignups.textContent = todaySignups + 'ëª…';
      if (elTodaySignupsSub) elTodaySignupsSub.textContent = 'ì˜¤ëŠ˜ ê°€ì…í•œ íšŒì› ìˆ˜';

      const elSubscribers    = document.getElementById('kpiSubscribers');
      const elSubscribersSub = document.getElementById('kpiSubscribersSub');
      if (elSubscribers)    elSubscribers.textContent = subscribers + 'ëª…';
      if (elSubscribersSub) {
        if (subscribers === 0) {
          elSubscribersSub.textContent = 'êµ¬ë… ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.';
        } else {
          elSubscribersSub.textContent =
            `ë² ì´ì§ ${basicCount}ëª… Â· ìŠ¤íƒ ë‹¤ë“œ ${standardCount}ëª… Â· í”„ë¡œ ${proCount}ëª…`;
        }
      }

      const elActive    = document.getElementById('kpiActiveUsers');
      const elActiveSub = document.getElementById('kpiActiveUsersSub');
      if (hasLastLoginField) {
        if (elActive)    elActive.textContent = activeUsers30d + 'ëª…';
        if (elActiveSub) elActiveSub.textContent = 'ìµœê·¼ 30ì¼ ë‚´ ë¡œê·¸ì¸í•œ íšŒì› ìˆ˜';
      } else {
        if (elActive)    elActive.textContent = '-';
        if (elActiveSub) elActiveSub.textContent = 'last_login ë¡œê·¸ ì—°ë™ í›„ í‘œì‹œ';
      }

      // ë°©ë¬¸ì / ë‹¤ìš´ë¡œë“œ / ì—…ë¡œë“œëŠ” ì¼ë‹¨ ì„œë²„ ë¡œê·¸ ì—°ë™ ì „ì´ë¼ ê·¸ëŒ€ë¡œ ë‘ 
      const elVisitors    = document.getElementById('kpiTodayVisitors');
      const elVisitorsSub = document.getElementById('kpiTodayVisitorsSub');
      if (elVisitors)    elVisitors.textContent = '-';
      if (elVisitorsSub) elVisitorsSub.textContent = 'ë¡œê·¸ ì—°ë™ í›„ í‘œì‹œ';

      const elDown    = document.getElementById('kpiTodayDownloads');
      const elDownSub = document.getElementById('kpiTodayDownloadsSub');
      if (elDown)    elDown.textContent = '-';
      if (elDownSub) elDownSub.textContent = 'ë‹¤ìš´ë¡œë“œ ë¡œê·¸ ì—°ë™ í›„ í‘œì‹œ';

      const elUp    = document.getElementById('kpiTodayUploads');
      const elUpSub = document.getElementById('kpiTodayUploadsSub');
      if (elUp)    elUp.textContent = '-';
      if (elUpSub) elUpSub.textContent = 'ì—…ë¡œë“œ ë¡œê·¸ ì—°ë™ í›„ í‘œì‹œ';
    }


    // ===== ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œ ì¹´ë“œ ë‚´ìš© ê°±ì‹  =====
    function updateSidebarFromUsers(users) {
      const cancelledList = document.getElementById('cancelledList'); // êµ¬ë… í•´ì§€ 10ëª…
      const newSubsList   = document.getElementById('newSubsList');   // ìµœê·¼ ì‹ ê·œ êµ¬ë…ê²°ì œ 20ëª…
      const newUsersList  = document.getElementById('newUsersList');  // ì˜¤ëŠ˜ ì‹ ê·œ ê°€ì… 10ëª…

      const today = new Date();
      today.setHours(0,0,0,0);
      const todayKey = today.toISOString().slice(0,10);

      // 1) êµ¬ë… í•´ì§€í•œ íšŒì› 10ëª… (ìµœì‹ ìˆœ)
      if (cancelledList) {
        cancelledList.innerHTML = '';
        const cancelled = [];

        users.forEach(u => {
          // í•´ì§€ì¼ í›„ë³´: ì „ìš© í•„ë“œê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ í”Œëœì´ ì—†ê³  ì¢…ë£Œì¼ ìˆëŠ” ê²½ìš° ì¢…ë£Œì¼ ì‚¬ìš©
          const rawCancel =
            u.subscription_cancelled_at ??
            u.cancelled_at ??
            u.canceled_at ??
            u.sub_cancelled_at ??
            null;

          let d = null;

          if (rawCancel) {
            d = new Date(rawCancel);
          } else {
            const rawEnd =
              u.subscription_end ?? u.sub_end ?? u.plan_end ?? u.end_at ?? u.end_date ?? null;
            const plan = (u.plan || '').toLowerCase();
            if (!plan && rawEnd) {
              d = new Date(rawEnd);
            }
          }

          if (!d || isNaN(d)) return;

          cancelled.push({ user: u, cancelAt: d });
        });

        // ìµœì‹  í•´ì§€ ìˆœ ì •ë ¬
        cancelled.sort((a, b) => b.cancelAt - a.cancelAt);
        const top10 = cancelled.slice(0, 10);

        if (top10.length === 0) {
          cancelledList.innerHTML =
            '<li class="side-empty">êµ¬ë… í•´ì§€í•œ íšŒì›ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
          top10.forEach(({ user, cancelAt }) => {
            const dateStr = cancelAt.toISOString().slice(0, 10);
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="side-id">${getDisplayId(user) || user.id}</span>
              <span class="side-badge">${dateStr}</span>
            `;
            cancelledList.appendChild(li);
          });
        }
      }

      // 2) ìµœê·¼ ì‹ ê·œ êµ¬ë…ê²°ì œ 20ëª… (í”Œëœ ì‹œì‘ì¼ ê¸°ì¤€, ìµœì‹ ìˆœ)
      if (newSubsList) {
        newSubsList.innerHTML = '';
        const subs = [];

        users.forEach(u => {
          const plan = (u.plan || '').toLowerCase();
          if (!['basic', 'standard', 'pro'].includes(plan)) return;

          const rawStart =
            u.subscription_start ??
            u.sub_start ??
            u.plan_start ??
            u.start_at ??
            u.start_date ??
            null;
          if (!rawStart) return;

          const d = new Date(rawStart);
          if (isNaN(d)) return;

          subs.push({ user: u, startAt: d, plan });
        });

        subs.sort((a, b) => b.startAt - a.startAt);
        const top20 = subs.slice(0, 20);

        if (top20.length === 0) {
          newSubsList.innerHTML =
            '<li class="side-empty">êµ¬ë… ì¤‘ì¸ íšŒì›ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
          top20.forEach(({ user, startAt, plan }) => {
            const dateStr = startAt.toISOString().slice(0, 10);
            const planLabel =
              plan === 'basic'
                ? 'Basic'
                : plan === 'standard'
                ? 'Standard'
                : plan === 'pro'
                ? 'Pro'
                : plan;
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="side-id">${getDisplayId(user) || user.id}</span>
              <span class="side-badge">${planLabel} Â· ${dateStr}</span>
            `;
            newSubsList.appendChild(li);
          });
        }
      }

      // 3) ì‹ ê·œ ê°€ì… 15ëª… (ìµœê·¼ ê°€ì…ìˆœ)
      if (newUsersList) {
        newUsersList.innerHTML = '';
        const recentNew = [];

        users.forEach(u => {
          const created = u.created_at || u.createdAt || null;
          if (!created) return;
          const d = new Date(created);
          if (isNaN(d)) return;

          recentNew.push({ user: u, createdAt: d });
        });

        // ìµœê·¼ ê°€ì… ìˆœ (ê°€ì¥ ìµœê·¼ì´ ìœ„ë¡œ)
        recentNew.sort((a, b) => b.createdAt - a.createdAt);
        const top15New = recentNew.slice(0, 15);

        if (top15New.length === 0) {
          newUsersList.innerHTML =
            '<li class="side-empty">ìµœê·¼ ê°€ì…í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
          top15New.forEach(({ user, createdAt }) => {
            const dateStr = createdAt.toISOString().slice(0, 10); // YYYY-MM-DD
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="side-id">${getDisplayId(user) || user.id}</span>
              <span class="side-badge">${dateStr}</span>
            `;
            newUsersList.appendChild(li);
          });
        }
      }
    }

        // ===== ì—…ë¡œë“œ ìš”ì•½ íŒ¨ë„ (í™•ì¸ ìš”ì²­ / ì œì‘ ì§„í–‰) =====
    async function loadUploadPanels() {
      const pendingList  = document.getElementById('uploadPendingList');
      const progressList = document.getElementById('uploadInProgressList');

      if (!pendingList && !progressList) return;

      if (pendingList)  pendingList.innerHTML  = '<li class="side-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘.</li>';
      if (progressList) progressList.innerHTML = '<li class="side-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘.</li>';

      try {
        // admin_upload_review.html ê³¼ ë™ì¼í•œ API ì‚¬ìš©
        const res  = await fetch('/api/admin/uploads', { credentials: 'include' });
        const data = await res.json().catch(() => []);
        if (!Array.isArray(data)) throw new Error('ì—…ë¡œë“œ ëª©ë¡ í˜•ì‹ ì˜¤ë¥˜');
        updateUploadPanels(data);
      } catch (e) {
        console.error('ì—…ë¡œë“œ ìš”ì•½ íŒ¨ë„ ë¡œë“œ ì‹¤íŒ¨:', e);
        if (pendingList) {
          pendingList.innerHTML =
            '<li class="side-empty">ì—…ë¡œë“œ í™•ì¸ ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
        }
        if (progressList) {
          progressList.innerHTML =
            '<li class="side-empty">ì—…ë¡œë“œ ì œì‘ ì§„í–‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
        }
      }
    }

    function updateUploadPanels(uploads) {
      const pendingList  = document.getElementById('uploadPendingList');
      const progressList = document.getElementById('uploadInProgressList');

      if (!pendingList && !progressList) return;

      if (pendingList)  pendingList.innerHTML  = '';
      if (progressList) progressList.innerHTML = '';

      // ì—…ë¡œë“œ ê°ì²´ ì•ˆì—ì„œ ë‚ ì§œ í•„ë“œ ì—¬ëŸ¬ í›„ë³´ë¥¼ ìˆœì„œëŒ€ë¡œ ì°¾ì•„ì„œ Dateë¡œ ë³€í™˜
      const parseDateFromKeys = (u, keys) => {
        for (const key of keys) {
          const v = u[key];
          if (!v) continue;
          const d = new Date(v);
          if (!isNaN(d)) {
            d.setHours(0, 0, 0, 0);
            return d;
          }
        }
        return null;
      };

      // âœ… ì—…ë¡œë” í‘œì‹œìš©: ì´ë©”ì¼ ì•ë¶€ë¶„ ìš°ì„ , ê·¸ë‹¤ìŒ ì‚¬ìš©ì ì •ë³´, ë§ˆì§€ë§‰ì— user_id
const formatUploadUser = (u) => {
  if (!u) return '';

  // 1) ì´ë©”ì¼ ê³„ì—´ ë¨¼ì € í™•ì¸ (ì†Œì…œ ë¡œê·¸ì¸ í¬í•¨ + user_id ë„ ê°™ì´ ë³¸ë‹¤)
  const emailLike = (
    u.email ||
    u.user_email ||
    u.owner_email ||
    u.uploader_email ||
    u.user_id ||          // âœ… ì¶”ê°€
    u.uploader ||
    ''
  ).trim();

  if (emailLike && emailLike.includes('@')) {
    // ì´ë©”ì¼ì´ë©´ @ ì•ë¶€ë¶„ë§Œ ì‚¬ìš©
    return emailLike.split('@')[0];
  }

  // 2) ê·¸ ë‹¤ìŒ user_id ê³„ì—´ (ì´ë©”ì¼í˜•ì´ ì•„ë‹ˆë¼ê³  íŒë‹¨ëœ ê²½ìš°)
  const rawId = (
    u.user_id ||
    u.userId ||
    u.owner_id ||
    u.ownerId ||
    ''
  ).trim();

  // rawId ê°€ ì´ë©”ì¼ í˜•ì‹ì´ë©´ ë§ˆì°¬ê°€ì§€ë¡œ @ ì•ë¶€ë¶„ë§Œ
  if (rawId && rawId.includes('@')) {
    return rawId.split('@')[0];
  }

  // 3) ë‘˜ ë‹¤ ì´ë©”ì¼ì´ ì•„ë‹ˆë©´ ìˆëŠ” ê°’ ê·¸ëŒ€ë¡œ
  if (rawId) return rawId;
  if (emailLike) return emailLike;
  return '';
};



      // 1) ì—…ë¡œë“œ í™•ì¸ ìš”ì²­ ëª©ë¡ (status === 'í™•ì¸ì¤‘')
      if (pendingList) {
        const pending = uploads
          .filter(u => u.status === 'í™•ì¸ì¤‘')
          .map(u => ({
            userLabel: formatUploadUser(u),
            requestedAt: parseDateFromKeys(u, [
              'requested_at', 'request_at', 'request_date',
              'created_at', 'createdAt', 'uploaded_at', 'uploadedAt'
            ])
          }))
          // ìš”ì²­ì¼ì´ ìˆëŠ” ê±´ ë¨¼ì €, ì—†ëŠ” ê±´ ë’¤ë¡œ
          .sort((a, b) => {
            const t1 = a.requestedAt ? a.requestedAt.getTime() : Infinity;
            const t2 = b.requestedAt ? b.requestedAt.getTime() : Infinity;
            return t1 - t2;
          });

        if (!pending.length) {
          pendingList.innerHTML =
            '<li class="side-empty">í™•ì¸ì¤‘ì¸ ì—…ë¡œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
          // ğŸ”¸ ì—¬ê¸°ì„œëŠ” slice ì•ˆ ì“°ê³  ì „ì²´ë¥¼ ë‹¤ ê·¸ë¦°ë‹¤ (ìŠ¤í¬ë¡¤ì€ CSS max-heightë¡œ ì²˜ë¦¬)
          pending.forEach(item => {
            let dateStr = '-';
            let daysLabel = '';

            if (item.requestedAt) {
              const days = calcElapsedDays(item.requestedAt);
              dateStr = formatDateYMD(item.requestedAt);
              if (days != null) {
                daysLabel =
                  days === 0 ? ' Â· ì˜¤ëŠ˜ ìš”ì²­' : ` Â· ìš”ì²­ í›„ ${days}ì¼ ê²½ê³¼`;
              }
            }

            const li = document.createElement('li');
            li.innerHTML = `
              <span class="side-id">${item.userLabel}</span>
              <span class="side-badge">${dateStr}${daysLabel}</span>
            `;
            pendingList.appendChild(li);
          });
        }
      }

      // 2) ì—…ë¡œë“œ ì œì‘ ì§„í–‰ ëª©ë¡ (status === 'ì œì‘ì¤‘')
      if (progressList) {
        const progresses = uploads
          .filter(u => u.status === 'ì œì‘ì¤‘')
          .map(u => ({
            userLabel: formatUploadUser(u),
            startedAt: parseDateFromKeys(u, [
              'in_progress_at', 'progress_started_at', 'progress_at',
              'updated_at', 'updatedAt', 'started_at',
              // ë‚ ì§œê°€ ë”°ë¡œ ì—†ìœ¼ë©´ ì—…ë¡œë“œì¼ì´ë¼ë„ ì‚¬ìš©
              'requested_at', 'request_at', 'request_date',
              'created_at', 'createdAt', 'uploaded_at', 'uploadedAt'
            ])
          }))
          // ì‹œì‘ì¼ ìˆëŠ” ê±´ ë¨¼ì €, ì—†ëŠ” ê±´ ë’¤ë¡œ
          .sort((a, b) => {
            const t1 = a.startedAt ? a.startedAt.getTime() : Infinity;
            const t2 = b.startedAt ? b.startedAt.getTime() : Infinity;
            return t1 - t2;
          });

        if (!progresses.length) {
          progressList.innerHTML =
            '<li class="side-empty">ì œì‘ì¤‘ì¸ ì—…ë¡œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
          // ğŸ”¸ ì—¬ê¸°ë„ slice ì—†ì´ ì „ì²´ ë Œë” â†’ ë§ì•„ì§€ë©´ ìŠ¤í¬ë¡¤
          progresses.forEach(item => {
            let dateStr = '-';
            let daysLabel = '';

            if (item.startedAt) {
              const days = calcElapsedDays(item.startedAt);
              dateStr = formatDateYMD(item.startedAt);
              if (days != null) {
                daysLabel =
                  days === 0 ? ' Â· ì˜¤ëŠ˜ ì‹œì‘' : ` Â· ì œì‘ ${days}ì¼ì§¸`;
              }
            }

            const li = document.createElement('li');
            li.innerHTML = `
              <span class="side-id">${item.userLabel}</span>
              <span class="side-badge">${dateStr}${daysLabel}</span>
            `;
            progressList.appendChild(li);
          });
        }
      }
    }

    function getDisplayId(u) {
      if (!u) return '';

      const rawId    = (u.id && String(u.id).trim()) || '';
      const rawEmail = (u.email || '').trim();
      const name     = (u.name || '').trim();

      // "ì†Œì…œ ë¡œê·¸ì¸ì²˜ëŸ¼ ë³´ì´ëŠ” ID" ì—¬ë¶€ (ê¸¸ê³  ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°)
      const isWeirdId = rawId && /^[0-9]{10,}$/.test(rawId);

      // ì´ë©”ì¼ì´ ìˆìœ¼ë©´ @ ì•ë¶€ë¶„ ì¶”ì¶œ
      let emailPrefix = '';
      if (rawEmail && rawEmail !== 'Kakao') {
        emailPrefix = rawEmail.includes('@') ? rawEmail.split('@')[0] : rawEmail;
      }

      // 1) êµ¬ê¸€/ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì²˜ëŸ¼ ìˆ«ì IDì¸ ê²½ìš° â†’ ì´ë©”ì¼ prefix ìš°ì„ 
      if (isWeirdId && emailPrefix) return emailPrefix;

      // 2) ì¼ë°˜ ê³„ì • (gh_6399 ê°™ì€ ê²ƒ)ì€ ì›ë˜ ì•„ì´ë”” ìš°ì„ 
      if (!isWeirdId && rawId) return rawId;

      // 3) ì•„ì´ë””ê°€ ì—†ê³  ì´ë©”ì¼ë§Œ ìˆëŠ” ê²½ìš° â†’ ì´ë©”ì¼ prefix
      if (emailPrefix) return emailPrefix;

      // 4) ê·¸ ì™¸ username / loginId / ì´ë¦„ ìˆœ
      const fallback =
        (u.username && String(u.username).trim()) ||
        (u.loginId && String(u.loginId).trim()) ||
        name ||
        '';

      return fallback;
    }


    function formatDateYMD(value) {
      if (!value) return '-';
      if (value instanceof Date) {
        if (isNaN(value)) return '-';
        return value.toISOString().slice(0, 10);
      }
      try {
        const d = new Date(value);
        if (!isNaN(d)) {
          return d.toISOString().slice(0, 10);
        }
      } catch (e) {}
      const s = String(value);
      return s.length >= 10 ? s.slice(0, 10) : s;
    }

    // ê¸°ì¤€ ë‚ ì§œ(ì˜¤ëŠ˜) ëŒ€ë¹„ ë©°ì¹  ì§€ë‚¬ëŠ”ì§€ (ìŒìˆ˜ë©´ 0ì¼ë¡œ ì²˜ë¦¬)
    function calcElapsedDays(value) {
      if (!value) return null;
      let d = value instanceof Date ? value : new Date(value);
      if (isNaN(d)) return null;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      d.setHours(0, 0, 0, 0);

      const diffMs = today.getTime() - d.getTime();
      if (diffMs < 0) return 0;
      return Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    // ===== ë”ë³´ê¸°(â‹®) ë“œë¡­ë‹¤ìš´ ë°”ì¸ë”© =====

    let moreMenuBound = false;
    function bindMoreMenuEvents() {
      if (moreMenuBound) return;
      moreMenuBound = true;

      const tbody = document.getElementById('userTbody');
      if (!tbody) return;

      // tbody ì•ˆì—ì„œ ë²„íŠ¼ / ë©”ë‰´ í´ë¦­ ì²˜ë¦¬
      tbody.addEventListener('click', function(e) {
        const btn = e.target.closest('.more-btn');
        if (btn) {
          const wrap = btn.closest('.user-more-wrap');
          const menu = wrap ? wrap.querySelector('.more-menu') : null;
          if (!menu) return;

          // ë‹¤ë¥¸ ì—´ë¦° ë©”ë‰´ë“¤ ë‹«ê¸°
          tbody.querySelectorAll('.more-menu.open').forEach(m => {
            if (m !== menu) m.classList.remove('open');
          });

          menu.classList.toggle('open');
          return;
        }

        const item = e.target.closest('.more-menu-item');
        if (item) {
          const uid = item.dataset.userId;
          const action = item.dataset.action;
          if (uid && action) {
            // ê¸°ì¡´ ëª¨ë‹¬ ë¡œì§ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            openModal(action, uid);
          }

          const menu = item.closest('.more-menu');
          if (menu) menu.classList.remove('open');
        }
      });

      // ë°”ê¹¥ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.user-more-wrap')) {
          document.querySelectorAll('.more-menu.open').forEach(m => m.classList.remove('open'));
        }
      });
    }

    // ===== ê·¸ë˜í”„ (Chart.js) ì¬êµ¬ì„± =====
    function rebuildChart() {
      const canvas = document.getElementById('userChart');
      if (!canvas || typeof Chart === 'undefined') return;

      const users = dashboardState.users || [];
      const range = dashboardState.range || 30;

      const today = new Date();
      today.setHours(0,0,0,0);

      const signupCountByDate = {};

      users.forEach(u => {
        const created = u.created_at || u.createdAt || null;
        if (!created) return;
        const d = new Date(created);
        if (isNaN(d)) return;
        const key = d.toISOString().slice(0,10);
        signupCountByDate[key] = (signupCountByDate[key] || 0) + 1;
      });

      const labels = [];
      const visitorsData = [];
      const signupsData  = [];
      const downloadsData = [];
      const uploadsData   = [];

      for (let i = range - 1; i >= 0; i--) {
        const dt = new Date(today);
        dt.setDate(today.getDate() - i);
        const key = dt.toISOString().slice(0,10);
        labels.push((dt.getMonth() + 1) + '/' + dt.getDate());

        signupsData.push(signupCountByDate[key] || 0);
        visitorsData.push(0);  // ë°©ë¬¸ììˆ˜ëŠ” ì¶”í›„ ë¡œê·¸ ì—°ë™
        downloadsData.push(0); // ë‹¤ìš´ë¡œë“œìˆ˜ ì¶”í›„ ë¡œê·¸ ì—°ë™
        uploadsData.push(0);   // ì—…ë¡œë“œìˆ˜ ì¶”í›„ ë¡œê·¸ ì—°ë™
      }

      if (!dashboardState.chart) {
        const ctx = canvas.getContext('2d');
        dashboardState.chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'ë°©ë¬¸ì',
                data: visitorsData,
                borderWidth: 2,
                tension: 0.3
              },
              {
                label: 'ê°€ì… ìˆ˜',
                data: signupsData,
                borderWidth: 2,
                tension: 0.3
              },
              {
                label: 'ë‹¤ìš´ë¡œë“œ ìˆ˜',
                data: downloadsData,
                borderWidth: 2,
                tension: 0.3
              },
              {
                label: 'ì—…ë¡œë“œ ìˆ˜',
                data: uploadsData,
                borderWidth: 2,
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 11 } } }
            },
            scales: {
              x: { ticks: { font: { size: 11 } } },
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1, font: { size: 11 } }
              }
            }
          }
        });
      } else {
        const chart = dashboardState.chart;
        chart.data.labels = labels;
        chart.data.datasets[0].data = visitorsData;
        chart.data.datasets[1].data = signupsData;
        chart.data.datasets[2].data = downloadsData;
        chart.data.datasets[3].data = uploadsData;
        chart.update();
      }

      // ì‹œë¦¬ì¦ˆ í† ê¸€ ìƒíƒœ ë°˜ì˜
      applySeriesToggleToChart();
    }

    // ì²´í¬ë°•ìŠ¤ë¡œ ì‹œë¦¬ì¦ˆ ì˜¨/ì˜¤í”„
    function applySeriesToggleToChart() {
      const chart = dashboardState.chart;
      if (!chart) return;

      const map = {
        visitors: 0,
        signups: 1,
        downloads: 2,
        uploads: 3
      };

      Object.keys(map).forEach(key => {
        const idx = map[key];
        const enabled = dashboardState.seriesEnabled[key];
        if (chart.data.datasets[idx]) {
          chart.data.datasets[idx].hidden = !enabled;
        }
      });

      chart.update();
    }

    // ===== íƒ­ ì´ˆê¸°í™” =====
    function initTabs() {
      const btns = document.querySelectorAll('.tab-btn');
      const panes = document.querySelectorAll('.tab-pane');

      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-target');
          btns.forEach(b => b.classList.remove('active'));
          panes.forEach(p => p.classList.remove('active'));

          btn.classList.add('active');
          const pane = document.getElementById(target);
          if (pane) pane.classList.add('active');
        });
      });
    }

    // ===== ì°¨íŠ¸ í•„í„°(ì²´í¬ë°•ìŠ¤, ê¸°ê°„) ì´ë²¤íŠ¸ =====
    function initChartControls() {
      const rangeSelect = document.getElementById('chartRange');
      if (rangeSelect) {
        rangeSelect.addEventListener('change', () => {
          const v = parseInt(rangeSelect.value, 10);
          dashboardState.range = isNaN(v) ? 30 : v;
          rebuildChart();
        });
      }

      document.querySelectorAll('.series-toggle').forEach(chk => {
        chk.addEventListener('change', () => {
          const key = chk.getAttribute('data-series');
          if (!key) return;
          dashboardState.seriesEnabled[key] = chk.checked;
          applySeriesToggleToChart();
        });
      });
    }

    // ===== ëª¨ë‹¬ ê´€ë ¨ ê¸°ì¡´ ë¡œì§ ìœ ì§€ =====
    function openModal(action, userId) {
      selectedUser = userId;
      selectedAction = action;

      let text = '';
      if (action === 'extend') text = `'${userId}' ì‚¬ìš©ìì˜ êµ¬ë…ì„ ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      else if (action === 'cancel') text = `'${userId}' ì‚¬ìš©ìì˜ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      else if (action === 'grant_admin') text = `'${userId}' ì‚¬ìš©ìì—ê²Œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      else if (action === 'revoke_admin') text = `'${userId}' ì‚¬ìš©ìì˜ ê´€ë¦¬ì ê¶Œí•œì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      else if (action === 'delete_user')
        text = `'${userId}' íšŒì›ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ í›„ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)`;

      document.getElementById('modalText').innerText = text;

      const pwWrap  = document.getElementById('adminPwWrapper');
      const pwInput = document.getElementById('adminPasswordInput');
      if (pwInput) pwInput.value = '';
      if (pwWrap) pwWrap.style.display = (action === 'delete_user') ? 'block' : 'none';

      document.getElementById('subscriptionModal').style.display = 'block';
    }

    function closeModal() {
      const m = document.getElementById('subscriptionModal');
      if (m) m.style.display = 'none';

      const pwWrap  = document.getElementById('adminPwWrapper');
      const pwInput = document.getElementById('adminPasswordInput');
      if (pwInput) pwInput.value = '';
      if (pwWrap) pwWrap.style.display = 'none';

      selectedUser = null;
      selectedAction = null;
    }

    async function confirmAction() {
      let url = '';
      let payload = {};

      if (selectedAction === 'extend' || selectedAction === 'cancel') {
        url = '/api/admin/update-subscription';
        payload = { userId: selectedUser, action: selectedAction };
      } else if (selectedAction === 'grant_admin' || selectedAction === 'revoke_admin') {
        url = '/api/admin/update-role';
        payload = { userId: selectedUser, makeAdmin: selectedAction === 'grant_admin' };
      } else if (selectedAction === 'delete_user') {
        url = '/api/admin/delete-user';

        const pwInput = document.getElementById('adminPasswordInput');
        const adminPassword = pwInput ? pwInput.value.trim() : '';
        if (!adminPassword) {
          alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          if (pwInput) pwInput.focus();
          return;
        }
        payload = { userId: selectedUser, adminPassword };
      }

      if (!url) {
        closeModal();
        return;
      }

      try {
        const res  = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        alert(data.message || (res.ok ? 'ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìš”ì²­ ì‹¤íŒ¨'));
      } catch (e) {
        alert('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        closeModal();
        loadUsers();
      }
    }

// ===== í”Œëœ ë³€ê²½ (ìˆ˜ì •ëœ ë²„ì „) =====
async function changePlan(selectEl) {
  const userId = selectEl.dataset.userId;
  const plan   = selectEl.value;
  if (!userId) return;

  const msg = plan
    ? 'ì´ ì‚¬ìš©ìì˜ êµ¬ë… í”Œëœì„ ' + plan.toUpperCase() + 'ë¡œ ë³€ê²½í• ê¹Œìš”?'
    : 'ì´ ì‚¬ìš©ìì˜ êµ¬ë… í”Œëœì„ ì œê±°í• ê¹Œìš”?';
  if (!confirm(msg)) {
    loadUsers();
    return;
  }

  try {
    const res = await fetch('/api/admin/update-plan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ userId, plan })
    });

    const raw = await res.text();
    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      data = { success: false, message: raw };
    }

    if (!res.ok || !data || !data.success) {
      const errMsg =
        '[' + res.status + '] ' + (data && data.message ? data.message : (raw || 'í”Œëœ ë³€ê²½ ì‹¤íŒ¨'));
      throw new Error(errMsg);
    }

    alert(data.message || 'í”Œëœì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    loadUsers();
  } catch (e) {
    console.error('changePlan error:', e);
    alert(
      'í”Œëœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n' +
      'ì‚¬ìœ : ' + e.message + '\n\n' +
      'ì ê²€:\n' +
      '1) ì„œë²„ ì¬ê¸°ë™\n' +
      '2) /api/admin/update-plan ë¼ìš°í„° ì •ìƒ ë™ì‘ í™•ì¸\n' +
      '3) í˜„ì¬ í˜ì´ì§€ê°€ admin_Membership.htmlì¸ì§€ í™•ì¸'
    );
    loadUsers();
  }
}

    // ê²€ìƒ‰: ì•„ì´ë”” / ì´ë©”ì¼ / ì´ë¦„ + ê´€ë¦¬ì ë³´ê¸° + êµ¬ë… í”Œëœ í•„í„°
    function filterTable() {
      const inputEl  = document.getElementById("searchInput");
      const adminChk = document.getElementById("showAdminCheckbox");
      const planSel  = document.getElementById("planFilter");

      const keyword    = (inputEl?.value || '').toLowerCase();
      const showAdmins = !adminChk || adminChk.checked;        // ì²´í¬ ì—†ìœ¼ë©´ ê¸°ë³¸ true
      const planFilter = (planSel?.value || '').toLowerCase(); // '' | none | basic | standard | pro

      const rows = document.getElementById("userTbody").getElementsByTagName("tr");

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];

        const id    = (row.dataset.id    || '').toLowerCase();
        const email = (row.dataset.email || '').toLowerCase();
        const name  = (row.dataset.name  || '').toLowerCase();
        const isAdmin = row.dataset.isAdmin === '1';
        const rowPlan = (row.dataset.plan || '').toLowerCase(); // none | basic | standard | pro

        // 1) ê´€ë¦¬ì ë³´ê¸° ì²´í¬ í•´ì œë©´ ê´€ë¦¬ì ìˆ¨ê¹€
        if (!showAdmins && isAdmin) {
          row.style.display = "none";
          continue;
        }

        // 2) êµ¬ë… í”Œëœ í•„í„°
        if (planFilter) {
          if (planFilter === 'none') {
            if (rowPlan !== 'none') {
              row.style.display = "none";
              continue;
            }
          } else {
            if (rowPlan !== planFilter) {
              row.style.display = "none";
              continue;
            }
          }
        }

        // 3) ê²€ìƒ‰ì–´ í•„í„° (ì•„ì´ë”” / ì´ë©”ì¼ / ì´ë¦„)
        const text = id + ' ' + email + ' ' + name;
        row.style.display = text.includes(keyword) ? "" : "none";
      }
    }

    // ===== ê²€ìƒ‰ì°½ ìë™ì™„ì„± ì´ˆê¸°í™” (ê¸°ì¡´) =====
    function resetSearchBox() {
      const s = document.getElementById('searchInput');
      if (!s) return;
      s.value = '';
      s.setAttribute('value', '');
    }

    // DOM ì¤€ë¹„ ì‹œ: íƒ­, ì°¨íŠ¸ ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      resetSearchBox();
      initTabs();
      initChartControls();
    });

    // window load ì‹œ: ê²€ìƒ‰ì°½ ëª‡ ë²ˆ ë” ë¦¬ì…‹ + íšŒì› ëª©ë¡ ë¡œë“œ
    window.addEventListener('load', async () => {
      resetSearchBox();
      setTimeout(resetSearchBox, 50);
      setTimeout(resetSearchBox, 200);

      // ğŸ”¹ íšŒì› ëª©ë¡ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê³  userMap ë§Œë“  ë‹¤ìŒì—
      await loadUsers();        // users + userMap ì¤€ë¹„
      // ğŸ”¹ ê·¸ ë‹¤ìŒ ì—…ë¡œë“œ íŒ¨ë„ ê·¸ë¦¬ê¸°
      loadUploadPanels();       // ì—…ë¡œë“œ í™•ì¸/ì œì‘ ì§„í–‰ íŒ¨ë„
    });

    window.addEventListener('pageshow', resetSearchBox);
  </script>
</body>
</html>
