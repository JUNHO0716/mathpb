<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex, nofollow">
  <title>íšŒì›ê´€ë¦¬ | ê´€ë¦¬ìí˜ì´ì§€</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 40px;
    }
    h1 { font-size: 24px; margin-bottom: 20px; }
    .search-bar { margin-bottom: 20px; }
    .search-bar input {
      padding: 8px 12px; width: 300px;
      font-size: 14px; border: 1px solid #ccc;
      border-radius: 6px;
    }
    table {
      width: 100%; border-collapse: collapse;
      background: #fff; border: 1px solid #ddd;
    }
    th, td {
      padding: 12px; text-align: center;
      border-bottom: 1px solid #eee;
    }
    th { background: #f1f1f1; font-weight: 600; }
    .btn {
      padding: 6px 12px; font-size: 14px;
      border: none; border-radius: 4px;
      cursor: pointer;
    }
    .btn-extend { background: #4CAF50; color: #fff; }
    .btn-cancel { background: #f44336; color: #fff; }
    .modal-overlay {
      display: none; position: fixed; z-index: 9999;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
    }
    .modal { background: #fff; padding: 20px; border-radius: 8px; width: 360px; margin: 200px auto; }
    .modal-buttons { text-align: right; margin-top: 20px; }
    .modal-buttons button { margin-left: 8px; }

    /* â–¼â–¼ ì¶”ê°€: ê¶Œí•œ/í”Œëœ/êµ¬ë… ë°°ì§€ */
    .role-badge{padding:4px 8px;border-radius:12px;border:1px solid #ddd;display:inline-block;margin-right:6px;}
    .role-admin{background:#eef5ff;}
    .role-user{background:#f6f6f6;}
    .plan-badge{padding:3px 8px;border-radius:12px;font-size:12px;border:1px solid #e5e7eb;margin-right:6px;display:inline-block}
    .plan-basic{background:#f3f4f6;color:#6b7280;}
    .plan-standard{background:#eafaf1;color:#15803d;border-color:#ccebd8;}
    .plan-pro{background:#eef2ff;color:#4338ca;border-color:#d9ddff;}
    .substate{font-size:12px;color:#6b7280;}
    .substate.on{color:#16a34a;}
    .modal {
      background: #fff; padding: 24px; border-radius: 8px;
      width: 300px; margin: 150px auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-buttons { text-align: right; margin-top: 20px; }
    .modal-buttons button { margin-left: 8px; }
  </style>
</head>
<body>
  <h1>íšŒì› ê´€ë¦¬</h1>

  <div class="search-bar">
    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ì•„ì´ë””, ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰" />
  </div>

  <table id="userTable">
    <thead>
        <tr>
          <th>ì•„ì´ë””</th>
          <th>ì´ë©”ì¼</th>
          <th>ì´ë¦„</th>
          <th>ê°€ì…ì¼</th>
          <th>êµ¬ë… ìƒíƒœ</th>
          <th>êµ¬ë… í”Œëœ</th>   <!-- âœ… Basic / Standard / Pro -->
          <th>ì‹œì‘ì¼</th>
          <th>ì¢…ë£Œì¼</th>
          <th>ê¶Œí•œ</th>        <!-- âœ… ì¶”ê°€ -->
          <th>ê´€ë¦¬</th>
        </tr>
        </thead>
    <tbody id="userTbody">
      <!-- JSì—ì„œ ë¶ˆëŸ¬ì˜´ -->
    </tbody>
  </table>

  <!-- ëª¨ë‹¬ -->
  <div id="subscriptionModal" class="modal-overlay">
    <div class="modal">
      <p id="modalText">ì´ ì‚¬ìš©ìì˜ êµ¬ë…ì„ ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div class="modal-buttons">
        <button onclick="confirmAction()">âœ… í™•ì¸</button>
        <button onclick="closeModal()">âŒ ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <script>
    let selectedUser = null;
    let selectedAction = null;

    async function loadUsers() {
      const res = await fetch('/api/admin/users', { credentials: 'include' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.success) {
        console.error('íšŒì› ë¡œë“œ ì‹¤íŒ¨:', data);
        alert(data.message || 'íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

    const users = data.users || [];
    const tbody = document.getElementById('userTbody');
    tbody.innerHTML = '';

    users.forEach(u => {
      const isAdmin     = !!u.isAdmin;              // ì‘ë‹µì€ isAdmin í‚¤ë¡œ ë“¤ì–´ì˜´
      const currentPlan = (u.plan || '').toLowerCase();
        const subscribedByPlan = ['basic','standard','pro'].includes(currentPlan); // âœ… ì„¸ í”Œëœì€ ëª¨ë‘ 'êµ¬ë…'
      const planClass   = currentPlan ? `plan-${currentPlan}` : '';
      const planLabel   = currentPlan ? (currentPlan[0].toUpperCase() + currentPlan.slice(1)) : '';

      const row = document.createElement('tr');
      // ğŸ” ì‹œì‘/ì¢…ë£Œì¼ í‚¤ ë‹¤ì–‘ì„± í¡ìˆ˜
      const subStart = u.subscription_start ?? u.sub_start ?? u.plan_start ?? u.start_at ?? u.start_date ?? null;
      const subEnd   = u.subscription_end   ?? u.sub_end   ?? u.plan_end   ?? u.end_at   ?? u.end_date   ?? null;

      row.innerHTML = `
        <td>${u.id}</td>
        <td>${u.email}</td>
        <td>${u.name}</td>
        <td>${u.created_at?.slice(0,10) || '-'}</td>
        <td style="color:${currentPlan ? 'green' : 'gray'}">
          ${
            currentPlan
              ? (currentPlan==='basic' ? 'ë² ì´ì§' : currentPlan==='standard' ? 'ìŠ¤íƒ ë‹¤ë“œ' : currentPlan==='pro' ? 'í”„ë¡œ' : currentPlan)
              : 'ë¯¸êµ¬ë…'
          }
        </td>
        <td>
          <select data-user-id="${u.id}" onchange="changePlan(this)">
            <option value="">-</option>
            <option value="basic" ${currentPlan === 'basic' ? 'selected' : ''}>Basic</option>
            <option value="standard" ${currentPlan === 'standard' ? 'selected' : ''}>Standard</option>
            <option value="pro" ${currentPlan === 'pro' ? 'selected' : ''}>Pro</option>
          </select>
        </td>
        <td>${subStart ? String(subStart).slice(0,10) : '-'}</td>
        <td>${subEnd ? String(subEnd).slice(0,10) : '-'}</td>
        <td>
          <span class="role-badge ${isAdmin ? 'role-admin' : 'role-user'}">${isAdmin ? 'ê´€ë¦¬ì' : 'ì¼ë°˜'}</span>
        </td>
        <td>
          <button class="btn btn-extend" onclick="openModal('extend','${u.id}')">ğŸ”„ ì—°ì¥</button>
          <button class="btn btn-cancel" onclick="openModal('cancel','${u.id}')">âŒ í•´ì§€</button>
          ${
            isAdmin
              ? `<button class="btn" style="margin-left:6px;background:#ff9800;color:#fff" onclick="openModal('revoke_admin','${u.id}')">ê´€ë¦¬ì í•´ì œ</button>`
              : `<button class="btn" style="margin-left:6px;background:#3f51b5;color:#fff" onclick="openModal('grant_admin','${u.id}')">ê´€ë¦¬ì ë¶€ì—¬</button>`
          }
        </td>
      `;
      tbody.appendChild(row);
    });

    }

    function openModal(action, userId) {
      selectedUser = userId;
      selectedAction = action;

      let text = '';
      if (action === 'extend') text = `'${userId}' ì‚¬ìš©ìì˜ êµ¬ë…ì„ ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      else if (action === 'cancel') text = `'${userId}' ì‚¬ìš©ìì˜ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      else if (action === 'grant_admin') text = `'${userId}' ì‚¬ìš©ìì—ê²Œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      else if (action === 'revoke_admin') text = `'${userId}' ì‚¬ìš©ìì˜ ê´€ë¦¬ì ê¶Œí•œì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

      document.getElementById('modalText').innerText = text;
      document.getElementById('subscriptionModal').style.display = 'block';
    }

      // âœ… ì¶”ê°€: ëª¨ë‹¬ ë‹«ê¸°
  function closeModal() {
    const m = document.getElementById('subscriptionModal');
    if (m) m.style.display = 'none';
    selectedUser = null;
    selectedAction = null;
  }

async function confirmAction() {
  let url = '';
  let payload = {};

  if (selectedAction === 'extend' || selectedAction === 'cancel') {
    url = '/api/admin/update-subscription';
    payload = { userId: selectedUser, action: selectedAction };
  } else if (selectedAction === 'grant_admin' || selectedAction === 'revoke_admin') {
    url = '/api/admin/update-role';
    payload = { userId: selectedUser, makeAdmin: selectedAction === 'grant_admin' };
  }

  try {
    const res  = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',            // ğŸ‘ˆ ì¶”ê°€
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    alert(data.message || (res.ok ? 'ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìš”ì²­ ì‹¤íŒ¨'));
  } catch (e) {
    alert('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  } finally {
    closeModal();
    loadUsers();
  }
}

async function changePlan(selectEl) {
  const userId = selectEl.dataset.userId;
  const plan   = selectEl.value;   // '', 'basic', 'standard', 'pro'
  if (!userId) return;

  const msg = plan
    ? `ì´ ì‚¬ìš©ìì˜ êµ¬ë… í”Œëœì„ ${plan.toUpperCase()}ë¡œ ë³€ê²½í• ê¹Œìš”?`
    : 'ì´ ì‚¬ìš©ìì˜ êµ¬ë… í”Œëœì„ ì œê±°í• ê¹Œìš”?';
  if (!confirm(msg)) {
    loadUsers();
    return;
  }

  try {
    const res = await fetch('/api/admin/update-plan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ userId, plan })
    });

    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); } catch { data = { success:false, message: raw }; }

    if (!res.ok || !data?.success) {
      throw new Error(`[${res.status}] ${data?.message || raw || 'í”Œëœ ë³€ê²½ ì‹¤íŒ¨'}`);
    }

    alert(data.message || 'í”Œëœì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    loadUsers();
  } catch (e) {
    console.error('changePlan error:', e);
    alert(`í”Œëœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : ${e.message}\n\nì ê²€:\n1) ì„œë²„ ì¬ê¸°ë™\n2) http://localhost:3001/api/admin/_ping-update-plan ì ‘ì†í•´ { ok:true } í™•ì¸\n3) í˜„ì¬ í˜ì´ì§€ê°€ admin_Membership.htmlì¸ì§€ í™•ì¸`);
    loadUsers();
  }
}


    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.getElementById("userTbody").getElementsByTagName("tr");

      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        const match = [0,1,2].some(j => cells[j].innerText.toLowerCase().includes(input));
        rows[i].style.display = match ? "" : "none";
      }
    }

    loadUsers();
  </script>
</body>
</html>
