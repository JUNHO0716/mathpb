<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=1200" />
<title>ì¤‘ë“± ê¸°ì¶œìë£Œ ë¦¬ìŠ¤íŠ¸</title>

<!-- ì•„ì´ì½˜ & í°íŠ¸ -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:700,400&display=swap" rel="stylesheet" />

  <!-- âœ… ê³µí†µ css ë¶ˆëŸ¬ì˜¤ê¸° -->
  <link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="footer.css">
<style>
/* ========== ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ (black / gray / light-gray) ========== */
:root{
  --c-main:#111;            /* ê±°ì˜ ê²€ì • */
  --c-text:#4b4f55;         /* ì§„íšŒìƒ‰ */
  --c-light:#f4f5f7;        /* ì˜…ì€ íšŒìƒ‰ ë°°ê²½ */
  --c-border:#e3e6ea;       /* ì•„ì£¼ ì˜…ì€ íšŒìƒ‰ ì„  */
  --c-btn:#FDC512;          /* ë²„íŠ¼ ê¸°ë³¸ */
  --c-btn-hov:#D9A90F;         /* ë²„íŠ¼ hover */
  --c-accent:#202020;       /* (í‘œì‹œìš©) ì´ˆë¡â€“ìƒíƒœ */
}

*{box-sizing:border-box;font-family:'Noto Sans KR',sans-serif;margin:0;}
body{background:#ffffff;;color:var(--c-text);min-height:100vh;display:flex;flex-direction:column;}

/* ---------- í—¤ë” ---------- */
.page-header{
  padding:28px 40px 16px;display:flex;justify-content:space-between;align-items:center;
  background:#fff;border-bottom:1px solid var(--c-border);
}
.header-titles h1{font-size:1.55rem;font-weight:900;color:var(--c-main);}
.sub-date{margin-top:4px;font-size:.95rem;font-weight:700;color:var(--c-text);}
.header-actions{display:flex;gap:16px;}

.action-btn{
  background:var(--c-btn);color:#111;font-weight:700;font-size:.93rem;
  padding:8px 22px;border-radius:9999px;display:flex;gap:8px;align-items:center;text-decoration:none;
  transition:.15s;
}
.action-btn:hover{background:var(--c-btn-hov);}

/* ---------- í”„ë¡œí•„ ---------- */
.user-wrapper{position:relative;}
.user-box{display:flex;align-items:center;gap:14px;cursor:pointer;}
.avatar{width:42px;height:42px;border-radius:50%;background:#ddd;object-fit:cover;}
.user-name{font-weight:700;color:var(--c-main);white-space:nowrap;}
.dropdown{
  display:none;position:absolute;right:0;top:calc(100% + 6px);min-width:170px;z-index:30;
  background:#fff;border:1px solid var(--c-border);border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,.06);
}
.dropdown a{display:block;padding:10px 18px;font-size:.92rem;color:var(--c-main);text-decoration:none;}
.dropdown a:hover{background:var(--c-light);}

/* ---------- ë©”ì¸ ì»¨í…Œì´ë„ˆ ---------- */
.wrapper{
  width:95%;               /* âœ â‘  í­ ë„“ê²Œ */
  max-width:none;
  margin:40px auto 0;
}

/* ---------- íˆ´ë°” & í•„í„° ---------- */
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;}
.filter-set{display:flex;gap:10px;flex:1 1 0;}

.filter{
  appearance:none;                /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±°   */
  outline:none !important;        /* Windows íŒŒë€/ê²€ì€ ìœ¤ê³½ ì œê±°  */
  border:1px solid var(--c-border);
  border-radius:6px;
  padding:0 36px 0 12px;
  background:#fff
    url("data:image/svg+xml,%3Csvg viewBox='0 0 20 20' fill='%23343a40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 7l5 6 5-6H5z'/%3E%3C/svg%3E")
    no-repeat right 12px center/12px 12px;
}
.filter:focus{
  border-color:var(--c-main);     /* ê²€ì •ìœ¼ë¡œë§Œ í•œ ë²ˆ */
  box-shadow:none;                /* ë”ë¸” í…Œë‘ë¦¬ ë°©ì§€ */
}
/* ìœˆë„ìš° Â· Edge ì˜ íŒŒë€ ê¸°ë³¸ í™”ì‚´í‘œ ìˆ¨ê¹€ */
.filter::-ms-expand{display:none;}

/* (ì„ íƒ) ë˜í¼ë¥¼ ì“¸ ê²½ìš° width ê³„ì‚° ë¬¸ì œ ë°©ì§€ */
.select-wrap{position:relative;display:inline-block;}

.btn{
  height:38px;padding:0 20px;border:none;border-radius:6px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;
  transition:background .15s;font-size:.93rem;
}
.btn--search{background:var(--c-accent);color:#fff;}
.btn--search:hover{background:#4a4a4a;}
.btn--primary{background:var(--c-btn);color:#fff;}
.btn--primary:hover{background:var(--c-btn-hov);}

/* ---------- í…Œì´ë¸” ---------- */
.table-wrap{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.05);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead{background:var(--c-light);color:var(--c-main);font-weight:700;}
th,td{padding:10px 8px;font-size:.9rem;text-align:center;}
tbody tr{border-bottom:1px solid var(--c-border);}
tbody tr:hover{background:#f7f9fb;}

/* ìƒíƒœ ì  & ë±ƒì§€ */
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;background:var(--c-accent);}
.badge{padding:2px 10px;border-radius:12px;font-size:.78rem;font-weight:700;color:#fff;}
.badge--green{background:var(--c-accent);}
.badge--red{background:#ff5b62;}

/* ì‘ì—… ë²„íŠ¼ */
.act-btn{
  background:#fff;border:1px solid var(--c-accent);color:var(--c-accent);
  padding:4px 12px;border-radius:4px;font-size:.8rem;font-weight:700;cursor:pointer;transition:.15s;
}
.act-btn:hover{background:var(--c-accent);color:#fff;}

/* ---------- í˜ì´ì§€ë„¤ì´ì…˜ ---------- */
.pagination{display:flex;justify-content:center;gap:8px;margin:28px 0;}
.page{
  width:36px;height:36px;display:flex;align-items:center;justify-content:center;
  border:1px solid var(--c-border);border-radius:4px;background:#fff;color:var(--c-main);cursor:pointer;transition:.15s;
}
.page:hover{background:var(--c-light);}
.page.active{background:var(--c-accent);border-color:var(--c-accent);color:#fff;pointer-events:none;}

@media (max-width:1024px){
  .filter-set{flex-wrap:wrap;gap:6px;}
  .toolbar{gap:10px;}
}

.page-banner{
  width:100%;
  background:#ffffff;
  color:#111;
  padding:70px 0;
  border-bottom:1px solid #000000;
}
.page-banner .inner{
  max-width:1400px;
  margin:0 auto;
  padding:0 40px;
}
.page-banner h2{
  font-size:2.4rem;
  font-weight:900;
  margin:0 0 14px 0;
}
.page-banner p{
  font-size:1.05rem;
  line-height:1.5;
  opacity:.85;
  margin:0;
}

.highlight {
  position: relative;
  display: inline-block;
}

.highlight::before {
  content: "";
  position: absolute;
  top: -4px;      /* ê¸€ì ìœ„ ìœ„ì¹˜ */
  left: 0;
  width: 30px;    /* ì„  ê¸¸ì´ */
  height: 5px;    /* ì„  êµµê¸° */
  background: #f8c900;  /* ë…¸ë€ìƒ‰ */
  border-radius: 2px;
}

.bar-sep {
  color: #f8c900;
  font-weight: 1000;
}

.level-toggle-container {
  display: inline-flex;
  align-items: center;
  margin-left: 20px;  /* ë” ë„ì›€ */
  gap: 10px;          /* ìŠ¤ìœ„ì¹˜ì™€ ê¸€ì ì‚¬ì´ ë” ë„ì›€ */
  font-size: 0.98rem;
  font-weight: 700;
}

/* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
.switch {
  position: relative;
  display: inline-block;
  width: 52px;
  height: 28px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top:0; left:0; right:0; bottom:0;
  background-color: var(--c-btn); /* í•­ìƒ ë…¸ë€ìƒ‰ */
  transition: .4s;
  border-radius: 28px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 22px; width: 22px;
  left: 3px; bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider:before {
  transform: translateX(24px);
}

.with-toggle {
  display: flex;
  align-items: flex-end; /* ê¸€ í•˜ë‹¨ì— ì •ë ¬ */
  gap: 18px;
}
.with-toggle .level-toggle-container {
  margin: 0;
  position: relative; top: -7px;
  bottom: 0; /* í•„ìš”ì‹œ -2px, -4pxë¡œ ë¯¸ì„¸ì¡°ì • */
}
td.download-cell {
  white-space: nowrap;
}
.download-btn {
  display: inline-block;
  margin-right: 4px;  /* ë²„íŠ¼ ì‚¬ì´ ì—¬ë°± */
  vertical-align: middle;
}
.download-btn:last-child {
  margin-right: 0;
}

.swal2-actions-center { justify-content: center !important; }

</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<section class="page-banner">
  <div class="inner">
    <h2 class="with-toggle">
  ì¤‘ë“±ê´€ <span class="bar-sep">|</span> ê¸°ì¶œìë£Œ 
  <span class="level-toggle-container">
    <label class="switch">
      <input type="checkbox" id="levelToggle" checked>
      <span class="slider"></span>
    </label>
    <span id="levelText">ì¤‘ë“±</span> 
  </span>
  </h2>
    <p>ì „êµ­ í•™êµë³„ ê¸°ì¶œìë£Œë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•˜ê³ , í•„ìš”í•œ ìë£Œë¥¼ ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”.</p>
  </div>
</section>

<div class="wrapper">
  <!-- â”€â”€â”€ íˆ´ë°” â”€â”€â”€ -->
  <div class="toolbar">
    <div class="filter-set">
      <select id="region"   class="filter"><option value="">ì§€ì—­</option><option>ì„œìš¸</option><option>ê²½ê¸°</option></select>
      <input  id="district" class="filter" placeholder="êµ¬/êµ°">
      <input  id="school"   class="filter" placeholder="í•™êµëª…">
      <select id="grade"    class="filter"><option value="">í•™ë…„</option><option>ì¤‘1</option><option>ì¤‘2</option><option>ì¤‘3</option></select>
      <input  id="year"     class="filter" placeholder="ì—°ë„" type="number">
      <select id="semester" class="filter"><option value="">í•™ê¸°</option><option>1í•™ê¸°ì¤‘ê°„</option><option>1í•™ê¸°ê¸°ë§</option><option>2í•™ê¸°ì¤‘ê°„</option><option>2í•™ê¸°ê¸°ë§</option></select>
      <button class="btn btn--search" onclick="searchFiles()"><i class="fa-solid fa-magnifying-glass"></i> ê²€ìƒ‰</button>
      <button id="uploadBtn" class="btn btn--primary" style="display:none;margin-left:8px;">
      <i class="fa-solid fa-upload"></i> ì‹œí—˜ì§€ ì—…ë¡œë“œ
    </button>
      <button id="manageBtn" class="btn btn--primary" style="display:none;margin-left:8px;">
      <i class="fa-solid fa-gears"></i> ì‹œí—˜ì§€ ê´€ë¦¬
    </button>
    </div>
  </div>

  <!-- â”€â”€â”€ í…Œì´ë¸” â”€â”€â”€ -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:60px">No</th>
          <th style="text-align:left;padding-left:18px">ìë£Œëª…</th>
          <th>í•™ë…„</th>
          <th>í•™ê¸°</th>
          <th>ì—°ë„</th>
          <th>ì—…ë¡œë“œì¼</th>
          <th style="width:170px">ë‹¤ìš´ë¡œë“œ</th>
        </tr>
      </thead>
      <tbody id="file-list"><!-- JS ì‚½ì… --></tbody>
    </table>
  </div>

  <!-- â”€â”€â”€ í˜ì´ì§€ë„¤ì´ì…˜ â”€â”€â”€ -->
  <div class="pagination" id="pagination"></div>
</div>

<script>
let currentUser = null;

/* ===== íŒŒì¼ ë¡œë“œ / ë Œë” ===== */
let fileData = [];
let currentPage = 1;
const pageSize = 30;  // ğŸ”¥ ì—¬ê¸°ì„œ 30ê°œë¡œ ì„¤ì •


async function fetchFiles() {
  const params = new URLSearchParams({
    region:   region.value,
    district: district.value.trim(),
    school:   school.value.trim(),
    grade:    grade.value,
    year:     year.value.trim(),
    semester: semester.value
  });
  params.append('level', 'ì¤‘ë“±');

  const res = await fetch('/api/files?' + params.toString());
  fileData = await res.json();
  currentPage = 1;  // ê²€ìƒ‰ì‹œ 1í˜ì´ì§€
  renderPage();
}


function searchFiles(){fetchFiles();}

// ë‚ ì§œ YYYY-MM-DDë¡œ ë³€í™˜ í•¨ìˆ˜
function formatDate(dateString) {
  if(!dateString) return '';
  const d = new Date(dateString);
  if(isNaN(d)) return (dateString.split('T')[0] || dateString);
  return d.toISOString().slice(0, 10);
}

function renderTable(list) {
  const tb = document.getElementById('file-list');

  if (!list.length) {
    tb.innerHTML = '<tr><td colspan="7" style="padding:20px;color:#9ba4b0;">ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }

tb.innerHTML = list.map((row, i) => `
  <tr>
    <td>${(currentPage - 1) * pageSize + i + 1}</td>
      <td style="text-align:left;padding-left:18px">
        ${row.title}
        ${
          row.tag
            ? `<span class="badge badge--${row.tag === 'í†µê³¼' ? 'green' : 'red'}" style="margin-left:6px;">${row.tag}</span>`
            : ''
        }
      </td>
      <td>${row.grade || ''}</td>
      <td>${row.semester || ''}</td>
      <td>${row.year || ''}</td>
      <td>${formatDate(row.uploaded_at || row.date)}</td>
      <td>
        <button class="download-btn" title="PDF ë‹¤ìš´ë¡œë“œ" onclick="downloadFile('${row.id}','pdf')"
          style="background:none;border:none;cursor:pointer;">
          <img src="/pdf_download.png" alt="PDF ë‹¤ìš´ë¡œë“œ" style="width:32px;height:32px;">
        </button>
        <button class="download-btn" title="HWP ë‹¤ìš´ë¡œë“œ" onclick="downloadFile('${row.id}','hwp')"
          style="background:none;border:none;cursor:pointer;">
          <img src="/hwp_download.png" alt="HWP ë‹¤ìš´ë¡œë“œ" style="width:32px;height:32px;">
        </button>
      </td>
    </tr>
  `).join('');
}

function renderPage(){
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const list = Array.isArray(fileData) ? fileData : (fileData.items || []);
  const pageData = list.slice(start, end);
  renderTable(pageData);
  renderPagination();
}

function renderPagination(){
  const list = Array.isArray(fileData) ? fileData : (fileData.items || []);
  const totalPages = Math.ceil(list.length / pageSize) || 1;
  const p = document.getElementById('pagination');
  p.innerHTML = '';
  for(let i=1; i<=totalPages; i++){
    const d = document.createElement('div');
    d.className = 'page' + (i === currentPage ? ' active' : '');
    d.textContent = i;
    if(i !== currentPage) {
      d.onclick = () => {
        currentPage = i;
        renderPage();
      };
    }
    p.appendChild(d);
  }
}
/* ===== ê¸°íƒ€ UI ì´ˆê¸°í™” ===== */
function setToday(){
  const t=new Date(),wk=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
        mo=['January','February','March','April','May','June','July','August','September','October','November','December'];
  todayTxt.textContent=`${wk[t.getDay()]}  ${String(t.getDate()).padStart(2,'0')} ${mo[t.getMonth()]} ${t.getFullYear()}`;
}
function initDropdown(){
  userBox.onclick=e=>{
    e.stopPropagation();const open=dropdownMenu.style.display==='block';
    dropdownMenu.style.display=open?'none':'block';
    arrowIcon.style.transform=open?'rotate(0deg)':'rotate(180deg)';
  };
  document.onclick=e=>{
    if(!dropdownMenu.contains(e.target)){dropdownMenu.style.display='none';arrowIcon.style.transform='rotate(0deg)';}
  };
}

/* ===== ë”ë¯¸ ===== */
const editRow=id=>alert('í¸ì§‘ '+id);
const deleteRow=id=>confirm('ì‚­ì œ?')&&alert('ì‚­ì œ '+id);

/* ===== ì‹œì‘ ===== */
window.onload=()=>{
  showAdminButtons();
  fetchFiles();  // âœ… ì´ë ‡ê²Œ ìˆ˜ì •
};


async function showAdminButtons(){
  try{
    const {isLoggedIn,user={}} = await (await fetch('/check-auth',{credentials:'include'})).json();
    if(isLoggedIn){
      currentUser = user; // âœ… ì´ ì¤„ ê¼­ í•„ìš”
      if(user.role==='admin'){
        const uploadBtn = document.getElementById('uploadBtn');
        const manageBtn = document.getElementById('manageBtn');
        if(uploadBtn){
          uploadBtn.style.display = 'inline-flex';
          uploadBtn.onclick = ()=> location.href = 'admin_upload.html';
        }
        if(manageBtn){
          manageBtn.style.display = 'inline-flex';
          manageBtn.onclick = () => location.href = 'admin_files.html';
        }
      }
    }
  }catch(e){
    console.error('ê´€ë¦¬ì ì²´í¬ ì‹¤íŒ¨', e);
  }
}

document.getElementById('levelToggle').addEventListener('click', function(){
  const levelText = document.getElementById('levelText');
  if(levelText.textContent === 'ê³ ë“±'){
    levelText.textContent = 'ì¤‘ë“±';
    location.href = 'middle.html';
  }else{
    levelText.textContent = 'ê³ ë“±';
    location.href = 'high.html';
  }
});

function downloadFile(id, type) {
  if (!currentUser || (!currentUser.hasPaid && currentUser.role !== 'admin')) {
    Swal.fire({
      icon: 'warning',
      title: 'ë‹¤ìš´ë¡œë“œ ê¶Œí•œ ì—†ìŒ',
      text: 'ê²°ì œ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.',
      showCancelButton: true,
      showConfirmButton: false,
      cancelButtonText: 'ë‹«ê¸°',
      cancelButtonColor: '#444',
      background: '#1a1a1a',
      color: '#ffffff',
      iconColor: '#FDC512',
      customClass: { actions: 'swal2-actions-center' }
    });
    return;
  }

  const url = `/api/download/${id}?type=${encodeURIComponent(type)}`;
  window.location.href = url;
}
</script>
<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-brand">M.class</div>
    <div>ëŒ€í‘œ: ã…‡ã…‡ã…‡ ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸: 205-08-14537 í†µì‹ íŒë§¤ë²ˆí˜¸: 2025-ì„œìš¸00-0000</div>
    <div>ì´ë©”ì¼: gh_6399@naver.com ê³ ê°ì„¼í„°: 010-8310-6399</div>
    <div class="copyright">Â© 2025 Mathbee All rights reserved.</div>
  </div>
</footer>
</body>
</html>
