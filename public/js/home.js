// index.jsÍ∞Ä Ïù¥ ÌéòÏù¥ÏßÄÎ•º Î∂àÎü¨Ïò® Îí§ Ïã§ÌñâÌï† Ïàò ÏûàÎèÑÎ°ù Ï†ÑÏ≤¥Î•º Ìï®ÏàòÎ°ú Í∞êÏåâÎãàÎã§.
window.initializeHomePage = function(user) {

  // --- ÏõêÎ≥∏ Ïä§ÌÅ¨Î¶ΩÌä∏ Í∏∞Îä• 100% Ïú†ÏßÄ ---
  
  // 1. Í¥ëÍ≥† Î∞∞ÎÑà Ïä¨ÎùºÏù¥Îçî Ïã§Ìñâ
  const adSwiper = new Swiper('.home-ad-swiper', {
    loop: true,
    grabCursor: true,
    autoplay: { delay: 5000 },
    pagination: {
      el: '.home-ad-swiper-pagination',
      clickable: true,
    },
  });

  // 2. ÌÉ≠ Í∏∞Îä• Ïπ¥Îìú Ï∫êÎü¨ÏÖÄ Í¥ÄÎ†® Î°úÏßÅ Ïã§Ìñâ
  setupTabbedCarousel();

  // 3. ÌîÑÎ°úÌïÑ Ïπ¥Îìú ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞ Í∏∞Îä• Ïã§Ìñâ
  setupProfileToggle();

  // 4. ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî Ìï®ÏàòÎì§ Ïã§Ìñâ
  pageInit(user);
  fetchNotices();
  loadMySheetRequests();
  loadRequestStats(user);   // üëà (user) Ï†ÑÎã¨
  loadDownloadStats(user);  // üëà (user) Ï†ÑÎã¨
  loadUserStats();
  
  // 5. Í∏∞ÌÉÄ Í∏∞Îä• Ïã§Ìñâ
  setupModal(adSwiper);
  setupNoticeMoreButton();
  loadFooter();

  // --- ÏõêÎ≥∏Ïùò Î™®Îì† Í∏∞Îä• Ìï®Ïàò (100% ÎèôÏùº) ---

  function setupTabbedCarousel() {
    const cardData = {
      guide: [
        { title: 'Ïç∏ÎÑ§Ïùº ÌÖåÏä§Ìä∏ ÏòÅÏÉÅ', youtubeId: '8dJyRm2jJ-U', caption: 'ÎßÅÌÅ¨ ÎØ∏Î¶¨Î≥¥Í∏∞' },
        { title: 'AI Î¨∏Ï†úÏ∂îÏ≤ú ÌôúÏö©Î≤ï', youtubeId: 'E4wYv22gA2Y', caption: 'AI Ï∂îÏ≤ú Í∏∞Îä• ÏïåÏïÑÎ≥¥Í∏∞' },
        { title: 'Ïò§ÎãµÎÖ∏Ìä∏ 200% ÌôúÏö©!', youtubeId: 'P69h3TfkPGo', caption: 'Ïò§ÎãµÎÖ∏Ìä∏ ÌôúÏö©Î≤ï' },
        { title: '2026 ÎåÄÏûÖ Í∞úÌé∏Ïïà Î∂ÑÏÑù', youtubeId: 'a3IPhv_d_hA', caption: 'ÏûÖÏãú Ï†ÑÎûµ Î∂ÑÏÑù' },
        { title: 'Ïó¨Î¶ÑÎ∞©Ìïô ÌïôÏäµ Ï†ÑÎûµ', youtubeId: 'pCoa202G_sM', caption: 'ÏàòÌïô ÏôÑÏ†Ñ Ï†ïÎ≥µ' },
      ],
      news: [
        { title: 'Ïò§Ìîà Í∏∞ÎÖê ÌäπÎ≥Ñ Ïù¥Î≤§Ìä∏', subtitle: 'ÏßÄÍ∏à Í∞ÄÏûÖÌïòÎ©¥ ÌîÑÎ¶¨ÎØ∏ÏóÑ ÌîåÎûú 1Í∞úÏõî Î¨¥Î£å Ï≤¥Ìóò Í∏∞ÌöåÎ•º ÎìúÎ¶ΩÎãàÎã§.', caption: 'Ïù¥Î≤§Ìä∏ Î∞îÎ°úÍ∞ÄÍ∏∞', icon: 'fas fa-gift', url: 'event.html' },
        { title: 'ÏΩòÌÖêÏ∏† ÎåÄÍ∑úÎ™® ÏóÖÎç∞Ïù¥Ìä∏', subtitle: '2025ÎÖÑ Í∞úÏ†ï ÍµêÍ≥º Í≥ºÏ†ïÏùÑ Î™®Îëê Î∞òÏòÅÌïòÏó¨ ÏΩòÌÖêÏ∏†Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.', caption: 'ÏóÖÎç∞Ïù¥Ìä∏ ÎÇ¥Ïó≠', icon: 'fas fa-pen-ruler', url: '#' },
        { title: 'ÏÑúÎ≤Ñ Ï†êÍ≤Ä ÏïàÎÇ¥ (9/22)', subtitle: 'Î≥¥Îã§ ÏïàÏ†ïÏ†ÅÏù∏ ÏÑúÎπÑÏä§Î•º ÏúÑÌï¥ 22Ïùº ÏÉàÎ≤Ω ÏÑúÎ≤Ñ Ï†êÍ≤ÄÏù¥ ÏûàÏäµÎãàÎã§.', caption: 'ÏûêÏÑ∏Ìûà Î≥¥Í∏∞', icon: 'fas fa-server', url: '#' },
        { title: 'Ï†úÌú¥ÏÇ¨ Ìï†Ïù∏ Ïù¥Î≤§Ìä∏', subtitle: 'ÏÉàÎ°úÏö¥ Ï†úÌú¥ÏÇ¨ Ìï†Ïù∏ ÌòúÌÉùÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.', caption: 'Ïù¥Î≤§Ìä∏ ÌôïÏù∏', icon: 'fas fa-handshake', url: '#' },
        { title: 'ÏπúÍµ¨ Ï∂îÏ≤ú Ïù¥Î≤§Ìä∏ Î¶¨Îâ¥Ïñº', subtitle: 'ÏπúÍµ¨Î•º Ï∂îÏ≤úÌïòÍ≥† Îçî ÌÅ∞ ÌòúÌÉùÏùÑ Î∞õÏïÑÍ∞ÄÏÑ∏Ïöî! Ìë∏ÏßêÌïú ÌòúÌÉùÏù¥ Í∏∞Îã§Î¶ΩÎãàÎã§.', caption: 'Ï∞∏Ïó¨ÌïòÍ∏∞', icon: 'fas fa-user-plus', url: '#' },
      ],
      admission: [
        { title: '2026 ÎåÄÏûÖ Í∞úÌé∏Ïïà', subtitle: 'Ï£ºÏöî Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏', caption: 'Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏', icon: 'fas fa-graduation-cap', url: '#' },
        { title: '9Ïõî Î™®ÏùòÌèâÍ∞Ä Ïã¨Ï∏µ Î∂ÑÏÑù', subtitle: 'Í≥ºÎ™©Î≥Ñ ÎÇúÏù¥ÎèÑ Î∞è Îì±Í∏âÏª∑ ÏòàÏ∏°', caption: 'ÏûêÏÑ∏Ìûà Î≥¥Í∏∞', icon: 'fas fa-chart-line', url: '#' },
        { title: 'ÏàòÏãú ÏßÄÏõê Ï†ÑÎûµ ÏÑ§Î™ÖÌöå', subtitle: 'Ìï©Í≤©ÏÉù Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò, ÎÇòÎßåÏùò Ï†ÑÎûµÏùÑ ÏÑ∏ÏõåÎ≥¥ÏÑ∏Ïöî.', caption: 'Ï†ÑÎûµ ÏÑ∏Ïö∞Í∏∞', icon: 'fas fa-chalkboard-user', url: '#' },
        { title: 'ÏùòÎåÄ Ï†ïÏõê ÌôïÎåÄÏùò ÏòÅÌñ•', subtitle: 'Î≥ÄÌôîÎêú ÏûÖÏãú ÌôòÍ≤Ω, Ïñ¥ÎñªÍ≤å ÎåÄÎπÑÌï¥Ïïº Ìï†ÍπåÏöî?', caption: 'ÏòÅÌñ• Î∂ÑÏÑù', icon: 'fas fa-microscope', url: '#' },
      ]
    };

    let cardSwiper = null;

    function initCardSlider(tabId) {
      if (cardSwiper) {
        cardSwiper.destroy(true, true);
      }
      const swiperWrapper = document.querySelector('.home-cardSwiper .swiper-wrapper');
      if (!swiperWrapper) return;
      
      const slidesData = cardData[tabId] || [];
      let slidesHtml = '';
      if (tabId === 'guide') {
          slidesHtml = slidesData.map(item => `
          <div class="swiper-slide">
              <a href="https://www.youtube.com/watch?v=${item.youtubeId}" target="_blank" class="home-youtube-thumbnail">
                  <img src="https://img.youtube.com/vi/${item.youtubeId}/hqdefault.jpg" alt="${item.title}">
              </a>
              <div class="home-card-caption">${item.caption}</div>
          </div>`).join('');
      } else {
          slidesHtml = slidesData.map(item => {
              const cardContent = `<i class="home-card-icon ${item.icon || 'fas fa-info-circle'}"></i><h3>${item.title}</h3><p class="home-card-subtitle">${item.subtitle || ''}</p>`;
              const slideInnerContent = `<div class="home-card">${cardContent}</div><div class="home-card-caption">${item.caption}</div>`;
              const finalHtml = item.url ? `<a href="${item.url}" target="_blank" class="home-card-link">${slideInnerContent}</a>` : slideInnerContent;
              return `<div class="swiper-slide">${finalHtml}</div>`;
          }).join('');
      }
      swiperWrapper.innerHTML = slidesHtml;

      cardSwiper = new Swiper('.home-cardSwiper', {
        slidesPerView: 'auto',
        spaceBetween: 30,
        loop: slidesData.length > 3,
        grabCursor: true,
        autoplay: {
          delay: 3000,
          disableOnInteraction: false,
        },
      });
    }

    const tabButtons = document.querySelectorAll('.home-tab-btn');
    const tabIndicator = document.querySelector('.home-tab-indicator');
    if (!tabButtons.length || !tabIndicator) return;

    function moveIndicator(target) {
        tabIndicator.style.width = `${target.offsetWidth}px`;
        tabIndicator.style.left = `${target.offsetLeft}px`;
    }

    tabButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        const target = e.currentTarget;
        tabButtons.forEach(btn => btn.classList.remove('home-active'));
        target.classList.add('home-active');
        
        const tabId = target.dataset.tab;
        initCardSlider(tabId);
        moveIndicator(target);
      });
    });

    const initialActiveTab = document.querySelector('.home-tab-btn.home-active');
    if(initialActiveTab) {
        setTimeout(() => {
            moveIndicator(initialActiveTab);
        }, 100);
        initCardSlider(initialActiveTab.dataset.tab);
    } else {
        initCardSlider('news');
    }
  }

  function setupProfileToggle() {
      const profileCard = document.querySelector('.home-profile-card');
      const profileToggleBtn = document.querySelector('.home-profile-toggle-btn');
      if (profileToggleBtn && profileCard) {
          profileToggleBtn.addEventListener('click', () => {
              profileCard.classList.toggle('home-expanded');
          });
      }
  }

  function setupModal(adSwiper) {
      const modal = document.getElementById('adModal');
      const modalBox = document.querySelector('.home-modal-content');
      const closeBtn = document.querySelector('.home-modal-close');
      
      if (modal && modalBox && closeBtn && adSwiper) {
          document.querySelectorAll('.home-ad-swiper .swiper-slide').forEach(slide => {
              slide.addEventListener('click', () => {
                  const url = slide.dataset.url;
                  const frame = modalBox.querySelector('iframe');
                  if (frame) frame.src = url;
                  modal.style.display = 'flex';
                  adSwiper.autoplay.stop();
              });
          });

          const hideModal = () => {
              const frame = modalBox.querySelector('iframe');
              if (frame) frame.src = 'about:blank';
              modal.style.display = 'none';
              adSwiper.autoplay.start();
          };
          closeBtn.onclick = hideModal;
          modal.onclick = e => { if (e.target === modal) hideModal(); };
      }
  }

  function setupNoticeMoreButton() {
      const moreBtn = document.getElementById('noticeMoreBtn');
      if (moreBtn) {
          moreBtn.addEventListener('click', function() {
              if (window.parent && window.parent.handleChildNavigation) {
                  window.parent.handleChildNavigation({ type: 'goNoticeMore' });
              }
          });
      }
  }

  async function loadFooter() {
    try {
      const response = await fetch('footer.html');
      const footerHtml = await response.text();
      document.getElementById('footer-container').innerHTML = footerHtml;
    } catch (error) {
      console.error('Footer loading failed:', error);
    }
  }

  // --- üìû Ï†ÑÌôîÎ≤àÌò∏ Ìè¨Îß∑ÌåÖ Ìï®Ïàò Ï∂îÍ∞Ä ---
  function formatPhoneNumber(phoneStr) {
    if (!phoneStr) return '-';
    const cleaned = ('' + phoneStr).replace(/\D/g, '');
    if (cleaned.length === 11) {
      return `${cleaned.substring(0, 3)}-${cleaned.substring(3, 7)}-${cleaned.substring(7)}`;
    } else if (cleaned.length === 10) {
      return `${cleaned.substring(0, 3)}-${cleaned.substring(3, 6)}-${cleaned.substring(6)}`;
    }
    return phoneStr;
  }

function bindUser(user) { 
  if (!user) return;
    
    // --- üëá Ïó¨Í∏∞Í∞Ä ÏàòÏ†ïÎêú Î∂ÄÎ∂ÑÏûÖÎãàÎã§ (ID Î≥ÄÍ≤Ω) ---
    const profileNameCollapsed = document.getElementById('home-profileName');
    const profileEmailCollapsed = document.getElementById('home-profileEmail');
    const profileAvatar = document.getElementById('home-profileAvatar');
    if(profileNameCollapsed) profileNameCollapsed.textContent = user.name || '-';
    if(profileEmailCollapsed) profileEmailCollapsed.textContent = user.email || '-';
    if(profileAvatar) profileAvatar.src = user.avatarUrl || 'https://via.placeholder.com/74';
    
    const profileNameExpanded = document.getElementById('home-profileNameExpanded');
    const profileAvatarExpanded = document.getElementById('home-profileAvatarExpanded');
    const profileIdValue = document.getElementById('home-profileIdValue');
    const profileEmailValue = document.getElementById('home-profileEmailValue');
    const profilePhoneValue = document.getElementById('home-profilePhoneValue');
    const profilePlan = document.querySelector('.home-profile-plan');

    if(profileNameExpanded) profileNameExpanded.textContent = user.name || '-';
    if(profileAvatarExpanded) profileAvatarExpanded.src = user.avatarUrl || 'https://via.placeholder.com/90';
        if(profileIdValue) {
        let displayId = user.id || '-'; // Í∏∞Î≥∏Í∞íÏùÄ Ï†ÑÏ≤¥ ID
        // Ïù¥Î©îÏùºÏù¥ ÏûàÍ≥† '@'Î•º Ìè¨Ìï®ÌïòÎ©¥ @ ÏïûÎ∂ÄÎ∂ÑÏùÑ displayIdÎ°ú ÏÇ¨Ïö©
        if (user.email && user.email.includes('@')) {
            displayId = user.email.split('@')[0];
        }
        profileIdValue.textContent = displayId;
    }
    if(profileEmailValue) profileEmailValue.textContent = user.email || '-';
    
    if(profilePhoneValue) profilePhoneValue.textContent = formatPhoneNumber(user.phone);
    
    if(profilePlan) {
        let planText = 'Free';
        if (user.hasPaid && user.plan) {
            planText = user.plan.charAt(0).toUpperCase() + user.plan.slice(1);
        }
        if (user.role === 'admin') {
            planText = 'Admin';
        }
        profilePlan.textContent = planText;
    }
}

  async function pageInit(user) { // üëà (user) Ï∂îÍ∞Ä
    await bindUser(user); // üëà (user) Ï†ÑÎã¨
    loadRecentUploads();
    loadRecentDownloads(user); // üëà (user) Ï†ÑÎã¨
}

  async function fetchNotices() {
      let noticeData = [];
      try {
          const res = await fetch('/api/notices');
          noticeData = await res.json();
      } catch (e) {
          noticeData = [{ id: 0, title: 'Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.' }];
      }

      const listEl = document.getElementById('noticeList');
      if (!listEl) return;
      listEl.innerHTML = noticeData.slice(0, 7).map((n, i) => `
      <div class="home-notice-item">
        <span class="home-notice-num">${i + 1}</span>
        <span class="home-notice-title">${n.title}</span>
      </div>`).join('');
  }

  async function loadRecentUploads() {
    try {
      const res = await fetch('/api/uploads/recent', { credentials:'include' });
      const data = await res.json();
      const tbody = document.querySelector('.home-uploads-card .home-rf-table tbody');
      if (!tbody) return;
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;color:#aaa;">ÏµúÍ∑º ÏóÖÎ°úÎìú ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(file => `
        <tr>
          <td class="home-title" title="${(file.name || '-').replace(/"/g, '&quot;')}">${file.name}</td>
          <td>${file.date}</td>
        </tr>
      `).join('');
    } catch(e) { console.error("ÏµúÍ∑º ÏóÖÎ°úÎìú Î°úÎî© Ïã§Ìå®:", e); }
  }

  async function loadRecentDownloads(user) { // üëà (user) Ï∂îÍ∞Ä
    try {
      if (!user || !user.email) return;
      const res = await fetch('/api/downloads/recent', { credentials: 'include' });
      const data = await res.json();
      const tbody = document.getElementById('recentDownloadsTbody');
      if (!tbody) return;
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#aaa;">ÏµúÍ∑º Îã§Ïö¥Î°úÎìú ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map(row => `
        <tr>
          <td style="text-align:left;" class="home-title" title="${(row.name || '-').replace(/"/g, '&quot;')}">${row.name || '-'}</td>
          <td style="text-align:center;">${new Date(row.date).toLocaleDateString()}</td>
          <td style="text-align:center;">
            <img src="image_download/hwp_download.png" alt="HWP" style="width:24px;cursor:pointer;" onclick="window.parent.downloadFile('${row.id}', 'hwp')">
            <img src="image_download/pdf_download.png" alt="PDF" style="width:24px;cursor:pointer;" onclick="window.parent.downloadFile('${row.id}', 'pdf')">
          </td>
        </tr>
      `).join('');
    } catch (e) { console.error("ÏµúÍ∑º Îã§Ïö¥Î°úÎìú Î°úÎî© Ïã§Ìå®:", e); }
  }

  async function loadMySheetRequests() {
    try {
      const res = await fetch('/api/my-uploads', { credentials: 'include' });
      const data = await res.json();
      const tbody = document.getElementById('mysheetRequestTbody');
      if (!tbody) return;
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;color:#aaa;">ÏöîÏ≤≠Ìïú ÏãúÌóòÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
        return;
      }
      tbody.innerHTML = data.slice(0, 15).map(row => {
        // status Í∞í(Ïòà: "ÌôïÏù∏Ï§ë", "Ï†úÏûëÏ§ë", "ÏôÑÎ£å", "Î∞òÎ†§")Ïóê Îî∞Îùº Ï≤òÎ¶¨
        let badgeClass = '';
        let iconHtml = '';
        const statusText = row.status || '';

        if (statusText === 'ÌôïÏù∏Ï§ë') {
            badgeClass = 'pending';
            iconHtml = '<i class="fas fa-hourglass-half"></i>';
        } else if (statusText === 'Ï†úÏûëÏ§ë') {
            badgeClass = 'producing'; // CSS ÌÅ¥ÎûòÏä§ Ïù¥Î¶ÑÏóê ÎßûÏ∂∞ producingÏúºÎ°ú Î≥ÄÍ≤Ω
            iconHtml = '<i class="fas fa-spinner fa-spin"></i>';
        } else if (statusText === 'ÏôÑÎ£å') {
            badgeClass = 'completed';
            iconHtml = '<i class="fas fa-check"></i>';
        } else if (statusText === 'Î∞òÎ†§') {
            badgeClass = 'rejected';
            iconHtml = '<i class="fas fa-ban"></i>';
        }

        // ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú Î∞òÌôòÌïòÎäî HTML Íµ¨Ï°∞Î•º ÏÉàÎ°úÏö¥ Î∞∞ÏßÄ ÌòïÌÉúÎ°ú Î≥ÄÍ≤Ω
        return `<tr>
          <td class="home-title" title="${(row.filename || '-').replace(/"/g, '&quot;')}">${row.filename || '-'}</td>
          <td>
            <span class="status-badge ${badgeClass}">${iconHtml} ${statusText}</span>
          </td>
        </tr>`;
      }).join('');
    } catch(e) { console.error("ÎÇ¥ Î¨∏Ï†úÏßÄ ÏöîÏ≤≠ Î°úÎî© Ïã§Ìå®:", e); }
  }

    function animateCountUp(element, end, duration = 1500) {
      if (!element) return;

      // Easing Ìï®Ïàò (ÏãúÏûëÏùÄ Îπ†Î•¥Í≤å, ÎÅùÎÇ†ÏàòÎ°ù ÎäêÎ†§ÏßÄÎäî Ìö®Í≥º)
      const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        
        // 1. ÏãúÍ∞ÑÏùò ÌùêÎ¶ÑÏóê Îî∞Î•∏ ÏßÑÌñâÎ•† (0ÏóêÏÑú 1ÍπåÏßÄ)
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        
        // 2. ÏßÑÌñâÎ•†ÏùÑ Easing Ìï®ÏàòÏóê ÌÜµÍ≥ºÏãúÏºú Í∞íÏùò Î≥ÄÌôîÏóê Í≥°ÏÑ†ÏùÑ Ï§çÎãàÎã§.
        const easedProgress = easeOutCubic(progress);
        
        // 3. EasingÏù¥ Ï†ÅÏö©Îêú ÏßÑÌñâÎ•†Î°ú ÌòÑÏû¨ Ïà´ÏûêÎ•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§.
        element.textContent = Math.floor(easedProgress * end).toLocaleString();
        
        if (progress < 1) {
          window.requestAnimationFrame(step);
        }
      };
      window.requestAnimationFrame(step);
    }

  async function loadRequestStats(user) { // üëà (user) Ï∂îÍ∞Ä
  try {
      if (!user) return; // üëà Ïù¥ Ï§ÑÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî
        const res = await fetch('/api/my-uploads/stats', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch stats');
        const stats = await res.json();
        
        animateCountUp(document.getElementById('statPending'), stats.pending);
        animateCountUp(document.getElementById('statProducing'), stats.producing);
        animateCountUp(document.getElementById('statCompleted'), stats.completed);
        animateCountUp(document.getElementById('statRejected'), stats.rejected);
    } catch (e) {
        console.error("ÌÜµÍ≥Ñ Î°úÎî© Ïò§Î•ò:", e);
    }
  }

  async function loadDownloadStats(user) { // üëà (user) Ï∂îÍ∞Ä
  try {
      if (!user) return; // üëà Ïù¥ Ï§ÑÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî
        const res = await fetch('/api/downloads/stats', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch download stats');
        const stats = await res.json();
        
        animateCountUp(document.getElementById('statDownloadsTotal'), stats.total);
        animateCountUp(document.getElementById('statDownloadsHigh'), stats.highSchool);
        animateCountUp(document.getElementById('statDownloadsMiddle'), stats.middleSchool);
    } catch (e) {
        console.error("Îã§Ïö¥Î°úÎìú ÌÜµÍ≥Ñ Î°úÎî© Ïò§Î•ò:", e);
    }
  }

  async function loadUserStats() {
    try {
        // üëá [ÏàòÏ†ï] API Ìò∏Ï∂ú Ï£ºÏÜåÎ•º Í¥ÄÎ¶¨Ïûê(admin) Í≤ΩÎ°úÍ∞Ä ÏóÜÎäî ÏÉà Ï£ºÏÜåÎ°ú Î≥ÄÍ≤ΩÌï©ÎãàÎã§.
        const res = await fetch('/api/users/stats', { credentials: 'include' }); 

        // Í∏∞Ï°¥ ÏΩîÎìúÎäî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÎê©ÎãàÎã§.
        if (!res.ok) {
            console.error(`ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ Î°úÎî© Ïã§Ìå® (ÏÉÅÌÉú ÏΩîÎìú: ${res.status})`);
            // API Ìò∏Ï∂ú Ïã§Ìå® Ïãú, Ìå®ÎÑêÏùò Ïà´ÏûêÎì§ÏùÄ 0ÏúºÎ°ú Ïú†ÏßÄÎê©ÎãàÎã§.
            return;
        }
        const stats = await res.json();
        
        animateCountUp(document.getElementById('statTotalUsers'), stats.totalUsers);
        animateCountUp(document.getElementById('statSubscribedUsers'), stats.subscribedUsers);
        animateCountUp(document.getElementById('statActiveUsers'), stats.activeUsers || 0);
    } catch (e) {
        console.error("ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ Î°úÎî© Ïò§Î•ò:", e);
    }
  }
};