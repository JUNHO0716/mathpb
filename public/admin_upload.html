<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>자료 업로드(관리자)</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:700,400&display=swap" rel="stylesheet">
  <style>
    body {
      background: #fff;
      font-family: 'Noto Sans KR', Arial, sans-serif;
      margin: 0;
    }
    .upload-wrap {
   display: flex;
  justify-content: center;
  align-items: center;
  gap: 38px;
  min-height: 100vh;
  padding: 0;
  background: #fff;
    }
    .upload-card {
      background: #181818;
      color: #fff;
      border-radius: 22px;
      box-shadow: 0 4px 18px #0001;
      padding: 32px 26px 28px 26px;
      width: 370px;   /* 크기 줄임 */
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .upload-card h2 {
      text-align: left;
      margin-bottom: 20px;
      letter-spacing: -1.5px;
      font-size: 1.19rem;
      font-weight: 800;
    }
    .upload-card input,
    .upload-card select {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      background: #232323;
      color: #fff;
    }
    .upload-card input::placeholder { color: #b7b7b7; }
    .upload-card input[type="file"] { display: none; }
    /* 설명문구 폰트 아주 작게 */
    .file-desc {
      font-size: 0.6rem !important;
      color: #ffc400;
      margin: 5px 0 11px 0;
      line-height: 1.5;
      word-break: keep-all;
    }
    /* 드래그 드롭 영역 스타일 */
    .drop-zone {
      width: 100%;
      padding: 26px 0;
      margin-bottom: 17px;
      background: #252525;
      border-radius: 10px;
      color: #ffc400;
      text-align: center;
      font-weight: bold;
      border: 1.5px dashed #ffc400bb;
      transition: background 0.18s, border 0.18s;
      cursor: pointer;
      user-select: none;
      font-size: 1.03rem;
    }
    .drop-zone.dragover {
      background: #212121;
      border-color: #ffe46e;
      color: #ffe46e;
    }
    .upload-card button {
      width: 100%;
      background: #ffc400;
      color: #181818;
      border: none;
      border-radius: 8px;
      padding: 13px 0;
      font-size: 1.03rem;
      font-weight: bold;
      margin-top: 7px;
      cursor: pointer;
      box-shadow: 0 2px 7px #ffc40018;
      letter-spacing: 0.05em;
      transition: background 0.16s;
    }
    .upload-card button:active { background: #e0ad00; }
    /* 오른쪽 파일목록 카드 */
    .filelist-card {
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 4px 16px #1112;
      padding: 36px 32px 24px 32px;
      min-width: 420px;
      width: 520px;
      color: #222;
    }
    .filelist-title {
      font-size: 1.09rem;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: -0.8px;
      color: #111;
    }
    .file-list-row {
      display: flex; align-items: center; gap: 9px;
      margin-bottom: 11px; padding: 2px 0;
      font-size: 1.01rem;
      border-bottom: 1px solid #f4f4f4;
    }
    .file-icon { width: 22px; height: 22px; margin-right:6px; }
    .file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #232323;
    }
    .file-size-x {
      display: flex;
      align-items: center;
      gap: 4px;
      min-width: 70px;
    }
    .file-size {
      color: #b6b6b6;
      font-size: 0.97rem;
      white-space: nowrap;
    }
    .file-xbtn {
      color: #888;
      background: none;
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
      line-height: 1;
      padding: 0 3px;
      margin-left: 8px;
      opacity: 0.72;
      border-radius: 3px;
      transition: color 0.15s, opacity 0.14s;
    }
    .file-xbtn:hover {
      color: #ff3535;
      opacity: 1;
      background: none;
    }
    .msg { text-align:center; margin-top:16px; font-size:1rem; color:#111; }
    @media (max-width: 800px) {
      .upload-wrap { flex-direction: column; align-items: stretch; gap: 24px; }
      .upload-card, .filelist-card { width: 96vw; min-width: 0; }
      .filelist-card { padding: 26px 12px 18px 12px; }
      .upload-card { padding: 20px 5vw 15px 5vw; }
    }
  </style>
</head>
<body>
  <div class="upload-wrap">
    <!-- 왼쪽 카드(입력폼) -->
    <div class="upload-card">
      <h2>기출자료 업로드</h2>
      <form id="upload-form">
        <select name="level" id="level" required>
          <option value="">관 선택</option>
          <option value="중등">중등</option>
          <option value="고등">고등</option>
        </select>
        <select name="region" required>
          <option value="">지역 선택</option>
          <option>서울</option>
          <option>경기</option>
          <option>인천</option>
          <option>부산</option>
          <option>대구</option>
          <option>광주</option>
          <option>대전</option>
          <option>기타</option>
        </select>
        <input name="district" placeholder="구/군 (예: 강남구, 부평구 등)" required />
        <input name="school" placeholder="학교명" required />
        <select name="grade" id="grade" required>
          <option value="">학년</option>
        </select>
        <input name="year" placeholder="연도 (예: 2024)" type="number" required />
        <select name="semester" required>
          <option value="">학기</option>
          <option>1학기중간</option>
          <option>1학기기말</option>
          <option>2학기중간</option>
          <option>2학기기말</option>
        </select>
        <input name="title" placeholder="자료제목 (예: 1학기 중간고사 수학)" required />

        <div class="file-desc">
          ※ <b>한글파일(.hwp/.hwpx), PDF(.pdf) 각각 1개씩 업로드 가능</b><br>
          (둘 중 하나만 업로드해도 됩니다. 여러 파일 동시 선택 시 자동 분류)
        </div>
        <div class="drop-zone" id="drop-zone">파일 선택 또는 드래그 앤 드롭</div>
        <input name="files" id="files-input" type="file" multiple required />
        <button type="submit">자료 업로드</button>
      </form>
      <div class="msg" id="msg"></div>
    </div>
    <!-- 오른쪽 카드(파일리스트+삭제) -->
    <div class="filelist-card">
      <div class="filelist-title">업로드할 파일 목록</div>
      <div id="file-list-box"></div>
    </div>
  </div>
  <script>
    // grade 동적 생성
    const gradeSelect = document.getElementById('grade');
    const levelSelect = document.getElementById('level');
    function setGradeOptions(level) {
      let opts = ['<option value="">학년</option>'];
      if (level === '중등') {
        opts.push('<option>중1</option>','<option>중2</option>','<option>중3</option>');
      } else if (level === '고등') {
        opts.push('<option>고1</option>','<option>고2</option>','<option>고3</option>');
      }
      gradeSelect.innerHTML = opts.join('');
    }
    levelSelect.addEventListener('change', e => setGradeOptions(e.target.value));
    setGradeOptions('');

    // 파일 누적 관리 배열
    let fileArr = [];
    const input = document.getElementById('files-input');
    const fileListBox = document.getElementById('file-list-box');

    // input 파일 추가시 누적
    input.addEventListener('change', function(e) {
      const newFiles = Array.from(input.files);
      // 기존 배열에 중복없이 누적 (이름+사이즈 기준)
      for (const nf of newFiles) {
        if (!fileArr.some(f => f.name === nf.name && f.size === nf.size)) {
          fileArr.push(nf);
        }
      }
      updateInputFiles();
      renderFileList();
    });

    // 드래그앤드롭
    const dropZone = document.getElementById('drop-zone');
    dropZone.addEventListener('click', () => input.click());
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const newFiles = Array.from(e.dataTransfer.files);
      for (const nf of newFiles) {
        if (!fileArr.some(f => f.name === nf.name && f.size === nf.size)) {
          fileArr.push(nf);
        }
      }
      updateInputFiles();
      renderFileList();
    });

    // 파일리스트 그리기
    function renderFileList() {
      if (!fileArr.length) {
        fileListBox.innerHTML = '<div style="color:#bbb;">선택된 파일 없음</div>';
        return;
      }
      fileListBox.innerHTML = fileArr.map((f, i) => `
        <div class="file-list-row">
          ${getFileIcon(f.name)}
          <span class="file-name">${f.name}</span>
          <span class="file-size-x">
            <span class="file-size">${(f.size/1024).toFixed(1)}KB</span>
            <button type="button" class="file-xbtn" onclick="removeFile(${i})">✕</button>
          </span>
        </div>
      `).join('');
    }

    // 파일 확장자별 아이콘 반환
    function getFileIcon(name) {
      const ext = name.split('.').pop().toLowerCase();
      if (ext === 'hwp' || ext === 'hwpx')
        return `<img src="hwp_btn.png" class="file-icon" alt="HWP">`;
      if (ext === 'pdf')
        return `<img src="pdf_btn.png" class="file-icon" alt="PDF">`;
      if (['jpg','jpeg','png','gif','bmp'].includes(ext))
        return `<img src="img_icon.png" class="file-icon" alt="IMG">`;
      return `<img src="file_icon.png" class="file-icon" alt="FILE">`;
    }

    // 삭제 기능
    window.removeFile = function(idx) {
      fileArr.splice(idx, 1);
      updateInputFiles();
      renderFileList();
    };

    // fileArr -> input.files 동기화
    function updateInputFiles() {
      const dt = new DataTransfer();
      fileArr.forEach(f => dt.items.add(f));
      input.files = dt.files;
    }

    // 업로드 폼 전송
    document.getElementById('upload-form').onsubmit = async function(e){
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      const res = await fetch('/api/upload', {
        method: 'POST',
        body: data
      });
      const msg = document.getElementById('msg');
      if(res.ok){
        msg.textContent = '업로드 완료!';
        form.reset();
        fileArr = [];
        updateInputFiles();
        renderFileList();
      }else{
        const result = await res.json();
        msg.textContent = result.message || '업로드 실패';
      }
    };

    // 최초 진입시 파일리스트 표시
    renderFileList();
  </script>
</body>
</html>
