<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex, nofollow" />
  <title>ì‹œí—˜ì§€ ì—…ë¡œë“œ(ë©€í‹°)</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --txt:#101214;
      --sub:#6b7280;
      --line:#e9ecf1;
      --accent1:#6AD3FF;   /* í•˜ëŠ˜ */
      --accent2:#A37DFF;   /* ë³´ë¼ */
      --accent3:#FF6AD5;   /* í•‘í¬ */
      --ok:#16a34a; --err:#e11d48;
    }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,'Noto Sans KR',Segoe UI,Arial;}
    body{margin:0;background:var(--bg);color:var(--txt);}
    .wrap{
      max-width:1320px;        /* 1120 â†’ 1320, í™”ë©´ì„ ë” ê½‰ ì±„ì›€ */
      margin:16px auto 24px;   /* ìœ„ ì—¬ë°± ì¤„ì´ê³ , ì•„ë˜ë„ ì‚´ì§ ì¤„ì„ */
      padding:0 24px 32px;     /* ì¢Œìš° íŒ¨ë”© ì¡°ê¸ˆ ëŠ˜ë¦¬ê³ , ì•„ë˜ë„ ì‚´ì§ ì—¬ë°± */
    }
    .title{font-weight:900;font-size:22px;letter-spacing:-.2px;margin:6px 0 10px}
    .sub{color:var(--sub);font-size:13px;margin-bottom:18px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 8px 28px rgba(0,0,0,.06)}
    
    /* í—¤ë” ê·¸ë¼ë°ì´ì…˜ ë°”(ë‘ ë²ˆì§¸ ì´ë¯¸ì§€ ëŠë‚Œ) */
    .hero{padding:14px 18px;border-radius:18px;margin-bottom:14px;position:relative;overflow:hidden}
    .hero:before{
      content:"";position:absolute;inset:0;opacity:.55;
      background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
    }
    .hero > div{position:relative;color:#fff;font-weight:800;letter-spacing:-.3px}

    /* ë“œë¡­ì¡´(ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ëŠë‚Œ) */
    .uploader{padding:20px}
    .dropzone{
      border:2px dashed rgba(163,125,255,.55); border-radius:16px; background:#fff;
      min-height:220px; display:flex; align-items:center; justify-content:center; text-align:center; padding:22px;
      transition:.18s ease;
    }
    .dropzone.dragover{background:linear-gradient(135deg, rgba(106,211,255,.12), rgba(255,106,213,.12)); transform:translateY(-1px)}
    .dropzone input{display:none}
    .dz-title{font-size:18px;font-weight:900;margin-bottom:6px}
    .dz-sub{font-size:13px;color:var(--sub)}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;background:#111;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.12);transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.45;cursor:not-allowed}

    /* ì˜¤ë¥¸ìª½: AI ì˜ˆì¸¡ ë©”íƒ€ ë¦¬ìŠ¤íŠ¸ */
    .sec-title{font-size:14px;font-weight:900;margin:4px 0 10px}

    .row{
      display:flex;
      gap:18px;
      flex-wrap:nowrap;        /* âœ… ì¤„ë°”ê¿ˆ ì ˆëŒ€ ì•ˆ í•¨ â†’ í•­ìƒ ì˜†ì— */
      align-items:flex-start;  /* ìœ„ìª½ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ê¸° */
    }

    /* ì˜¤ë¥¸ìª½ ì¹´ë“œëŠ” wrapper(div style="flex:1 1 420px; â€¦") ì•ˆì— ìˆìœ¼ë‹ˆê¹Œ
       ì—¬ê¸°ì„œëŠ” ì„¸ë¡œ ë ˆì´ì•„ì›ƒë§Œ ë‹´ë‹¹í•˜ë„ë¡ */
    .panel{
      padding:16px;
      display:flex;
      flex-direction:column;
    }

    /* ë¦¬ìŠ¤íŠ¸ëŠ” ë‚´ìš©ì´ ì—†ì–´ë„ ì–´ëŠ ì •ë„ ë†’ì´ë¥¼ ìœ ì§€í•´ì„œ
       ì—…ë¡œë“œ ì¤‘ì—ë„ íŒ¨ë„ ì „ì²´ ìœ„ì¹˜ê°€ ëœ ì›€ì§ì´ë„ë¡ ìµœì†Œ ë†’ì´ë§Œ ì§€ì • */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:110px;      /* íŒŒì¼ ì—†ì„ ë•Œë„ ì´ ì •ë„ ë†’ì´ ìœ ì§€ */
      max-height:520px;
      overflow:auto;
    }


/* ì¹´ë“œ 1ê°œ(íŒŒì¼ 1ê°œ) */

.chip{
  font-size:11px;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#fff;
}

/* ë°°ì§€ ì•ˆì—ì„œ ì“°ëŠ” ì¸ë¼ì¸ ì…ë ¥ì°½ */
.chip-input{
  border:none;
  background:transparent;
  outline:none;
  padding:0;
  margin:0;
  width:100%;
  font-size:11px;
}

.chip.grad{
  border:0;
  background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
  color:#fff;
  font-weight:800;
}

.item{
  border:1px solid var(--line);
  border-radius:14px;
  background:#fff;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* ì¹´ë“œ 1ê°œ(íŒŒì¼ 1ê°œ) */
.item{
  border:1px solid var(--line);
  border-radius:14px;
  background:#fff;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* íŒŒì¼ëª… + ì˜¤ë¥¸ìª½ ìƒíƒœ í•œ ì¤„ */
.item-header{
  display:flex;
  align-items:center;
  justify-content:space-between; /* ì™¼ìª½ íŒŒì¼ëª… / ì˜¤ë¥¸ìª½ ìƒíƒœ ì˜ì—­ */
  gap:12px;
}

/* íŒŒì¼ íƒ€ì… ì‘ì€ ì•„ì´ì½˜(PDF / HWP) */
.file-type{
  font-size:10px;
  padding:3px 7px;
  border-radius:999px;
  font-weight:700;
  border:1px solid var(--line);
  background:#f5f5fb;
  color:#555;
  margin-right:6px;
  flex-shrink:0;
}

.file-type-pdf{
  background:#ffecef;
  border-color:#ffb5c0;
  color:#e24555;
}

.file-type-hwp{
  background:#e8f3ff;
  border-color:#a4c8ff;
  color:#1e6bd6;
}

.file-type-etc{
  background:#f1f1f5;
}

/* íŒŒì¼ëª… */
.name{
  flex:1;                       /* ë‚¨ëŠ” ê³µê°„ì€ íŒŒì¼ëª…ì´ ë¨¹ê³  */
  font-size:13px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ì •ë³´ ë°°ì§€ */
.chips{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}


/* íŒŒì¼ëª… ì˜¤ë¥¸ìª½ì— ë¶™ëŠ” ë¡œë”©ë°” + ìƒíƒœ ë¬¶ìŒ */
.item-status{
  display:flex;
  align-items:center;
  gap:8px;
  justify-content:flex-end;
  min-width:180px;          /* ë„ˆë¬´ ì¢ì•„ì§€ì§€ ì•Šê²Œ ì‚´ì§ í­ í™•ë³´ */
}

/* ë¡œë”©ë°” ê¸¸ì´ (ì›í•˜ë©´ ìˆ«ì ë” ì¤„ì—¬ë„ ë¨) */
.item-status .progress{
  flex:0 0 120px;
  max-width:120px;
}

.status{
  font-size:12px;
  white-space:nowrap;
  text-align:right;
}

.progress{
  height:8px;
  background:#f0f2f5;
  border-radius:999px;
  overflow:hidden;
}

.progress > span{
  display:block;
  height:100%;
  width:0;
  background:linear-gradient(90deg,var(--accent1),var(--accent3));
  transition:width .2s ease;
}

    .ok{color:var(--ok);font-weight:800}
    .err{color:var(--err);font-weight:800}
    .toolbar{
        display:flex;
        gap:10px;
        justify-content:flex-end;
        margin:0 0 12px 0; /* ìœ„ ì—¬ë°± ëŒ€ì‹  ì•„ë˜ìª½ ì—¬ë°± */
      }

    /* ì™¼ìª½ ê°€ì´ë“œ */
    .guide{flex:1 1 560px;padding:16px}
    .hint{font-size:12px;color:var(--sub);margin-top:6px}
    .badge{display:inline-block;font-size:12px;color:#5b5b6b;border:1px solid #ececf3;padding:6px 10px;border-radius:999px;background:#fafafd;margin-right:6px}
    @media (max-width:980px){
  .item-header{
    flex-direction:column;
    align-items:flex-start;
  }
  .status{
    text-align:left;
  }
}

    /* í•™êµ ì£¼ì†Œ í™•ì¸ íŒ¨ë„ */
    .addr-card{margin-top:16px;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:#fafbff;}
    .addr-title{font-size:13px;font-weight:800;margin-bottom:4px;}
    .addr-sub{font-size:12px;color:var(--sub);margin-bottom:8px;}
    .addr-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
    .addr-input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--line);
      padding:7px 10px;
      font-size:13px;
      outline:none;
    }
    .addr-input:focus{border-color:var(--accent2);box-shadow:0 0 0 1px rgba(163,125,255,.25);}
    .addr-btn{
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      font-weight:800;
      border:0;
      background:linear-gradient(90deg,var(--accent2),var(--accent3));
      color:#fff;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(163,125,255,.4);
    }
    .addr-btn:disabled{opacity:.5;cursor:default;box-shadow:none;}
    .addr-result{font-size:12px;max-height:160px;overflow:auto;}
    .addr-item{padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:#fff;margin-bottom:4px;}
    .addr-item-name{font-weight:700;font-size:13px;margin-bottom:2px;}
    .addr-item-meta{color:var(--sub);}
    .addr-empty{color:var(--sub);}


  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">ì‹œí—˜ì§€ ì—…ë¡œë“œ(ë©€í‹°)</div>
    <div class="sub">íŒŒì¼ëª…ì„ ê¸°ë°˜ìœ¼ë¡œ <b>ìë™ ë¶„ë¥˜</b> í›„ ì—…ë¡œë“œí•©ë‹ˆë‹¤. ì˜ˆì‹œ: <b>2025 ê²€ë‹¨ê³  1í•™ë…„ 1í•™ê¸° ì¤‘ê°„ ê³µí†µìˆ˜í•™1.hwp</b></div>

    <div class="card hero"><div>Define Â· Align Â· Achieve â€” Precision planning powered by AI</div></div>

    <div class="row">
      <!-- ì™¼ìª½: ë“œë¡­ì¡´ + ì•ˆë‚´ -->
      <section class="card uploader guide">
        <div class="dropzone" id="dropzone">
          <input id="fileInput" type="file" accept=".pdf,.hwp,.hwpx" multiple />
          <div>
            <div class="dz-title">Drag & drop to upload</div>
            <div class="dz-sub">ë˜ëŠ” <button id="browseBtn" class="btn" type="button">íŒŒì¼ ì„ íƒ</button></div>
            <div class="hint">í—ˆìš©: PDF, HWP, HWPX Â· ìµœëŒ€ 20ê°œ</div>
          </div>
        </div>
        <div style="margin-top:16px">
          <span class="badge">ìë™ ë¶„ë¥˜: ì—°ë„</span>
          <span class="badge">í•™êµ(ê³ /ì¤‘ ìë™)</span>
          <span class="badge">í•™ë…„</span>
          <span class="badge">í•™ê¸°</span>
          <span class="badge">ì¤‘ê°„/ê¸°ë§</span>
          <span class="badge">ê³¼ëª©</span>
        </div>
        <p class="hint">â€» í•™êµëª…ì€ â€˜ê²€ë‹¨ê³  â†’ ê²€ë‹¨ê³ ë“±í•™êµâ€™, â€˜â—‹â—‹ì¤‘ â†’ â—‹â—‹ì¤‘í•™êµâ€™ë¡œ ìë™ í™•ì¥ ì €ì¥ë©ë‹ˆë‹¤.</p>

        <!-- í•™êµ ì£¼ì†Œ í™•ì¸ íŒ¨ë„ (ì¶”ê°€) -->
        <div class="addr-card">
          <div class="addr-title">í•™êµ ì£¼ì†Œ í™•ì¸</div>
          <div class="addr-sub">
            NEISì—ì„œ ë™ê¸°í™”ëœ <b>schools</b> í…Œì´ë¸” ê¸°ì¤€ìœ¼ë¡œ ê´€ Â· ì§€ì—­ Â· êµ¬/êµ°ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
          </div>
          <div class="addr-row">
            <input id="addrInput" class="addr-input" placeholder="ì˜ˆ: ê²€ë‹¨ê³ , ìˆ˜ì§€ê³ ë“±í•™êµ" />
            <button id="addrBtn" type="button" class="addr-btn">ê²€ìƒ‰</button>
          </div>
          <div id="addrResult" class="addr-result">
            <div class="addr-empty">í•™êµëª…ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
          </div>
        </div>
      </section>
     
      </section>

      <!-- ì˜¤ë¥¸ìª½: AI ì˜ˆì¸¡ ëª©ë¡ + ì—…ë¡œë“œ -->
      <div style="flex:1 1 420px; display:flex; flex-direction:column;">
        <!-- íŒ¨ë„ ë°–, ë°”ë¡œ ìœ„ì— ë‚˜ì˜¤ëŠ” ë²„íŠ¼ ì˜ì—­ -->
        <div class="toolbar">
          <button id="clearBtn" class="btn" type="button">ëª©ë¡ ë¹„ìš°ê¸°</button>
          <button id="uploadBtn" class="btn" type="button" disabled>íŒŒì¼ ì—…ë¡œë“œ</button>
        </div>

        <section class="card panel">
          <div class="sec-title">AI ì˜ˆì¸¡ ë©”íƒ€ë°ì´í„°</div>
          <div id="list" class="list"></div>

          <p class="hint">ì—…ë¡œë“œëŠ” `/api/user-upload`ë¡œ AJAX ì „ì†¡ë˜ë©°, ê° í•­ëª©ì— `meta_json`(JSON)ë„ í•¨ê»˜ ì „ì†¡ë©ë‹ˆë‹¤.</p>
        </section>
      </div>
  </div>

<script>
(() => {
  const UPLOAD_URL = '/api/admin/exam-upload';        // í•„ìš” ì‹œ êµì²´
  const MAX_FILES  = 20;
  const listEl     = document.getElementById('list');
  const dropzone   = document.getElementById('dropzone');
  const fi         = document.getElementById('fileInput');
  const browseBtn  = document.getElementById('browseBtn');
  const uploadBtn  = document.getElementById('uploadBtn');
  const clearBtn   = document.getElementById('clearBtn');
  const addrInput  = document.getElementById('addrInput');
  const addrBtn    = document.getElementById('addrBtn');
  const addrResult = document.getElementById('addrResult');

  /** ìƒíƒœ: {file, meta, node, bar, status, done, ok}[] */
  const queue = [];

  browseBtn.addEventListener('click', () => fi.click());
  fi.addEventListener('change', () => addFiles(fi.files));

  // Drag & Drop
  ['dragenter','dragover'].forEach(evn => dropzone.addEventListener(evn, e => {
    e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
  }));
  ['dragleave','drop'].forEach(evn => dropzone.addEventListener(evn, e => {
    e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');
  }));
  dropzone.addEventListener('drop', e => addFiles(e.dataTransfer.files));

  clearBtn.addEventListener('click', async () => {
    const ok = await showConfirm('ì •ë§ ëª©ë¡ì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!ok) return;

    queue.splice(0, queue.length);
    listEl.innerHTML = '';
    uploadBtn.disabled = true;
  });


  function addFiles(fileList){
    const incoming = Array.from(fileList || []);
    const accept = incoming.filter(f => /\.(pdf|hwp|hwpx)$/i.test(f.name));
    if (!accept.length) { alert('PDF, HWP, HWPX íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }

    const remain = MAX_FILES - queue.length;
    if (accept.length > remain) {
      alert(`ìµœëŒ€ ${MAX_FILES}ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í˜„ì¬ ${queue.length}ê°œ)`);
      accept.splice(remain);
    }

    accept.forEach(file => {
      const meta = guessFromName(file.name);
      const row  = renderItem(file, meta);
      listEl.appendChild(row.node);

      const entry = {
        file, meta,
        node: row.node,
        bar: row.bar,
        status: row.status,
        done:false, ok:false
      };
      queue.push(entry);

      // ğŸ” íŒŒì¼ëª…ì—ì„œ ì¶”ì¶œí•œ í•™êµëª…ìœ¼ë¡œ ì§€ì—­/êµ¬êµ° ìë™ ì¡°íšŒ
      autoFillRegionDistrict(entry);
    });

    uploadBtn.disabled = queue.length === 0;
  }


// íŒŒì¼ íƒ€ì… ë°°ì§€ HTML ìƒì„± (PDF / HWP / ê¸°íƒ€)
function fileTypeBadge(name){
  const ext = (name.split('.').pop() || '').toLowerCase();
  if (ext === 'pdf') {
    return '<span class="file-type file-type-pdf">PDF</span>';
  }
  if (ext === 'hwp' || ext === 'hwpx') {
    return '<span class="file-type file-type-hwp">hwp</span>';
  }
  return '<span class="file-type file-type-etc">FILE</span>';
}

function renderItem(file, meta){
  const node = document.createElement('div');
  node.className = 'item';

  const typeTag = fileTypeBadge(file.name);

  node.innerHTML = `
    <div class="item-header">
      ${typeTag}
      <div class="name" title="${file.name}">${file.name}</div>
      <div class="item-status">
        <div class="progress"><span></span></div>
        <div class="status">ëŒ€ê¸°</div>
      </div>
    </div>
    <div class="chips">
      ${chipsHTML(meta)}
    </div>
  `;
  return {
    node,
    bar: node.querySelector('.progress > span'),
    status: node.querySelector('.status')
  };
}


  // label: ë³´ì´ëŠ” ì´ë¦„(ì—°ë„, í•™êµ ...)
  // value: ì‹¤ì œ ê°’
  // key  : metaì—ì„œ ì–´ë–¤ í•„ë“œì¸ì§€(year, school, exam ...)
  function chip(label, value, grad=false, key){
    if (!value) return '';
    const cls = `chip ${grad ? 'grad' : ''}`;
    const dataKey = key ? ` data-key="${key}" data-label="${label}"` : '';
    return `<span class="${cls}"${dataKey}>${label}: ${value}</span>`;
  }

  // ì¹© ë¬¶ìŒ ìƒì„±(ì§€ì—­/êµ¬êµ° í¬í•¨)
  function chipsHTML(meta){
    return [
      chip('ì—°ë„',  meta.year,                    false, 'year'),
      chip('í•™êµ',  meta.school,                  false, 'school'),
      chip('êµ¬ë¶„',  meta.level,                   true,  'level'),
      chip('í•™ë…„',  meta.grade ? meta.grade+'í•™ë…„'     : '', false, 'grade'),
      chip('í•™ê¸°',  meta.semester ? meta.semester+'í•™ê¸°' : '', false, 'semester'),
      chip('ì‹œí—˜',  meta.exam_type_kr || meta.exam_type, false, 'exam'),
      chip('ê³¼ëª©',  meta.subject,                 false, 'subject'),
      chip('ì§€ì—­',  meta.region,                  false, 'region'),
      chip('êµ¬/êµ°', meta.district,                false, 'district')
    ].join('');
  }

    // ==== ì¹© ì¸ë¼ì¸ í¸ì§‘ ê¸°ëŠ¥ ====
  listEl.addEventListener('click', (e) => {
    const chipEl = e.target.closest('.chip');
    if (!chipEl) return;
    // ì´ë¯¸ ì…ë ¥ ëª¨ë“œë©´ ë¬´ì‹œ
    if (chipEl.querySelector('.chip-input')) return;

    const key   = chipEl.getAttribute('data-key');
    const label = chipEl.getAttribute('data-label') || '';
    if (!key) return;

    const itemEl = chipEl.closest('.item');
    if (!itemEl) return;
    const entry = queue.find(q => q.node === itemEl);

    // âœ… ì—…ë¡œë“œê°€ í•œ ë²ˆì´ë¼ë„ ëë‚œ ì¹´ë“œ(done === true)ëŠ” ìˆ˜ì • ì ê¸ˆ
    if (!entry || entry.done) return;

    // "ì—°ë„: 2024" â†’ "2024" ë¶€ë¶„ë§Œ ì¶”ì¶œ
    const fullText = chipEl.textContent || '';
    let valuePart = fullText;
    if (label && fullText.startsWith(label)) {
      valuePart = fullText.slice(label.length).replace(/^:\s*/, '');
    }

    const originalValue = valuePart;

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'chip-input';
    input.value = valuePart;

    chipEl.innerHTML = '';
    chipEl.appendChild(input);
    input.focus();
    input.select();

    const finish = (commit) => {
      input.removeEventListener('blur', onBlur);
      input.removeEventListener('keydown', onKeydown);

      const newRaw = commit ? input.value.trim() : originalValue;

      // meta ê°±ì‹ 
      applyChipValue(entry, key, label, newRaw);

      // ì¹© ì „ì²´ ë‹¤ì‹œ ë Œë” (ë””ìì¸ ë³µì›)
      const chipsBox = itemEl.querySelector('.chips');
      if (chipsBox){
        chipsBox.innerHTML = chipsHTML(entry.meta);
      }
    };

    const onBlur = () => finish(true);
    const onKeydown = (ev) => {
      if (ev.key === 'Enter'){
        ev.preventDefault();
        finish(true);
      } else if (ev.key === 'Escape'){
        ev.preventDefault();
        finish(false);
      }
    };

    input.addEventListener('blur', onBlur);
    input.addEventListener('keydown', onKeydown);
  });

  // ì¹© ë³€ê²½ â†’ metaì— ë°˜ì˜
  function applyChipValue(entry, key, label, raw){
    const v = raw.trim();

    switch(key){
      case 'year': {
        const num = v.match(/\d{4}/);
        entry.meta.year = num ? num[0] : v;
        break;
      }
      case 'school':
        entry.meta.school = v;
        break;
      case 'level':
        entry.meta.level = v; // ê³ ë“± / ì¤‘ë“± ë“±
        break;
      case 'grade': {
        const num = v.match(/\d+/);
        entry.meta.grade = num ? num[0] : '';
        break;
      }
      case 'semester': {
        const num = v.match(/\d+/);
        entry.meta.semester = num ? num[0] : '';
        break;
      }
      case 'exam': {
        entry.meta.exam_type_kr = v;
        if (/ê¸°ë§/.test(v) || /final/i.test(v)) entry.meta.exam_type = 'final';
        else if (/ì¤‘ê°„/.test(v) || /mid/i.test(v)) entry.meta.exam_type = 'mid';
        else entry.meta.exam_type = '';
        break;
      }
      case 'subject':
        entry.meta.subject = v;
        break;
      case 'region':
        entry.meta.region = v;
        break;
      case 'district':
        entry.meta.district = v;
        break;
    }
  }


  // ===== ì—…ë¡œë“œ ì²˜ë¦¬ (ìˆœì°¨ ì „ì†¡) =====
  uploadBtn.addEventListener('click', async ()=>{
    const ok = await showConfirm('íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!ok) return;

    uploadBtn.disabled = true;
    for (const it of queue){
      if (it.done) continue;
      await uploadOne(it).catch(()=>{});
    }
    // ëª¨ë‘ ëë‚˜ë©´ ì‹¤íŒ¨ë§Œ ë‚¨ì•˜ì„ ìˆ˜ ìˆì–´ ë‹¤ì‹œ í™œì„±í™”
    if (queue.some(x => !x.done || !x.ok)) uploadBtn.disabled = false;
  });


  function uploadOne(it){
    return new Promise((resolve) => {
      const fd = new FormData();
      fd.append('file', it.file);

      // ì¹©ì—ì„œ ìˆ˜ì •ëœ ìµœì‹  meta ê¸°ì¤€ìœ¼ë¡œ meta_json êµ¬ì„±
      const metaForSend = {
        year:      it.meta.year,
        school:    it.meta.school,
        level:     it.meta.level,
        grade:     it.meta.grade,
        semester:  it.meta.semester,
        exam_type: it.meta.exam_type_kr || it.meta.exam_type, // 'ì¤‘ê°„' | 'ê¸°ë§'
        exam_code: it.meta.exam_type,                         // 'mid' | 'final'
        subject:   it.meta.subject,
        region:    it.meta.region || '',
        district:  it.meta.district || ''
      };

      // ì œëª©ì€ ê°’ë“¤ì´ ë‹¤ ìˆìœ¼ë©´ ì¡°í•©, ì•„ë‹ˆë©´ íŒŒì¼ëª…(í™•ì¥ì ì œê±°) ì‚¬ìš©
      metaForSend.title = makeTitle(metaForSend, stripExt(it.file.name));

      fd.append('meta_json', JSON.stringify(metaForSend));

      function makeTitle(meta, fallback){
        const year   = meta.year;
        const school = meta.school;
        const grade  = meta.grade;
        const sem    = meta.semester;
        const examKr = meta.exam_type ||
                      (meta.exam_code === 'mid'   ? 'ì¤‘ê°„' :
                        meta.exam_code === 'final' ? 'ê¸°ë§' : '');
        const subject = meta.subject;

        if (year && school && grade && sem && examKr && subject){
          return `${year} ${school} ${grade}í•™ë…„ ${sem}í•™ê¸° ${examKr} ${subject}`;
        }
        return fallback || '';
      }

      it.status.textContent = 'ì—…ë¡œë“œ 0%';
      xhrWithProgress(UPLOAD_URL, fd, (pct)=>{
        it.bar.style.width = pct + '%';
        it.status.textContent = `ì—…ë¡œë“œ ${pct}%`;
      }, (ok, text)=>{
        it.done = true;
        it.ok   = ok;

        if (ok){
          it.bar.style.width = '100%';
          it.status.innerHTML = `<span class="ok">ì™„ë£Œ</span>`;
        } else {
          let msg = 'ì‹¤íŒ¨';

          if (text && text.includes('DUP_HWP')) {
            msg = 'ì‹¤íŒ¨ (HWP ì¤‘ë³µ)';
          } else if (text && text.includes('DUP_PDF')) {
            msg = 'ì‹¤íŒ¨ (PDF ì¤‘ë³µ)';
          } else if (text && text.includes('DUP_META')) {
            msg = 'ì‹¤íŒ¨ (ë©”íƒ€ ì¤‘ë³µ)';
          }

          it.status.innerHTML = `<span class="err">${msg}</span>`;
          if (text && !/DUP_/.test(text)) {
            console.warn('ì—…ë¡œë“œ ì‹¤íŒ¨:', text);
          }
        }
        resolve();
      });
    });
  }

  function xhrWithProgress(url, body, onProgress, done){
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.withCredentials = true;
    xhr.upload.onprogress = (e)=>{
      if (!e.lengthComputable) return;
      const pct = Math.round((e.loaded/e.total)*100);
      onProgress && onProgress(pct);
    };
    xhr.onload = ()=> done(xhr.status >= 200 && xhr.status < 300, xhr.responseText || '');
    xhr.onerror = ()=> done(false, 'network error');
    xhr.send(body);
  }

  // ===== íŒŒì¼ëª… â†’ ë©”íƒ€ íŒŒì„œ =====
  function guessFromName(filename){
    const base = stripExt(filename).replace(/\s+/g,' ').trim();

    // ì—°ë„
    const year = (base.match(/\b(20\d{2})\b/)||[])[1] || '';

    // í•™êµ
    let schoolRaw = '';
    // â€œâ€¦ê³ /ê³ ë“±í•™êµ/ì—¬ê³ /â€¦ì¤‘/ì¤‘í•™êµâ€ íŒ¨í„´ ìš°ì„ 
    // âš  JSì˜ \bëŠ” í•œê¸€ì—ì„œ ì˜ ì•ˆ ë¨¹ìœ¼ë‹ˆê¹Œ, ê³µë°±/ë¬¸ìì—´ ë ê¸°ì¤€ìœ¼ë¡œ ì§ì ‘ ê²½ê³„ ì²´í¬
    let m = base.match(/([ê°€-í£A-Za-z0-9]+?)(ì—¬ìê³ ë“±í•™êµ|ê³ ë“±í•™êµ|ì—¬ìì¤‘í•™êµ|ì¤‘í•™êµ|ì—¬ê³ |ì—¬ì¤‘|ê³ |ì¤‘)(?=\s|$)/);
    if (m) schoolRaw = m[0];
    // í™•ì¥: 'ê²€ë‹¨ê³ ' â†’ 'ê²€ë‹¨ê³ ë“±í•™êµ', 'â—‹â—‹ì¤‘' â†’ 'â—‹â—‹ì¤‘í•™êµ'
    const school = expandSchoolName(schoolRaw);

    // ë ˆë²¨
    let level = '';
    if (/ê³ ë“±í•™êµ|ì—¬ê³ |ê³ \b/.test(school) || /ê³ ë“±|ì—¬ê³ |ê³ \b/.test(base)) level = 'ê³ ë“±';
    else if (/ì¤‘í•™êµ|ì¤‘\b/.test(school) || /ì¤‘í•™|ì¤‘\b/.test(base)) level = 'ì¤‘ë“±';

    // í•™ë…„/í•™ê¸°
    const grade    = (base.match(/([1-3])\s*í•™ë…„/)||[])[1] || '';
    const semester = (base.match(/([12])\s*í•™ê¸°/)||[])[1] || '';

    // ì‹œí—˜ êµ¬ë¶„
    let exam_type = '';        // mid | final
    let exam_type_kr = '';     // ì¤‘ê°„ | ê¸°ë§
    if (/ì¤‘ê°„/.test(base)) { exam_type='mid';   exam_type_kr='ì¤‘ê°„'; }
    else if (/ê¸°ë§/.test(base)) { exam_type='final'; exam_type_kr='ê¸°ë§'; }

    // ê³¼ëª© (ë³„ì¹­ í¬í•¨)
    const map = [
      [/ê³µí†µ\s*ìˆ˜í•™\s*1|ê³µí†µìˆ˜í•™\s*1/i, 'ê³µí†µìˆ˜í•™1'],
      [/ê³µí†µ\s*ìˆ˜í•™\s*2|ê³µí†µìˆ˜í•™\s*2/i, 'ê³µí†µìˆ˜í•™2'],
      [/ìˆ˜í•™ìƒ/i, 'ìˆ˜í•™ìƒ'],
      [/ìˆ˜í•™í•˜/i, 'ìˆ˜í•™í•˜'],
      [/\bìˆ˜í•™\s*1\b|ìˆ˜í•™1/i, 'ìˆ˜í•™1'],
      [/\bìˆ˜í•™\s*2\b|ìˆ˜í•™2/i, 'ìˆ˜í•™2'],
      [/ë¯¸ì ë¶„|ë¯¸ì \b/i, 'ë¯¸ì ë¶„'],
      [/ê¸°í•˜/i, 'ê¸°í•˜'],
      [/í™•ë¥ ê³¼í†µê³„|í™•í†µ/i, 'í™•ë¥ ê³¼í†µê³„']
    ];
    let subject = '';
    for (const [re, name] of map){ if (re.test(base)) { subject = name; break; } }

    // ì œëª©
    let title = base;
    if (year && school && grade && semester && exam_type_kr && subject){
      title = `${year} ${school} ${grade}í•™ë…„ ${semester}í•™ê¸° ${exam_type_kr} ${subject}`;
    }

    // region / district ëŠ” ë‚˜ì¤‘ì— ìë™ ì¡°íšŒë¡œ ì±„ì›€
    return {
      year, school, level, grade, semester,
      exam_type, exam_type_kr, subject, title,
      region: '', district: ''
    };
  }

  // ğŸ” school-lookup APIë¡œ region/district ìë™ ì±„ìš°ê¸°
  async function autoFillRegionDistrict(entry){
    try{
      if (!entry || !entry.meta) return;
      const school = (entry.meta.school || '').trim();
      if (!school) return;

      const res = await fetch(`/api/admin/school-lookup?q=${encodeURIComponent(school)}`, {
        credentials: 'include',
        cache: 'no-store'
      });
      if (!res.ok) return;
      const data = await res.json();
      const list = Array.isArray(data.items) ? data.items :
                   (Array.isArray(data) ? data : []);
      if (!list.length) return;

      const best = list[0];
      entry.meta.region   = best.region   || '';
      entry.meta.district = best.district || '';

      const chipsBox = entry.node && entry.node.querySelector('.chips');
      if (chipsBox){
        chipsBox.innerHTML = chipsHTML(entry.meta);
      }
    } catch (e){
      console.error('autoFillRegionDistrict error', e);
    }
  }

  function expandSchoolName(s){
    if (!s) return '';
    let t = s.replace(/\s+/g,'');
    // ì´ë¯¸ 'ê³ ë“±í•™êµ/ì¤‘í•™êµ'ë¡œ ëë‚˜ë©´ ê·¸ëŒ€ë¡œ
    if (/ê³ ë“±í•™êµ$/.test(t) || /ì¤‘í•™êµ$/.test(t)) return t;
    // ì—¬ê³ /ì—¬ì¤‘ ì¶•ì•½ë„ í™•ì¥
    if (/ì—¬ê³ $/.test(t)) return t.replace(/ì—¬ê³ $/, 'ì—¬ìê³ ë“±í•™êµ');
    if (/ì—¬ì¤‘$/.test(t)) return t.replace(/ì—¬ì¤‘$/, 'ì—¬ìì¤‘í•™êµ');
    if (/ê³ $/.test(t))   return t.replace(/ê³ $/, 'ê³ ë“±í•™êµ');
    if (/ì¤‘$/.test(t))   return t.replace(/ì¤‘$/, 'ì¤‘í•™êµ');
    return t;
  }

  function stripExt(name){ return name.replace(/\.[^.]+$/,''); }

// ===== í•™êµ ì£¼ì†Œ ê²€ìƒ‰ ê¸°ëŠ¥ (ì¶”ê°€) =====
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    }[c]));
  }

  async function searchSchoolAddr(){
    if (!addrInput || !addrBtn || !addrResult) return;

    const q = (addrInput.value || '').trim();
    if (!q){
      addrResult.innerHTML = '<div class="addr-empty">í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</div>';
      return;
    }

    addrBtn.disabled = true;
    const oldText = addrBtn.textContent;
    addrBtn.textContent = 'ê²€ìƒ‰ì¤‘...';

    try{
      const res = await fetch(`/api/admin/school-lookup?q=${encodeURIComponent(q)}`, {
        credentials: 'include',
        cache: 'no-store'
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const list = Array.isArray(data.items) ? data.items :
                   (Array.isArray(data) ? data : []);

      if (!list.length){
        addrResult.innerHTML = '<div class="addr-empty">ì¼ì¹˜í•˜ëŠ” í•™êµê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      addrResult.innerHTML = list.map(s => `
        <div class="addr-item">
          <div class="addr-item-name">${escapeHtml(s.name || '')}</div>
          <div class="addr-item-meta">
            ê´€: ${escapeHtml(s.level || '-')} Â·
            ì§€ì—­: ${escapeHtml(s.region || '-')} Â·
            êµ¬/êµ°: ${escapeHtml(s.district || '-')}
          </div>
        </div>
      `).join('');
    } catch (e){
      console.error('school lookup fail', e);
      addrResult.innerHTML = '<div class="addr-empty">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    } finally {
      addrBtn.disabled = false;
      addrBtn.textContent = oldText;
    }
  }

  // ë²„íŠ¼/ì—”í„° í‚¤ ì´ë²¤íŠ¸ ì—°ê²°
  if (addrBtn){
    addrBtn.addEventListener('click', searchSchoolAddr);
  }
  if (addrInput){
    addrInput.addEventListener('keydown', e => {
      if (e.key === 'Enter'){
        e.preventDefault();
        searchSchoolAddr();
      }
    });
  }

  // ===== ëª¨ë‹¬ Confirm ê¸°ëŠ¥ =====
  function showConfirm(message) {
    return new Promise(resolve => {
      const modal = document.getElementById('confirmModal');
      const text  = document.getElementById('confirmText');
      const yes   = document.getElementById('confirmYes');
      const no    = document.getElementById('confirmNo');

      // í˜¹ì‹œ ëª¨ë‹¬ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ confirm ì‚¬ìš©
      if (!modal || !text || !yes || !no) {
        const ok = window.confirm(message);
        return resolve(ok);
      }

      text.textContent = message;
      modal.style.display = 'flex';

      const close = (result) => {
        modal.style.display = 'none';
        yes.removeEventListener('click', onYes);
        no.removeEventListener('click', onNo);
        resolve(result);
      };

      const onYes = () => close(true);
      const onNo  = () => close(false);

      yes.addEventListener('click', onYes);
      no.addEventListener('click', onNo);
    });
  }
  
})();

</script>

<!-- í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmModal" style="
  position:fixed; inset:0; background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center; z-index:9999;
">
  <div style="
    background:white; padding:24px; border-radius:16px; width:300px;
    box-shadow:0 8px 28px rgba(0,0,0,.3); text-align:center;
  ">
    <div id="confirmText" style="font-size:15px; margin-bottom:18px; font-weight:700;"></div>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button id="confirmNo" class="btn" style="background:#9ca3af;">ì·¨ì†Œ</button>
      <button id="confirmYes" class="btn">í™•ì¸</button>
    </div>
  </div>
</div>

</body>
</html>

